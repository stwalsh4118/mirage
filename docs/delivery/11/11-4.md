# [11-4] Extend service provisioning API to support image-based deployments

[Back to task list](./tasks.md)

## Description
Extend the existing `POST /api/provision/services` endpoint to accept Docker image configuration alongside the existing repository-based deployment options, with proper validation to ensure either repo OR image fields are provided.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-09-30 14:30:00 | Created | N/A | Proposed | Task file created | ai-agent |
| 2025-09-30 18:00:00 | Updated | Proposed | Proposed | Simplified approach to extend existing endpoint instead of creating new route | sean |
| 2025-09-30 18:01:00 | Status Change | Proposed | Agreed | Task approved with simplified approach | sean |
| 2025-09-30 18:02:00 | Status Change | Agreed | InProgress | Starting implementation of extended API endpoint | ai-agent |
| 2025-09-30 18:30:00 | Status Change | InProgress | Review | Extended endpoint with validation, tests pass, backward compatible | ai-agent |
| 2025-09-30 18:45:00 | Status Change | Review | Done | Task completed and approved by user | sean |

## Requirements
- Extend existing `POST /api/provision/services` endpoint
- Add optional fields to service spec in request body:
  - `imageRegistry`: registry URL (optional, defaults to Docker Hub)
  - `imageName`: image name (e.g., "nginx" or "org/image")
  - `imageTag`: tag or digest (optional, defaults to "latest")
  - `ports`: array of port numbers (optional)
  - `environmentVariables`: key-value map (optional)
- Validate that each service provides either:
  - Repo-based: `repo` and `branch` fields
  - Image-based: `imageName` field (at minimum)
  - Return 400 error if both or neither are provided
- Pass image configuration to Railway client's existing `CreateService` method
- Maintain backward compatibility with existing repo-based requests
- Follow existing API patterns and error response format

## Implementation Plan
1. Extend `ProvisionServicesRequest` struct in `api/internal/controller/services.go`
2. Add optional image fields to the service spec within the struct
3. Add validation logic to ensure either repo OR image fields are present per service
4. Update handler to pass new fields to `railway.CreateServiceInput`
5. Add clear error messages for validation failures
6. Test with both repo-based and image-based requests

## Test Plan
### Basic Implementation Scope
- Endpoint validates required fields (projectId, environmentId, services)
- Endpoint validates that each service has either repo OR image fields (not both, not neither)
- Invalid configuration (both repo and image) returns 400 with clear error message
- Invalid configuration (neither repo nor image) returns 400 with clear error message
- Valid repo-based request continues to work (backward compatibility)
- Valid image-based request creates service in Railway
- Response includes created service IDs for both types
- Error responses follow existing format and are actionable

## Verification
- Existing repo-based provisioning requests still work unchanged
- Image-based provisioning requests work correctly
- Validation errors are clear and actionable
- Services created via API appear in Railway with correct configuration
- Error responses follow existing format

## Files Modified
- `api/internal/controller/services.go` (extend request struct and add validation)

