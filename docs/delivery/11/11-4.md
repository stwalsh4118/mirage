# [11-4] Create API endpoints for image-based service provisioning

[Back to task list](./tasks.md)

## Description
Create REST API endpoints that allow frontend to provision services from Docker images, with proper validation, error handling, and response formatting.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-09-30 14:30:00 | Created | N/A | Proposed | Task file created | ai-agent |

## Requirements
- Create `POST /api/provision/services/from-image` endpoint
- Accept request body with:
  - `projectId`: Railway project ID
  - `environmentId`: Railway environment ID
  - `services`: array of image service specs
    - `name`: service name
    - `imageRegistry`: registry URL
    - `imageName`: image name
    - `imageTag`: tag or digest
    - `ports`: array of port numbers
    - `environmentVariables`: key-value map (optional)
  - `requestId`: for idempotency
- Validate image reference format before calling Railway
- Store service metadata in database with deployment type
- Return created service IDs
- Extend existing `POST /api/provision/services` to support both types
- Follow existing API patterns and error response format

## Implementation Plan
1. Add new route handler in `api/internal/controller/services.go`
2. Define request/response structs with validation tags
3. Implement image reference format validation
4. Call Railway client's image-based service creation
5. Store service record in database with deployment type and image config
6. Return service IDs on success
7. Handle Railway API errors and map to user-friendly messages
8. Add request ID handling for idempotency
9. Consider extending existing endpoint vs creating new one

## Test Plan
### Basic Implementation Scope
- Endpoint validates required fields (projectId, environmentId, services)
- Endpoint validates image reference format
- Invalid image format returns 400 with clear error message
- Valid request creates service in Railway
- Service record saved in database with correct deployment type
- Response includes created service ID
- Idempotency works (duplicate requestId returns same result)

## Verification
- API endpoint is accessible at documented path
- Request validation works for all required fields
- Services created via API appear in Railway
- Database records have correct deployment type and image metadata
- Error responses follow existing format and are actionable
- API tests pass

## Files Modified
- `api/internal/controller/services.go` (endpoint handlers)
- `api/internal/server/server.go` (route registration if new endpoint)

