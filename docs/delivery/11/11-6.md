# [11-6] Implement Docker image configuration form

[Back to task list](./tasks.md)

## Description
Build the UI form for configuring Docker image-based service deployments, including registry selection, image reference input, tag/digest selection, port configuration, and environment variables.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-09-30 14:30:00 | Created | N/A | Proposed | Task file created | ai-agent |
| 2025-10-01 00:00:00 | Status Change | Proposed | Agreed | Task approved to implement Docker image form | sean |
| 2025-10-01 00:01:00 | Status Change | Agreed | InProgress | Starting implementation of Docker image configuration form | ai-agent |
| 2025-10-01 00:30:00 | Status Change | InProgress | Review | Implemented full Docker image configuration form with all required features | ai-agent |
| 2025-10-01 00:45:00 | Status Change | Review | Done | Task approved and completed successfully | sean |

## Requirements
- **Registry Selection**:
  - Dropdown with common registries: Docker Hub, GHCR, Custom
  - Auto-populate registry URL based on selection
  - Allow custom registry URL input
- **Image Reference Input**:
  - Text input for image name (e.g., `nginx`, `owner/repo`)
  - Format validation and helper text with examples
  - Auto-format based on registry (docker.io/nginx vs ghcr.io/owner/image)
- **Tag/Digest Selector**:
  - Input for tag (default: `latest`)
  - Toggle to use digest instead of tag
  - Validation for tag/digest format
- **Port Configuration**:
  - Array input for exposed ports
  - Add/remove port entries
  - Validation for valid port numbers (1-65535)
  - Default common ports based on image name (80 for nginx, etc.)
- **Environment Variables**:
  - Key-value pair editor (reuse existing component)
  - Add/remove rows
- **Validation**:
  - Required fields: registry, image name, tag
  - Format validation for image references
  - Validation for port numbers
- **UX Polish**:
  - Auto-format image reference as user types
  - Show full image reference preview
  - Helpful tooltips and examples
  - Clear error messages

## Implementation Plan
1. Create `DockerImageForm` component
2. Add registry selection dropdown with common options
3. Implement image name input with format validation
4. Add tag/digest input with toggle
5. Create port configuration array input
6. Integrate environment variable editor
7. Implement real-time image reference preview
8. Add format validation with regex
9. Show helpful error messages for invalid inputs
10. Add example text and tooltips
11. Style to match existing wizard aesthetics
12. Test validation and error states
13. Test with various image references

## Test Plan
### Basic Implementation Scope
- Form displays all required fields
- Registry dropdown includes Docker Hub, GHCR, Custom
- Image name validation catches invalid formats
- Tag input defaults to "latest"
- Port array allows add/remove entries
- Port validation catches invalid numbers
- Environment variable editor works correctly
- Full image reference preview is accurate
- Validation errors display clearly
- Form integrates with wizard state management

## Verification
- All form fields render correctly
- Validation works for all input types
- Invalid inputs show clear error messages
- Image reference preview updates in real-time
- Form state integrates with wizard store
- Design matches existing wizard components
- Component is responsive on mobile
- No console errors or warnings

## Files Modified
- `web/src/components/wizard/DockerImageForm.tsx` (new component) ✅
- `web/src/components/wizard/steps/StepSource.tsx` (integrated DockerImageForm) ✅
- `web/src/components/wizard/steps/StepReview.tsx` (display image config in review) ✅
- `web/src/components/wizard/WizardFooter.tsx` (validation for image fields) ✅
- `web/src/components/wizard/CreateEnvironmentDialog.tsx` (pass ports to API) ✅
- `web/src/store/wizard.ts` (added image config fields: imageDigest, useDigest, imagePorts) ✅

## Implementation Summary

### Created Components
1. **DockerImageForm.tsx**: Comprehensive form component with:
   - Registry selection dropdown (Docker Hub, GHCR, Custom)
   - Image name input with format examples and validation
   - Tag/digest toggle with SHA-256 digest validation
   - Dynamic port configuration with add/remove functionality
   - Intelligent port suggestions based on image name (nginx→80,443, postgres→5432, etc.)
   - Real-time full image reference preview
   - Comprehensive validation with clear error messages
   - Follows existing wizard styling patterns (glass effects, proper spacing, responsive design)

### Updated Components
1. **StepSource.tsx**: Now conditionally renders `DockerImageForm` for image-based deployments
2. **StepReview.tsx**: Displays full image reference and exposed ports in the review step
3. **WizardFooter.tsx**: Enhanced validation to check image name, tag/digest format
4. **CreateEnvironmentDialog.tsx**: Passes `imagePorts` array to the backend API during provisioning

### State Management
Extended `wizard.ts` store with:
- `imageDigest`: string - for SHA-256 digest-based deployments
- `useDigest`: boolean - toggle between tag and digest
- `imagePorts`: number[] - array of exposed port numbers

### Features Implemented
✅ Registry selection with common presets
✅ Custom registry URL support
✅ Image name validation and formatting
✅ Tag/digest toggle with format validation
✅ Port array with intelligent suggestions
✅ Port validation (1-65535 range)
✅ Real-time image reference preview
✅ Integration with wizard state management
✅ Responsive design matching existing wizard aesthetics
✅ Clear error messages and helper text
✅ Environment variables handled by existing StepConfig component

### Testing Notes
- Build passes with no TypeScript errors or linter warnings
- All validation logic properly integrated with wizard navigation
- Form state properly persists across wizard steps
- Image reference preview updates in real-time as user types

