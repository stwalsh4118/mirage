# [17-29] Write integration tests for secret management

[Back to task list](./tasks.md)

## Description

Write integration tests that use a real Vault instance (via Docker) to test complete secret management workflows, Railway client integration, and controller operations.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-09 00:00:00 | Created | N/A | Proposed | Task file created | AI Agent |

## Requirements

1. Use Docker to run Vault in dev mode for tests
2. Test complete secret lifecycle for all types
3. Test Railway client integration with per-user tokens
4. Test controller endpoints with authentication
5. Test caching behavior with real Vault
6. Test circuit breaker with Vault unavailability
7. Test version management with real versioned secrets
8. Verify secret isolation between users

## Implementation Plan

1. Create `api/test/integration/vault_test.go`
2. Setup Vault container in test setup
3. Test complete workflows:
   - Store Railway token → Get token → Use in Railway client
   - Store GitHub token → Validate → Delete
   - Store Docker creds → List registries → Delete
   - Environment secrets bulk operations
   - Generic secret versioning and rollback
4. Test controller endpoints
5. Test failure scenarios
6. Cleanup after tests

## Test Plan

**Test Scenarios:**
1. Complete Railway token workflow
2. Multiple users with separate tokens
3. Token rotation
4. GitHub token with validation
5. Docker credentials for multiple registries
6. Environment secrets bulk import
7. Generic secret versioning
8. Rollback functionality
9. Cache behavior
10. Circuit breaker with Vault down

**Success Criteria**:
- All integration tests pass
- Secret isolation verified
- Railway integration works
- Version management works
- Cleanup successful

## Verification

- [ ] Integration test file created
- [ ] Vault container setup
- [ ] All workflows tested
- [ ] Railway integration tested
- [ ] Secret isolation verified
- [ ] Tests pass
- [ ] Cleanup works

## Files Modified

- `api/test/integration/vault_test.go` (new)
- `api/test/integration/secrets_api_test.go` (new)

