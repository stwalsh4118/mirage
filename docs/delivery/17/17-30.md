# [17-30] E2E CoS Test: Complete Vault secret management flow

[Back to task list](./tasks.md)

## Description

End-to-end test covering the complete Vault secret management flow: deployment verification, secret storage across all types, Railway integration with per-user tokens, UI workflows, and all Conditions of Satisfaction from the PBI.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-09 00:00:00 | Created | N/A | Proposed | Task file created | AI Agent |

## Requirements

This E2E test must verify all Conditions of Satisfaction from PBI 17:

1. **Vault Infrastructure** - Vault deployed and operational
2. **Vault Client Integration** - Client connects, authenticates, health checks work
3. **Railway Token Management** - Store, retrieve, rotate, validate tokens
4. **GitHub Token Management** - Store, validate, use for private repos
5. **Docker Credentials Management** - Store, list, use for authentication
6. **Environment-Specific Secrets** - Store, bulk operations, proper namespacing
7. **Generic Secret Management** - CRUD, metadata, search/filter
8. **Version Management** - History, rollback, version retrieval
9. **Secret Management UI** - All tabs, modals, actions functional
10. **Security & Audit** - Encryption, masking, audit logs, isolation
11. **Error Handling & Resilience** - Circuit breaker, caching, graceful degradation
12. **Migration & Backward Compatibility** - Feature flag, fallback, no breaking changes

## Implementation Plan

### Test Structure
1. Setup: Deploy Vault, create test users
2. Test each CoS category systematically
3. Verify UI workflows manually or with E2E framework
4. Test failure scenarios
5. Verify audit logs
6. Cleanup

### Test Scenarios

**Infrastructure (CoS 1-2):**
- Vault server running on Railway with persistent storage
- Health checks return healthy status
- Audit logging enabled
- AppRole authentication works
- Token renewal prevents expiration

**Railway Token Management (CoS 3):**
- User A stores Railway token
- User A creates environment (uses their token)
- User B cannot access User A's token
- Token validation works
- Rotation creates new version
- Status endpoint shows configuration

**GitHub & Docker (CoS 4-5):**
- Store GitHub token, validate scopes
- Store Docker credentials for multiple registries
- List registries returns all configured
- Test credentials work for authentication

**Environment & Generic Secrets (CoS 6-7):**
- Store environment-specific secrets
- Bulk import works atomically
- Generic secrets with tags work
- Search and filter functional
- Proper namespacing by user and environment

**Version Management (CoS 8):**
- Secret updates create new versions
- Version history accessible
- Rollback creates new version with old value
- Keep last 10 versions

**UI Workflows (CoS 9):**
- Credentials settings page loads
- Railway token tab: add, test, rotate, remove
- GitHub token tab: add, validate, remove
- Docker registries tab: add, test, remove
- Custom secrets tab: add, version history, rollback
- Environment secrets tab: add, bulk import, export

**Security & Audit (CoS 10):**
- Secrets never in logs or error messages
- Secret values masked in UI
- Audit log tracks access
- User A cannot access User B's secrets
- Encryption at rest verified

**Resilience (CoS 11):**
- Vault unavailable: cached tokens used
- Circuit breaker opens after failures
- Clear error messages guide users
- Retry logic works
- Application doesn't crash

**Migration (CoS 12):**
- VAULT_ENABLED=false uses env var
- VAULT_ENABLED=true uses Vault
- Existing deployments work
- No breaking changes

## Test Plan

**Objective**: Verify all PBI 17 Conditions of Satisfaction are met through comprehensive end-to-end testing.

**Success Criteria**:
All 12 CoS categories pass verification:
1. ✅ Vault Infrastructure operational
2. ✅ Vault Client Integration working
3. ✅ Railway Token Management complete
4. ✅ GitHub Token Management complete
5. ✅ Docker Credentials Management complete
6. ✅ Environment-Specific Secrets complete
7. ✅ Generic Secret Management complete
8. ✅ Version Management complete
9. ✅ Secret Management UI complete
10. ✅ Security & Audit complete
11. ✅ Error Handling & Resilience complete
12. ✅ Migration & Backward Compatibility complete

## Verification

This test verifies the completion of PBI 17. All checklist items must pass:

- [ ] Vault server deployed on Railway with persistent storage
- [ ] Vault health checks configured
- [ ] Audit logging enabled
- [ ] AppRole authentication works
- [ ] Go Vault client connects successfully
- [ ] Automatic token renewal working
- [ ] Circuit breaker prevents cascade failures
- [ ] Railway tokens: store, get, rotate, validate
- [ ] Railway client uses per-user tokens
- [ ] GitHub tokens: store, validate, delete
- [ ] Docker credentials: store, list, test
- [ ] Environment secrets: store, bulk, list
- [ ] Generic secrets: CRUD, metadata, filter
- [ ] Version management: history, rollback
- [ ] Credentials settings page functional
- [ ] Railway token UI tab complete
- [ ] GitHub/Docker tabs complete
- [ ] Custom secrets tab with version history
- [ ] Environment secrets tab with bulk import
- [ ] Secrets encrypted at rest
- [ ] Secrets never in logs
- [ ] Secret values masked in UI
- [ ] Audit log tracks access
- [ ] User isolation enforced
- [ ] Circuit breaker functional
- [ ] Caching reduces Vault calls
- [ ] Graceful degradation works
- [ ] Error messages helpful
- [ ] VAULT_ENABLED flag works
- [ ] Env var fallback works
- [ ] No breaking changes
- [ ] Migration guide documented

## Files Modified

- `api/test/e2e/vault_complete_flow_test.go` (new)
- E2E test documentation (new)

