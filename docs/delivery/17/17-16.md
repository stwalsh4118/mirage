# [17-16] Implement Railway token API endpoints

[Back to task list](./tasks.md)

## Description

Create REST API endpoints for Railway token management: store/update, status check, validation, deletion, and rotation operations.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-09 00:00:00 | Created | N/A | Proposed | Task file created | AI Agent |
| 2025-10-10 00:00:00 | Status Change | Proposed | InProgress | Starting implementation of Railway token API endpoints | AI Agent |
| 2025-10-10 00:15:00 | Status Change | InProgress | Review | All endpoints implemented, tested, and compiling successfully | AI Agent |
| 2025-10-10 02:00:00 | Status Change | Review | Done | Tested and working - Railway token management complete | User |

## Requirements

1. Create SecretsController with Vault dependency
2. Implement `POST /api/v1/secrets/railway` - Store/update token
3. Implement `GET /api/v1/secrets/railway/status` - Check configuration status
4. Implement `POST /api/v1/secrets/railway/validate` - Test token validity
5. Implement `DELETE /api/v1/secrets/railway` - Delete token
6. Implement `POST /api/v1/secrets/railway/rotate` - Rotate to new token
7. Add request validation and error handling
8. Register routes with authentication middleware

## Implementation Plan

1. Create `api/internal/controller/secrets.go`
2. Implement SecretsController struct with Vault dependency
3. Implement each endpoint method
4. Add request/response types
5. Validate Railway token before storing (test Railway API)
6. Register routes in server.go
7. Add comprehensive logging

## Test Plan

**Success Criteria**:
- Store validates and stores Railway token
- Status returns accurate configuration state
- Validate tests token with Railway API
- Delete removes token
- Rotate creates new version
- All endpoints require authentication
- Clear error messages returned

## Verification

- [x] SecretsController created
- [x] All Railway token endpoints implemented
- [x] Request/response types defined
- [x] Token validation on store
- [x] Routes registered with auth
- [x] Code compiles successfully

## Files Modified

- `api/internal/controller/secrets.go` (new)
- `api/internal/server/server.go` (updated)

## Implementation Notes

### SecretsController Structure

Created `SecretsController` with dependencies:
- `Vault *vault.Client` - For storing/retrieving secrets
- `Railway *railway.Client` - For validating Railway tokens

### Endpoints Implemented

1. **POST /api/v1/secrets/railway** - Store/Update Token
   - Validates token by testing Railway API before storage
   - Uses `railway.NewClient()` to create test client
   - Calls `testClient.ListProjects()` to verify token works
   - Stores token in Vault via `c.Vault.StoreRailwayToken()`
   - Returns success with timestamp

2. **GET /api/v1/secrets/railway/status** - Check Configuration Status
   - Attempts to retrieve token via `c.Vault.GetRailwayToken()`
   - Returns `configured: false` if `ErrSecretNotFound`
   - Returns `configured: true` if token exists
   - Includes user-friendly messages for each state

3. **POST /api/v1/secrets/railway/validate** - Test Token Validity
   - Retrieves token from Vault
   - Creates test Railway client
   - Calls `testClient.ListProjects()` to verify
   - Updates `last_validated` metadata via `c.Vault.ValidateRailwayToken()`
   - Returns `valid: true/false` with message

4. **DELETE /api/v1/secrets/railway** - Delete Token
   - Calls `c.Vault.DeleteRailwayToken()`
   - Handles `ErrSecretNotFound` with 404 response
   - Returns success message on deletion

5. **POST /api/v1/secrets/railway/rotate** - Rotate Token
   - Validates new token by testing Railway API
   - Calls `c.Vault.RotateRailwayToken()` which creates new version
   - Preserves old version in Vault for audit trail
   - Returns success message

### Request/Response Types

Defined strongly-typed request and response structs:
- `StoreRailwayTokenRequest` / `StoreRailwayTokenResponse`
- `RailwayTokenStatusResponse`
- `ValidateRailwayTokenResponse`
- `DeleteRailwayTokenResponse`
- `RotateRailwayTokenRequest` / `RotateRailwayTokenResponse`

### Error Handling

All endpoints handle common error scenarios:
- Authentication required (401)
- Vault unavailable (503)
- Invalid request body (400)
- Token validation failures (400)
- Token not found (404)
- Internal Vault errors (500)

Each error includes:
- User-friendly error message
- Actionable guidance ("Please add your Railway token")
- Technical details for debugging

### Security Considerations

1. **Authentication**: All routes require authentication via `auth.RequireAuth(db)` middleware
2. **User Isolation**: Each endpoint extracts user via `auth.GetCurrentUser(ctx)` and operates only on that user's secrets
3. **Token Validation**: Tokens are tested with Railway API before storage to prevent invalid tokens
4. **Vault Integration**: Uses Vault's KV v2 engine with versioning for audit trail
5. **No Token Exposure**: Token values never logged or exposed in responses (only success/failure)

### Route Registration

Routes registered in `server.go` under `/api/v1/secrets/*`:
- Only registered if both `vaultClient` and `rw` (Railway client) are available
- All routes under authenticated group with `auth.RequireAuth(db)` middleware
- Controller only initialized when dependencies are satisfied

### Testing Considerations

The implementation is ready for:
- Unit tests with mocked Vault and Railway clients
- Integration tests with real Vault instance
- Testing invalid tokens (should reject)
- Testing token validation flow
- Testing rotation preserves old versions
- Testing error scenarios (Vault down, Railway API errors)

