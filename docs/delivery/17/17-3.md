# [17-3] Deploy Vault server on Railway with persistent storage

[Back to task list](./tasks.md)

## Description

Deploy HashiCorp Vault as a Railway service using the official Docker image with integrated Raft storage backend. Configure Railway volume for persistent data storage and document the initialization, unsealing, and operational procedures.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-09 00:00:00 | Created | N/A | Proposed | Task file created | AI Agent |

## Requirements

1. Deploy Vault on Railway using official `hashicorp/vault` Docker image
2. Configure integrated Raft storage (no external dependencies)
3. Create and mount Railway volume at `/vault/data` for persistence
4. Configure TLS using Railway's automatic HTTPS
5. Set appropriate resource limits (512MB-1GB RAM minimum)
6. Document initialization procedure
7. Document unsealing procedure (manual for MVP)
8. Create operational runbook for Vault management

## Implementation Plan

### Phase 1: Railway Service Creation
1. Create new Railway service for Vault
2. Configure Docker image: `hashicorp/vault:latest` (or pin to specific version)
3. Set up volume:
   - Create Railway volume
   - Mount at `/vault/data`
   - Ensure appropriate size (minimum 1GB, recommend 10GB for production)

### Phase 2: Vault Configuration
1. Create Vault configuration file for Raft storage:
   ```hcl
   storage "raft" {
     path = "/vault/data"
   }
   
   listener "tcp" {
     address = "0.0.0.0:8200"
     tls_disable = true  # Railway handles TLS via reverse proxy
   }
   
   api_addr = "https://<railway-domain>"
   cluster_addr = "https://<railway-domain>:8201"
   ui = true
   ```
2. Configure environment variables in Railway:
   - `VAULT_ADDR=http://127.0.0.1:8200`
   - Resource limits as needed

### Phase 3: Initialization Procedure
1. Document initial setup steps:
   - Start Vault service
   - Initialize Vault: `vault operator init`
   - Save unseal keys and root token securely
   - Unseal Vault with 3 of 5 keys: `vault operator unseal`
2. Create secure storage plan for unseal keys:
   - Document where keys should be stored
   - Recommend splitting keys among team members
   - Emphasize security importance

### Phase 4: Configure KV Secrets Engine
1. Enable KV v2 secrets engine:
   ```bash
   vault secrets enable -path=mirage kv-v2
   vault kv metadata put -max-versions=10 mirage/config
   ```
2. Configure versioning to keep last 10 versions

### Phase 5: Configure AppRole Authentication
1. Enable AppRole auth method:
   ```bash
   vault auth enable approle
   ```
2. Create policy for Mirage backend:
   ```hcl
   path "mirage/data/users/*" {
     capabilities = ["create", "read", "update", "delete", "list"]
   }
   
   path "mirage/metadata/users/*" {
     capabilities = ["read", "list"]
   }
   ```
3. Create AppRole:
   ```bash
   vault write auth/approle/role/mirage-backend \
     token_policies="mirage-backend-policy" \
     token_ttl=1h \
     token_max_ttl=24h \
     bind_secret_id=true
   ```
4. Get RoleID and generate SecretID for application

### Phase 6: Enable Audit Logging
1. Enable file audit backend:
   ```bash
   vault audit enable file file_path=/vault/logs/audit.log
   ```
2. Configure log rotation if needed

### Phase 7: Operational Documentation
1. Create runbook document with:
   - Unsealing procedure after restart
   - Health check commands
   - Backup procedure (Raft snapshots)
   - Recovery procedure
   - Common troubleshooting steps
   - How to rotate RoleID/SecretID

## Test Plan

**Objective**: Verify Vault deploys successfully on Railway with persistent storage and can be operated reliably.

**Success Criteria**:
- Vault service running on Railway
- Volume mounted and Raft storage working
- Vault initializes successfully
- Unsealing works with generated keys
- Data persists across service restarts
- KV v2 secrets engine operational
- AppRole authentication configured
- Audit logging enabled

**Test Steps**:
1. Verify Vault service is running
2. Initialize Vault and save keys
3. Unseal Vault
4. Test KV write/read
5. Restart service and verify data persists
6. Unseal again after restart
7. Verify AppRole authentication works
8. Check audit log is being written

## Verification

- [ ] Vault service deployed on Railway
- [ ] Volume created and mounted at `/vault/data`
- [ ] Vault initialized with unseal keys saved securely
- [ ] Vault unsealed and operational
- [ ] KV v2 secrets engine enabled at `/mirage` path
- [ ] AppRole authentication configured
- [ ] Mirage backend policy created
- [ ] AppRole credentials (RoleID, SecretID) generated and stored
- [ ] Audit logging enabled
- [ ] Data persists across service restarts
- [ ] Operational runbook created
- [ ] Unsealing procedure documented
- [ ] Backup/recovery procedure documented

## Files Modified

- Railway service configuration (new)
- `docs/delivery/17/vault-operations-runbook.md` (new)
- `docs/delivery/17/vault-config.hcl` (new, sample configuration)

