# [17-8] Define SecretStore interface and domain types

[Back to task list](./tasks.md)

## Description

Define the `SecretStore` interface that abstracts all secret management operations. Create domain types for secrets, metadata, and credentials. This interface will be the contract for all secret operations in Mirage.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-09 00:00:00 | Created | N/A | Proposed | Task file created | AI Agent |

## Requirements

1. Define `SecretStore` interface with all secret operations
2. Create domain types: `Secret`, `SecretMetadata`, `DockerCredentials`
3. Define error types for secret operations
4. Add comprehensive documentation for all methods
5. Follow Go interface best practices

## Implementation Plan

### Phase 1: Define Domain Types
1. Create `types.go` with domain types:
   ```go
   // SecretMetadata contains metadata about a secret
   type SecretMetadata struct {
       CreatedBy     string
       CreatedAt     time.Time
       LastValidated *time.Time
       SecretType    string
       Tags          []string
       Version       int
   }
   
   // Secret represents a secret with its value and metadata
   type Secret struct {
       Key      string
       Value    string
       Metadata SecretMetadata
   }
   
   // DockerCredentials contains Docker registry credentials
   type DockerCredentials struct {
       Registry string
       Username string
       Password string
       Email    string
   }
   
   // VaultStatus represents Vault health and status
   type VaultStatus struct {
       Available   bool
       Initialized bool
       Sealed      bool
       Version     string
       ClusterID   string
   }
   
   // CacheStats contains cache performance metrics
   type CacheStats struct {
       Size    int
       Hits    int64
       Misses  int64
       HitRate float64
   }
   ```

### Phase 2: Define Error Types
1. Create standard errors:
   ```go
   var (
       ErrSecretNotFound     = errors.New("secret not found")
       ErrVersionNotFound    = errors.New("secret version not found")
       ErrInvalidSecret      = errors.New("invalid secret value")
       ErrVaultUnavailable   = errors.New("vault is unavailable")
       ErrCircuitOpen        = errors.New("circuit breaker is open")
       ErrUnauthorized       = errors.New("unauthorized access to secret")
       ErrSecretLocked       = errors.New("secret is locked (CAS conflict)")
   )
   ```

### Phase 3: Define SecretStore Interface
1. Create `store.go` with complete interface:
   ```go
   // SecretStore defines the interface for secret management operations
   type SecretStore interface {
       // Railway token management
       StoreRailwayToken(ctx context.Context, userID, token string) error
       GetRailwayToken(ctx context.Context, userID string) (string, error)
       DeleteRailwayToken(ctx context.Context, userID string) error
       RotateRailwayToken(ctx context.Context, userID, newToken string) error
       ValidateRailwayToken(ctx context.Context, userID string) error
       
       // GitHub PAT management
       StoreGitHubToken(ctx context.Context, userID, token string) error
       GetGitHubToken(ctx context.Context, userID string) (string, error)
       DeleteGitHubToken(ctx context.Context, userID string) error
       
       // Docker credentials management
       StoreDockerCredentials(ctx context.Context, userID string, creds DockerCredentials) error
       GetDockerCredentials(ctx context.Context, userID, registry string) (DockerCredentials, error)
       ListDockerRegistries(ctx context.Context, userID string) ([]string, error)
       DeleteDockerCredentials(ctx context.Context, userID, registry string) error
       
       // Environment-specific secrets
       StoreEnvironmentSecret(ctx context.Context, userID, envID, key, value string) error
       GetEnvironmentSecret(ctx context.Context, userID, envID, key string) (string, error)
       GetAllEnvironmentSecrets(ctx context.Context, userID, envID string) (map[string]string, error)
       DeleteEnvironmentSecret(ctx context.Context, userID, envID, key string) error
       BulkStoreEnvironmentSecrets(ctx context.Context, userID, envID string, secrets map[string]string) error
       
       // Generic secret management
       StoreSecret(ctx context.Context, userID, key, value string, metadata SecretMetadata) error
       GetSecret(ctx context.Context, userID, key string) (Secret, error)
       GetSecretValue(ctx context.Context, userID, key string) (string, error)
       DeleteSecret(ctx context.Context, userID, key string) error
       ListSecrets(ctx context.Context, userID string) ([]SecretMetadata, error)
       
       // Version management
       GetSecretVersion(ctx context.Context, userID, key string, version int) (Secret, error)
       ListSecretVersions(ctx context.Context, userID, key string) ([]int, error)
       RollbackSecret(ctx context.Context, userID, key string, toVersion int) error
       
       // Metadata management
       UpdateSecretMetadata(ctx context.Context, userID, key string, metadata SecretMetadata) error
       GetSecretMetadata(ctx context.Context, userID, key string) (SecretMetadata, error)
       
       // Health and status
       HealthCheck(ctx context.Context) error
       GetVaultStatus(ctx context.Context) (VaultStatus, error)
       GetCacheStats() CacheStats
   }
   ```

### Phase 4: Add Documentation
1. Add comprehensive godoc comments for all interface methods
2. Include usage examples in comments
3. Document expected error conditions
4. Add examples for each major operation type

### Phase 5: Add Constant Definitions
1. Create constants for secret types and paths:
   ```go
   const (
       // Secret types
       SecretTypeRailway     = "railway_token"
       SecretTypeGitHub      = "github_pat"
       SecretTypeDocker      = "docker_credentials"
       SecretTypeEnvironment = "environment_secret"
       SecretTypeCustom      = "custom"
       
       // Path components
       PathUsers       = "users"
       PathRailway     = "railway"
       PathGitHub      = "github"
       PathDocker      = "docker"
       PathEnvVars     = "env_vars"
       PathCustom      = "custom"
   )
   ```

2. Add helper functions for path construction:
   ```go
   // BuildSecretPath constructs a Vault path for a secret
   func BuildSecretPath(mountPath string, components ...string) string {
       parts := append([]string{mountPath, PathUsers}, components...)
       return strings.Join(parts, "/")
   }
   ```

## Test Plan

**Objective**: Verify interface is well-defined and types are correct.

**Success Criteria**:
- All types compile without errors
- Interface methods cover all requirements from PRD
- Error types are defined and exported
- Documentation is comprehensive
- Path helper functions work correctly

## Verification

- [ ] `types.go` created with all domain types
- [ ] `store.go` created with SecretStore interface
- [ ] All methods from PRD included in interface
- [ ] Error types defined
- [ ] Constants for secret types defined
- [ ] Path helper functions implemented
- [ ] Comprehensive godoc comments added
- [ ] Code compiles successfully
- [ ] No linter errors

## Files Modified

- `api/internal/vault/types.go` (new)
- `api/internal/vault/store.go` (new)
- `api/internal/vault/errors.go` (new)
- `api/internal/vault/paths.go` (new)

