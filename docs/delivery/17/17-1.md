# [17-1] Research and document HashiCorp Vault Go API

[Back to task list](./tasks.md)

## Description

Research the HashiCorp Vault Go SDK (`github.com/hashicorp/vault/api`) to understand KV v2 secrets engine operations, authentication methods, and best practices. Create a comprehensive implementation guide document (`17-1-vault-api-guide.md`) that will serve as the authoritative reference for implementing Vault integration in the Mirage backend.

This task focuses on understanding:
- How to initialize and configure Vault client in Go
- KV v2 secrets engine API for versioned secrets
- Authentication methods (Token auth and AppRole)
- Secret paths, namespacing, and metadata
- Error handling patterns and retry strategies
- Health checking and status monitoring

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-09 00:00:00 | Created | N/A | Proposed | Task file created | AI Agent |

## Requirements

1. **Research Areas**:
   - Vault Go SDK installation and client initialization
   - KV v2 secrets engine operations (read, write, delete, list)
   - Secret versioning and metadata management
   - Authentication: Token auth (development) and AppRole (production)
   - Token renewal and lifecycle management
   - Error handling and retry patterns
   - Health check and seal status APIs
   - Connection pooling and performance considerations

2. **Documentation Requirements**:
   - Create `docs/delivery/17/17-1-vault-api-guide.md`
   - Date-stamped with research date
   - Link to official Vault Go SDK documentation
   - Include code examples for:
     - Client initialization with different auth methods
     - KV v2 secret CRUD operations
     - Version management (get specific version, list versions)
     - Metadata operations
     - Token renewal
     - Health checking
   - List required environment variables
   - Document path conventions for Mirage secret organization
   - Note any gotchas or common pitfalls

3. **API Coverage**:
   - `api.NewClient()` initialization
   - `api.Config` configuration options
   - `logical.Client` for KV operations
   - `sys.Client` for health/status checks
   - KV v2 path formatting (`/v1/{mount}/data/{path}` vs `/v1/{mount}/metadata/{path}`)
   - Check-and-Set (CAS) operations for preventing concurrent updates
   - Authentication and token management

## Implementation Plan

### Phase 1: SDK Discovery
1. Review official Vault Go SDK documentation:
   - GitHub repository: https://github.com/hashicorp/vault/tree/main/api
   - Official docs: https://developer.hashicorp.com/vault/docs
   - Package documentation: https://pkg.go.dev/github.com/hashicorp/vault/api
2. Identify key packages and types:
   - `api` package for client
   - `logical` package for secret operations
   - `sys` package for system operations
3. Review example projects and code samples

### Phase 2: KV v2 Secrets Engine Research
1. Understand KV v2 API paths and operations:
   - `/v1/{mount}/data/{path}` for secret data
   - `/v1/{mount}/metadata/{path}` for metadata
   - Version-specific reads
2. Research versioning behavior:
   - How versions are numbered
   - How to read specific versions
   - How to configure max versions to keep
3. Study metadata structure and custom metadata support

### Phase 3: Authentication Methods Research
1. Token Authentication:
   - Direct token configuration
   - Root token vs regular tokens
   - Token TTL and renewal
2. AppRole Authentication:
   - RoleID and SecretID
   - Token generation from AppRole
   - Automatic renewal patterns
3. Compare approaches for dev vs production

### Phase 4: Error Handling and Resilience
1. Identify error types from Vault SDK
2. Research retry strategies for transient failures
3. Study connection management and pooling
4. Understand seal status and availability errors

### Phase 5: Health and Status Monitoring
1. Health check endpoints
2. Seal status detection
3. Leader/standby status (for future HA)
4. Metrics and monitoring integration

### Phase 6: Documentation Creation
1. Create comprehensive guide document
2. Include practical code examples for each operation
3. Document path conventions for Mirage:
   - `/mirage/users/{user_id}/railway`
   - `/mirage/users/{user_id}/github`
   - `/mirage/users/{user_id}/docker/{registry}`
   - `/mirage/users/{user_id}/env_vars/{environment_id}`
   - `/mirage/users/{user_id}/custom/{key}`
4. Add troubleshooting section with common issues

## Test Plan

**Objective**: Verify research is comprehensive and guide is accurate.

**Success Criteria**:
- Guide document created with all required sections
- Code examples compile and demonstrate correct API usage
- All authentication methods covered
- Path conventions clearly documented
- Common errors and solutions documented

## Verification

- [ ] `17-1-vault-api-guide.md` file created in `docs/delivery/17/`
- [ ] Guide includes date stamp and links to official docs
- [ ] Client initialization examples provided for both auth methods
- [ ] KV v2 CRUD operations documented with examples
- [ ] Version management operations documented
- [ ] Metadata operations documented
- [ ] Error handling patterns documented
- [ ] Health check examples provided
- [ ] Path conventions for Mirage secrets documented
- [ ] Common gotchas and troubleshooting section included

## Files Modified

- `docs/delivery/17/17-1-vault-api-guide.md` (new)

