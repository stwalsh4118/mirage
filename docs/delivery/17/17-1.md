# [17-1] Research and document HashiCorp Vault HTTP API

[Back to task list](./tasks.md)

## Description

Research the HashiCorp Vault HTTP API (not the Go SDK, which is in beta) to understand KV v2 secrets engine operations, authentication methods, and best practices. Create a comprehensive implementation guide document (`17-1-vault-http-api-guide.md`) that will serve as the authoritative reference for implementing Vault integration in the Mirage backend using direct HTTP calls.

This task focuses on understanding:
- How to make HTTP requests to Vault API from Go
- KV v2 secrets engine HTTP endpoints for versioned secrets
- Authentication methods via HTTP (Token auth and AppRole)
- Secret paths, namespacing, and metadata operations
- Error handling patterns and HTTP status codes
- Health checking and seal status endpoints

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-09 00:00:00 | Created | N/A | Proposed | Task file created | AI Agent |
| 2025-10-09 01:00:00 | Status Change | Proposed | InProgress | Started research on Vault HTTP API | AI Agent |
| 2025-10-09 01:30:00 | Status Change | InProgress | Review | Completed comprehensive HTTP API research and documentation | AI Agent |
| 2025-10-09 05:00:00 | Status Change | Review | Done | Approved and ready for use | User |

## Requirements

1. **Research Areas**:
   - Vault HTTP API endpoint structure and conventions
   - KV v2 secrets engine HTTP endpoints (read, write, delete, list)
   - Secret versioning and metadata management via HTTP
   - Authentication: Token auth (development) and AppRole (production)
   - Token renewal and lifecycle management via HTTP
   - Error handling and HTTP status codes
   - Health check and seal status endpoints
   - HTTP client patterns and best practices in Go

2. **Documentation Requirements**:
   - Create `docs/delivery/17/17-1-vault-http-api-guide.md`
   - Date-stamped with research date
   - Link to official Vault HTTP API documentation
   - Include code examples for:
     - HTTP client setup with authentication headers
     - KV v2 secret CRUD operations via HTTP
     - Version management (get specific version, list versions)
     - Metadata operations
     - Token renewal via HTTP
     - Health checking
   - List required environment variables
   - Document path conventions for Mirage secret organization
   - Note any gotchas or common pitfalls

3. **API Coverage**:
   - HTTP endpoint patterns and URL structure
   - Request/response formats and headers
   - KV v2 path formatting (`/v1/{mount}/data/{path}` vs `/v1/{mount}/metadata/{path}`)
   - Check-and-Set (CAS) operations for preventing concurrent updates
   - Authentication endpoints and token management
   - Error response formats and status codes

## Implementation Plan

### Phase 1: HTTP API Discovery
1. Review official Vault HTTP API documentation:
   - Official docs: https://developer.hashicorp.com/vault/api-docs
   - KV v2 API: https://developer.hashicorp.com/vault/api-docs/secret/kv/kv-v2
   - AppRole API: https://developer.hashicorp.com/vault/api-docs/auth/approle
   - System API: https://developer.hashicorp.com/vault/api-docs/system
2. Identify key endpoint patterns:
   - Authentication endpoints
   - Data vs metadata paths
   - System endpoints
3. Review HTTP request/response formats

### Phase 2: KV v2 Secrets Engine Research
1. Understand KV v2 HTTP endpoint patterns:
   - `POST /v1/{mount}/data/{path}` - Write secret
   - `GET /v1/{mount}/data/{path}?version={n}` - Read secret
   - `DELETE /v1/{mount}/data/{path}` - Delete secret
   - `LIST /v1/{mount}/metadata/{path}` - List secrets
2. Research versioning behavior:
   - How versions are numbered (start at 1)
   - Query parameter for specific versions
   - How to configure max versions to keep
3. Study metadata structure and custom metadata support via HTTP

### Phase 3: Authentication Methods Research
1. Token Authentication via HTTP:
   - X-Vault-Token header usage
   - Root token vs regular tokens
   - Token TTL and renewal endpoints
2. AppRole Authentication via HTTP:
   - `POST /v1/auth/approle/login` endpoint
   - RoleID and SecretID in request body
   - Token generation from AppRole response
   - Automatic renewal patterns
3. Compare approaches for dev vs production

### Phase 4: Error Handling and Resilience
1. Identify HTTP status codes and error response formats
2. Research retry strategies for transient failures (429, 500)
3. Study HTTP client connection management and pooling
4. Understand seal status (503) and initialization errors (501)

### Phase 5: Health and Status Monitoring
1. `GET /v1/sys/health` endpoint
2. `GET /v1/sys/seal-status` endpoint
3. Leader/standby status in response (for future HA)
4. Status code variations and query parameters

### Phase 6: Documentation Creation
1. Create comprehensive guide document
2. Include practical HTTP request/response examples
3. Include Go HTTP client code examples for each operation
4. Document path conventions for Mirage:
   - `/mirage/users/{user_id}/railway`
   - `/mirage/users/{user_id}/github`
   - `/mirage/users/{user_id}/docker/{registry}`
   - `/mirage/users/{user_id}/env_vars/{environment_id}`
   - `/mirage/users/{user_id}/custom/{key}`
5. Add troubleshooting section with common issues and gotchas

## Test Plan

**Objective**: Verify research is comprehensive and guide is accurate for HTTP API usage.

**Success Criteria**:
- Guide document created with all required sections
- HTTP request/response examples are accurate
- Go HTTP client code examples demonstrate correct patterns
- All authentication methods covered with HTTP examples
- Path conventions clearly documented
- HTTP status codes and error formats documented
- Common errors and solutions documented

## Verification

- [x] `17-1-vault-http-api-guide.md` file created in `docs/delivery/17/`
- [x] Guide includes date stamp and links to official HTTP API docs
- [x] HTTP authentication examples provided for both methods (Token, AppRole)
- [x] KV v2 CRUD operations documented with HTTP examples
- [x] Version management operations documented (read version, list versions, metadata)
- [x] Metadata operations documented (read, update custom metadata)
- [x] Error handling patterns documented (status codes, error formats)
- [x] Health check and seal status examples provided
- [x] Path conventions for Mirage secrets documented
- [x] Common gotchas and troubleshooting section included
- [x] Go HTTP client implementation patterns provided
- [x] Request/response type definitions included

## Files Modified

- `docs/delivery/17/17-1-vault-http-api-guide.md` (new)

