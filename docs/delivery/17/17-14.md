# [17-14] Refactor Railway client to support per-user tokens

[Back to task list](./tasks.md)

## Description

Refactor the Railway client initialization to support per-user tokens fetched from Vault. Add a factory function to create user-specific Railway clients dynamically based on user ID and Vault integration.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-09 00:00:00 | Created | N/A | Proposed | Task file created | AI Agent |

## Requirements

1. Keep existing `NewClient()` function for backward compatibility
2. Add `GetUserRailwayClient()` factory function
3. Fetch Railway token from Vault based on user ID
4. Create and return Railway client with user's token
5. Handle missing tokens gracefully with clear errors
6. Support fallback to env var token when Vault disabled
7. Add logging for client creation

## Implementation Plan

### Phase 1: Add Factory Function
1. Create `user_client.go` in railway package:
   ```go
   // GetUserRailwayClient creates a Railway client for a specific user
   // by fetching their Railway token from Vault
   func GetUserRailwayClient(
       ctx context.Context,
       userID string,
       vault vault.SecretStore,
       endpoint string,
       httpc *http.Client,
   ) (*Client, error) {
       if vault == nil {
           return nil, errors.New("vault not configured, cannot get user railway client")
       }
       
       token, err := vault.GetRailwayToken(ctx, userID)
       if err != nil {
           return nil, fmt.Errorf("failed to get railway token for user %s: %w", userID, err)
       }
       
       client := NewClient(endpoint, token, httpc)
       log.Debug().Str("user_id", userID).Msg("created user-specific railway client")
       return client, nil
   }
   ```

### Phase 2: Add Helper for Controllers
1. Add helper that can fall back to global token:
   ```go
   // GetRailwayClientForUser returns a user-specific Railway client if Vault
   // is enabled, otherwise returns a client with the global Railway token
   func GetRailwayClientForUser(
       ctx context.Context,
       userID string,
       vault vault.SecretStore,
       globalClient *Client,
   ) (*Client, error) {
       if vault != nil {
           return GetUserRailwayClient(ctx, userID, vault, globalClient.endpoint, nil)
       }
       
       // Fall back to global client if Vault not enabled
       log.Debug().Str("user_id", userID).Msg("using global railway client (vault disabled)")
       return globalClient, nil
   }
   ```

### Phase 3: Error Types
1. Add specific error for missing token:
   ```go
   var (
       ErrNoRailwayToken = errors.New("no railway token configured for user")
       ErrVaultDisabled  = errors.New("vault is disabled, cannot fetch user token")
   )
   ```

## Test Plan

**Success Criteria**:
- Factory function creates client with user's token from Vault
- Missing token returns clear error
- Fallback to global client when Vault disabled
- Existing code continues to work with NewClient

**Test Steps**:
1. Create user-specific client with valid Vault token
2. Try with user who has no token (should error)
3. Try with Vault disabled (should use global client)
4. Verify existing NewClient still works

## Verification

- [ ] `user_client.go` created in railway package
- [ ] GetUserRailwayClient function implemented
- [ ] GetRailwayClientForUser helper implemented
- [ ] Error types defined
- [ ] Logging added
- [ ] Code compiles successfully
- [ ] Existing Railway client code unchanged
- [ ] Backward compatibility maintained

## Files Modified

- `api/internal/railway/user_client.go` (new)
- `api/internal/railway/errors.go` (new)

