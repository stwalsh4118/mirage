# [17-22] Implement Railway token UI tab with status and actions

[Back to task list](./tasks.md)

## Description

Build the Railway Token tab with status card, add/update modal, test connection button, rotation functionality, and deletion with warnings.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-09 00:00:00 | Created | N/A | Proposed | Task file created | AI Agent |
| 2025-10-10 01:00:00 | Status Change | Proposed | InProgress | Starting implementation of Railway token UI tab | AI Agent |
| 2025-10-10 01:30:00 | Status Change | InProgress | Review | Railway token tab complete with status, modals, and all actions | AI Agent |
| 2025-10-10 02:00:00 | Status Change | Review | Done | Tested and working - Railway token UI complete | User |

## Requirements

1. Status card showing:
   - Connection status (configured, not configured, invalid)
   - Last validated timestamp
   - Quick actions
2. Add/Update token modal with:
   - Masked input field
   - Help text with link to Railway docs
   - Live validation
   - Save & Validate button
3. Test Connection button
4. Rotate Token functionality with confirmation
5. Remove Token button with warning
6. API integration for all operations

## Implementation Plan

1. Create Railway token status component
2. Create add/update modal component
3. Implement API client methods
4. Implement token validation
5. Implement rotation with confirmation dialog
6. Implement deletion with affected resources count
7. Add success/error toast notifications

## Test Plan

**Success Criteria**:
- Status displays correct state
- Modal validates token before saving
- Test connection calls Railway API
- Rotation creates new version
- Deletion shows confirmation
- All API errors displayed clearly

## Verification

- [x] Railway token tab implemented
- [x] Status card shows correct state
- [x] Add/update modal works
- [x] Test connection functional
- [x] Rotation works
- [x] Deletion with confirmation
- [x] API integration complete
- [x] Error handling works

## Files Modified

- `web/src/app/(app)/settings/credentials/page.tsx` (updated)
- `web/src/components/credentials/RailwayTokenTab.tsx` (new - 400+ lines)
- `web/src/lib/api/secrets.ts` (new)
- `web/src/hooks/useRailwayToken.ts` (new)

## Implementation Notes

### API Client Layer (`secrets.ts` & `useRailwayToken.ts`)

Created TypeScript types matching backend API:
- `RailwayTokenStatusResponse` - Token configuration status
- `StoreRailwayTokenRequest/Response` - Store/update token
- `ValidateRailwayTokenResponse` - Token validation result
- `DeleteRailwayTokenResponse` - Delete confirmation
- `RotateRailwayTokenRequest/Response` - Token rotation

Created React Query hooks for all operations:
- `useRailwayTokenStatus()` - Query hook for status polling (30s stale time)
- `useStoreRailwayToken()` - Mutation for storing/updating
- `useValidateRailwayToken()` - Mutation for validation
- `useDeleteRailwayToken()` - Mutation for deletion
- `useRotateRailwayToken()` - Mutation for rotation

All mutations automatically invalidate status query to refresh UI.

### Railway Token Tab Component

**Status Card Features:**
1. **Visual Status Indicator**
   - Green checkmark when configured
   - Red X when not configured
   - Loading spinner while checking
   - Dynamic text and colors

2. **Configuration Instructions**
   - Blue informational card with setup steps
   - Direct link to Railway token settings
   - Only shown when not configured

3. **Last Validated Timestamp**
   - Shows when token was last tested
   - Formatted as localized date/time
   - Only shown when configured

**Add/Update Token Modal:**
- Password input with show/hide toggle (Eye/EyeOff icons)
- Real-time validation before saving
- Loading state during API call
- Security notice about Vault encryption
- Clear error messages on failure

**Test Connection Button:**
- Validates token with Railway API
- Shows loading spinner during test
- Toast notification with result
- Updates last_validated timestamp

**Rotate Token Dialog:**
- Separate input for new token
- Password field with show/hide toggle
- Confirmation before rotation
- Preserves old version in Vault
- Clear success/error feedback

**Delete Token Alert Dialog:**
- Destructive confirmation dialog
- Explains consequences clearly
- Can't be undone warning
- Loading state during deletion
- Success toast on completion

### UI/UX Considerations

1. **Loading States**: All buttons show spinner when operations are in progress
2. **Disabled States**: Buttons disabled when empty input or operation pending
3. **Toast Notifications**: Success/error toasts for all operations using sonner
4. **Password Visibility**: Toggle for viewing token values securely
5. **Confirmation Dialogs**: Destructive actions require explicit confirmation
6. **Help Text**: Contextual help and links to Railway documentation
7. **Responsive Layout**: Works on mobile and desktop
8. **Accessibility**: Proper labels, ARIA attributes via shadcn components

### Integration with Backend

All API calls use:
- `useAuthenticatedFetch` hook for JWT token injection
- Proper error handling with try/catch
- React Query for caching and state management
- Automatic query invalidation on mutations

### Error Handling

Comprehensive error handling:
- Network errors caught and displayed
- API errors parsed and shown in toasts
- Validation errors prevent submission
- Clear, actionable error messages
- Graceful degradation when backend unavailable

### Testing Ready

The implementation supports:
- Manual testing of all CRUD operations
- Token validation flow end-to-end
- Error scenario testing
- Loading state verification
- Responsive layout testing

