# [17-4] Install Vault Go client and implement initialization

[Back to task list](./tasks.md)

## Description

Install the HashiCorp Vault Go SDK (`github.com/hashicorp/vault/api`) and create a new `vault` package in the Mirage backend. Implement client initialization with configuration loading from environment variables, supporting both development and production modes.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-09 00:00:00 | Created | N/A | Proposed | Task file created | AI Agent |

## Requirements

1. Install `github.com/hashicorp/vault/api` package
2. Create `api/internal/vault` package
3. Implement `Config` struct for Vault configuration
4. Implement `NewClient()` function for client initialization
5. Support configuration from environment variables
6. Add Vault config to application `config.AppConfig`
7. Initialize Vault client in main.go
8. Add logging for Vault connection status

## Implementation Plan

### Phase 1: Install Dependencies
1. Add Vault SDK to go.mod:
   ```bash
   cd api
   go get github.com/hashicorp/vault/api@latest
   ```

### Phase 2: Create Vault Package Structure
1. Create directory: `api/internal/vault/`
2. Create files:
   - `client.go` - Client initialization and configuration
   - `config.go` - Configuration types and loading

### Phase 3: Implement Configuration
1. Create `Config` struct in `config.go`:
   ```go
   type Config struct {
       Address     string // VAULT_ADDR
       Token       string // VAULT_TOKEN (for dev)
       RoleID      string // VAULT_ROLE_ID (for prod AppRole)
       SecretID    string // VAULT_SECRET_ID (for prod AppRole)
       Namespace   string // VAULT_NAMESPACE (optional)
       SkipVerify  bool   // VAULT_SKIP_VERIFY (dev only)
       MountPath   string // Secrets mount path (default: "mirage")
   }
   
   func LoadConfig() (Config, error) {
       // Load from environment variables with defaults
   }
   ```

2. Add Vault config to `internal/config/config.go`:
   ```go
   type AppConfig struct {
       // ... existing fields ...
       
       // Vault configuration
       VaultEnabled    bool   // VAULT_ENABLED
       VaultAddr       string // VAULT_ADDR
       VaultToken      string // VAULT_TOKEN
       VaultRoleID     string // VAULT_ROLE_ID
       VaultSecretID   string // VAULT_SECRET_ID
       VaultNamespace  string // VAULT_NAMESPACE
       VaultSkipVerify bool   // VAULT_SKIP_VERIFY
       VaultMountPath  string // VAULT_MOUNT_PATH (default: "mirage")
   }
   ```

### Phase 4: Implement Client Initialization
1. Create `Client` struct in `client.go`:
   ```go
   type Client struct {
       client    *api.Client
       mountPath string
       config    Config
   }
   
   func NewClient(cfg Config) (*Client, error) {
       // Initialize Vault API client
       // Configure TLS if needed
       // Return wrapped client
   }
   ```

2. Implement initialization with error handling:
   - Validate configuration
   - Create Vault API client
   - Test connection
   - Log connection status

### Phase 5: Integrate with Application
1. Update `cmd/server/main.go`:
   ```go
   var vaultClient *vault.Client
   if cfg.VaultEnabled {
       vaultCfg := vault.Config{
           Address:    cfg.VaultAddr,
           Token:      cfg.VaultToken,
           RoleID:     cfg.VaultRoleID,
           SecretID:   cfg.VaultSecretID,
           Namespace:  cfg.VaultNamespace,
           SkipVerify: cfg.VaultSkipVerify,
           MountPath:  cfg.VaultMountPath,
       }
       vc, err := vault.NewClient(vaultCfg)
       if err != nil {
           log.Warn().Err(err).Msg("failed to initialize Vault client, continuing without Vault")
       } else {
           vaultClient = vc
           log.Info().Msg("Vault client initialized successfully")
       }
   }
   ```

2. Pass vault client to server through deps:
   ```go
   r := server.NewHTTPServer(cfg, db, rw, vaultClient)
   ```

### Phase 6: Update Environment Variables
1. Add to `.env.example`:
   ```
   # Vault Configuration
   VAULT_ENABLED=true
   VAULT_ADDR=http://localhost:8200
   VAULT_TOKEN=dev-root-token
   VAULT_SKIP_VERIFY=true
   VAULT_MOUNT_PATH=mirage
   ```

## Test Plan

**Objective**: Verify Vault client initializes correctly in both dev and prod configurations.

**Success Criteria**:
- Package compiles without errors
- Client initializes successfully with dev token
- Client initialization fails gracefully with invalid config
- Configuration loads correctly from environment variables
- Application logs show Vault connection status

**Test Steps**:
1. Compile: `go build ./cmd/server`
2. Start with valid Vault config and verify connection log
3. Start with invalid Vault config and verify warning log
4. Start with VAULT_ENABLED=false and verify Vault client is nil

## Verification

- [ ] `github.com/hashicorp/vault/api` added to go.mod
- [ ] `api/internal/vault/` package created
- [ ] `client.go` implements Client struct and NewClient function
- [ ] `config.go` implements Config struct and LoadConfig function
- [ ] Vault configuration added to `internal/config/config.go`
- [ ] Main.go initializes Vault client when enabled
- [ ] Environment variables documented in `.env.example`
- [ ] Application compiles successfully
- [ ] Vault connection logged on startup
- [ ] Graceful handling when Vault unavailable

## Files Modified

- `api/go.mod` (updated)
- `api/go.sum` (updated)
- `api/internal/vault/client.go` (new)
- `api/internal/vault/config.go` (new)
- `api/internal/config/config.go` (updated)
- `api/cmd/server/main.go` (updated)
- `.env.example` (updated)

