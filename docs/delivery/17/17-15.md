# [17-15] Update controllers to use user-specific Railway clients

[Back to task list](./tasks.md)

## Description

Update EnvironmentController and ServicesController to fetch user-specific Railway tokens from Vault and create per-user Railway clients for all Railway API operations.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-09 00:00:00 | Created | N/A | Proposed | Task file created | AI Agent |

## Requirements

1. Add Vault SecretStore to controllers
2. Update all Railway operations to use user-specific clients
3. Extract user ID from request context (set by auth middleware)
4. Handle missing Railway token gracefully with clear errors
5. Fall back to global client when Vault disabled
6. Add logging for Railway client creation
7. Maintain backward compatibility during migration

## Implementation Plan

### Phase 1: Update Controller Structs
1. Add Vault to EnvironmentController:
   ```go
   type EnvironmentController struct {
       DB      *gorm.DB
       Railway *railway.Client  // Global client for fallback
       Vault   vault.SecretStore
   }
   ```

2. Add Vault to ServicesController:
   ```go
   type ServicesController struct {
       Railway *railway.Client  // Global client for fallback
       DB      *gorm.DB
       Vault   vault.SecretStore
   }
   ```

### Phase 2: Update Environment Controller Methods
1. Update CreateEnvironment:
   ```go
   func (c *EnvironmentController) CreateEnvironment(ctx *gin.Context) {
       userID := auth.GetUserID(ctx)
       
       // Get user-specific Railway client
       rwClient, err := railway.GetRailwayClientForUser(
           ctx,
           userID,
           c.Vault,
           c.Railway,
       )
       if err != nil {
           ctx.JSON(http.StatusBadRequest, gin.H{
               "error": "Railway token not configured. Please add your Railway token in settings.",
               "details": err.Error(),
           })
           return
       }
       
       // Use rwClient for all Railway operations
       // ...
   }
   ```

2. Update other methods: DeleteEnvironment, GetEnvironment, etc.

### Phase 3: Update Services Controller Methods
1. Update ProvisionServices:
   ```go
   func (c *ServicesController) ProvisionServices(ctx *gin.Context) {
       userID := auth.GetUserID(ctx)
       
       // Get user-specific Railway client
       rwClient, err := railway.GetRailwayClientForUser(
           ctx,
           userID,
           c.Vault,
           c.Railway,
       )
       if err != nil {
           ctx.JSON(http.StatusBadRequest, gin.H{
               "error": "Railway token not configured",
               "details": err.Error(),
           })
           return
       }
       
       // Use rwClient for service creation
       // ...
   }
   ```

2. Update DeleteRailwayService similarly

### Phase 4: Update Server Initialization
1. Update `server.go` to accept and pass Vault:
   ```go
   func NewHTTPServer(cfg config.AppConfig, deps ...any) *gin.Engine {
       // ... existing code ...
       
       var db *gorm.DB
       var rw *railway.Client
       var vaultClient vault.SecretStore
       
       for _, d := range deps {
           switch v := d.(type) {
           case *gorm.DB:
               db = v
           case *railway.Client:
               rw = v
           case vault.SecretStore:
               vaultClient = v
           }
       }
       
       // Pass Vault to controllers
       ec := &controller.EnvironmentController{
           DB:      db,
           Railway: rw,
           Vault:   vaultClient,
       }
       
       sc := &controller.ServicesController{
           Railway: rw,
           DB:      db,
           Vault:   vaultClient,
       }
       
       // ...
   }
   ```

### Phase 5: Update main.go
1. Pass Vault client to server:
   ```go
   r := server.NewHTTPServer(cfg, db, rw, vaultClient)
   ```

## Test Plan

**Success Criteria**:
- Controllers create user-specific Railway clients
- Missing Railway token returns clear error message
- Fallback to global client when Vault disabled
- All existing Railway operations work
- User sees helpful error about configuring token

**Test Steps**:
1. Create environment with user who has Railway token
2. Try with user who has no Railway token (should error)
3. Test with Vault disabled (should use global token)
4. Verify error messages are clear and actionable

## Verification

- [ ] Vault added to controller structs
- [ ] All Environment controller methods updated
- [ ] All Services controller methods updated
- [ ] Server initialization updated
- [ ] Main.go updated
- [ ] Clear error messages for missing tokens
- [ ] Fallback logic works
- [ ] Code compiles successfully
- [ ] No regression in existing functionality

## Files Modified

- `api/internal/controller/environment.go` (updated)
- `api/internal/controller/services.go` (updated)
- `api/internal/server/server.go` (updated)
- `api/cmd/server/main.go` (updated)

