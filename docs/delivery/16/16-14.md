# [16-14] Implement user profile UI components

[Back to task list](./tasks.md)

## Description

Add a user profile dropdown to the application header/navigation that displays the user's avatar, name, and email, and includes a sign-out button. Integrate Clerk's `<UserButton />` component or create a custom profile menu using Clerk hooks.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-07 00:00:00 | Created | N/A | Proposed | Task file created | AI Agent |

## Requirements

1. **User Profile Dropdown**:
   - Display user avatar (profile image)
   - Show user's full name
   - Show user's email address
   - Sign-out button
   - Positioned in header/navigation

2. **Component Options**:
   - Option A: Use Clerk's `<UserButton />` (recommended, faster)
   - Option B: Custom component using Clerk hooks

3. **Visual Design**:
   - Match Mirage's design system
   - Responsive (works on mobile)
   - Accessible (keyboard navigation, ARIA labels)
   - Smooth animations

4. **Functionality**:
   - Sign-out clears session and redirects
   - Dropdown closes on outside click
   - Avatar displays user's profile image or initials

## Implementation Plan

### Option A: Use Clerk UserButton (Recommended)

Update header/navigation component:

```typescript
// web/src/components/Header.tsx or similar
import { UserButton } from '@clerk/nextjs';

export function Header() {
  return (
    <header className="border-b border-gray-200 dark:border-gray-800">
      <div className="container mx-auto px-4 py-4 flex items-center justify-between">
        <div className="flex items-center gap-4">
          <h1 className="text-xl font-bold">Mirage</h1>
          {/* Navigation items */}
        </div>
        
        <div className="flex items-center gap-4">
          {/* Other header items */}
          
          <UserButton
            appearance={{
              elements: {
                avatarBox: "w-10 h-10",
                userButtonPopoverCard: "shadow-xl",
              },
            }}
            afterSignOutUrl="/sign-in"
          />
        </div>
      </div>
    </header>
  );
}
```

### Option B: Custom Profile Dropdown

Create custom component:

```typescript
// web/src/components/UserProfileDropdown.tsx
'use client';

import { useUser, useClerk } from '@clerk/nextjs';
import { useState, useRef, useEffect } from 'react';

export function UserProfileDropdown() {
  const { user } = useUser();
  const { signOut } = useClerk();
  const [isOpen, setIsOpen] = useState(false);
  const dropdownRef = useRef<HTMLDivElement>(null);
  
  // Close dropdown on outside click
  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {
        setIsOpen(false);
      }
    }
    
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);
  
  if (!user) return null;
  
  const fullName = [user.firstName, user.lastName].filter(Boolean).join(' ') || user.primaryEmailAddress?.emailAddress;
  const initials = [user.firstName?.[0], user.lastName?.[0]].filter(Boolean).join('').toUpperCase();
  
  return (
    <div className="relative" ref={dropdownRef}>
      <button
        onClick={() => setIsOpen(!isOpen)}
        className="flex items-center gap-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 p-1.5 transition-colors"
        aria-label="User menu"
        aria-expanded={isOpen}
      >
        {user.imageUrl ? (
          <img
            src={user.imageUrl}
            alt={fullName}
            className="w-10 h-10 rounded-full"
          />
        ) : (
          <div className="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-medium">
            {initials}
          </div>
        )}
      </button>
      
      {isOpen && (
        <div className="absolute right-0 mt-2 w-64 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 py-2">
          <div className="px-4 py-3 border-b border-gray-200 dark:border-gray-700">
            <div className="font-medium text-gray-900 dark:text-white">
              {fullName}
            </div>
            <div className="text-sm text-gray-500 dark:text-gray-400">
              {user.primaryEmailAddress?.emailAddress}
            </div>
          </div>
          
          <div className="py-1">
            <button
              onClick={() => {
                setIsOpen(false);
                signOut();
              }}
              className="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
            >
              Sign out
            </button>
          </div>
        </div>
      )}
    </div>
  );
}
```

### Phase 2: Add to Layout
Update layout/header to include profile:

```typescript
// web/src/components/Layout.tsx
import { SignedIn, SignedOut, SignInButton } from '@clerk/nextjs';
import { UserProfileDropdown } from './UserProfileDropdown';

export function Layout({ children }: { children: React.ReactNode }) {
  return (
    <div className="min-h-screen flex flex-col">
      <header className="border-b">
        <div className="container mx-auto px-4 py-4 flex justify-between items-center">
          <h1 className="text-xl font-bold">Mirage</h1>
          
          <div className="flex items-center gap-4">
            <SignedOut>
              <SignInButton mode="modal">
                <button className="btn btn-primary">Sign In</button>
              </SignInButton>
            </SignedOut>
            
            <SignedIn>
              <UserProfileDropdown />
            </SignedIn>
          </div>
        </div>
      </header>
      
      <main className="flex-1">
        {children}
      </main>
    </div>
  );
}
```

### Phase 3: Add Profile Link (Optional)
Add link to Clerk's hosted profile page:

```typescript
<UserButton
  appearance={{
    elements: {
      avatarBox: "w-10 h-10",
    },
  }}
  afterSignOutUrl="/sign-in"
>
  <UserButton.MenuItems>
    <UserButton.Link
      label="Manage account"
      labelIcon={<UserIcon />}
      href="/user-profile"
    />
  </UserButton.MenuItems>
</UserButton>
```

## Verification

### Component Checklist
- [ ] User profile component created/integrated
- [ ] Avatar displays (image or initials)
- [ ] Name displays correctly
- [ ] Email displays correctly
- [ ] Sign-out button works
- [ ] Dropdown opens/closes correctly

### Design Checklist
- [ ] Matches Mirage design system
- [ ] Responsive on mobile
- [ ] Smooth animations
- [ ] Proper spacing and typography
- [ ] Dark mode support (if applicable)

### Accessibility Checklist
- [ ] Keyboard navigation works
- [ ] ARIA labels present
- [ ] Focus states visible
- [ ] Screen reader friendly

## Test Plan

**Objective**: Verify user profile UI works correctly

**Test Scope**: Component rendering, interactions, sign-out

**Manual Testing Steps**:

1. **View Profile Dropdown**:
   - Sign in to app
   - See profile avatar/button in header
   - Click to open dropdown
   - Verify name, email, avatar display

2. **Test Avatar Display**:
   - User with profile image: verify image displays
   - User without image: verify initials display
   - Verify image is circular/rounded

3. **Test Sign-Out**:
   - Click "Sign out" button
   - Verify signed out
   - Verify redirected to sign-in page
   - Verify cannot access protected pages

4. **Test Dropdown Interactions**:
   - Click outside dropdown to close
   - Click avatar again to toggle
   - Use keyboard (Tab, Enter, Escape)

5. **Test Responsive Design**:
   - View on mobile
   - View on tablet
   - View on desktop
   - Verify layout adapts

6. **Test with Different User Data**:
   - User with first and last name
   - User with only first name
   - User with no name (email fallback)
   - User with profile image
   - User without profile image

**Success Criteria**:
- Profile displays correct user data
- Sign-out works correctly
- Dropdown interactions smooth
- Responsive on all screen sizes
- Accessible

## Files Modified

- `web/src/components/UserProfileDropdown.tsx` - Create custom profile dropdown (Option B)
- `web/src/components/Header.tsx` - Add UserButton or UserProfileDropdown
- `web/src/components/Layout.tsx` - Integrate profile into layout

## Notes

### Clerk UserButton Features

**Built-In Features**:
- Profile management (hosted by Clerk)
- Multi-factor authentication setup
- Connected accounts
- Sign-out button
- Customizable appearance

**Advantages**:
- ✅ Faster implementation
- ✅ Maintained by Clerk
- ✅ Security best practices
- ✅ Feature-rich out of the box

### Custom Component Advantages

**Why Custom**:
- Full control over UX
- Match exact design requirements
- Add custom menu items
- Custom navigation

**Trade-offs**:
- More implementation work
- Must maintain compatibility
- Need to test thoroughly

### Clerk Hooks for Custom UI

**Available Hooks**:
```typescript
const { user } = useUser(); // Current user data
const { signOut } = useClerk(); // Sign-out function
const { isLoaded, isSignedIn } = useAuth(); // Auth state
```

**User Object Properties**:
- `firstName`, `lastName`
- `primaryEmailAddress.emailAddress`
- `imageUrl`
- `username` (if enabled)

### Styling Best Practices

**Avatar Sizes**:
- Header: 40px (w-10 h-10)
- Profile page: 80-100px
- Mobile: May want slightly smaller

**Dropdown Positioning**:
- Right-aligned for header
- Use `absolute` with `right-0`
- Add `z-index` for proper layering

**Dark Mode**:
- Clerk components support dark mode
- Custom components need dark: classes
- Test in both themes

### Sign-Out Behavior

**After Sign-Out**:
- Session cleared from Clerk
- Cookies cleared
- Redirect to sign-in page
- Can specify custom redirect URL

**Sign-Out Options**:
```typescript
await signOut();
await signOut({ redirectUrl: '/goodbye' });
await signOut({ sessionId: 'specific-session' });
```

### Integration with Mirage Design

**Design Tokens**:
- Use existing color scheme (desert/mirage)
- Match button styles
- Use consistent spacing
- Follow typography scale

**Component Consistency**:
- Match other dropdown menus
- Use same border radius
- Use same shadow styles
- Consistent hover states

### Mobile Considerations

**Responsive Adjustments**:
- Smaller avatar on mobile
- Full-screen dropdown (optional)
- Touch-friendly tap targets (min 44px)
- Swipe to close (optional)

### Accessibility Requirements

**ARIA Attributes**:
```typescript
<button
  aria-label="User menu"
  aria-expanded={isOpen}
  aria-haspopup="true"
>
```

**Keyboard Navigation**:
- Tab to focus button
- Enter/Space to open
- Escape to close
- Arrow keys for menu items (optional)

### Integration Dependencies

**Requires**:
- Task 16-11: Clerk SDK with useUser, useClerk hooks
- Task 16-13: Authentication state

**Enhances**:
- User experience
- Visual indication of auth state
- Easy access to sign-out

**Testing**:
- Task 16-20: E2E tests interact with profile UI

