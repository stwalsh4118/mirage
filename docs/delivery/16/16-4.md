# [16-4] Add UserID foreign keys to existing models and migration

[Back to task list](./tasks.md)

## Description

Add `UserID` foreign key fields to Environment, Service, and EnvironmentMetadata models to establish resource ownership. Create database migration to add columns with NOT NULL constraint, and delete all existing test data to prepare for authenticated resource creation.

**IMPORTANT**: This task introduces a breaking change - all existing environments, services, and metadata will be deleted as part of the migration since they have no owner.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-07 00:00:00 | Created | N/A | Proposed | Task file created | AI Agent |

## Requirements

1. **Model Updates**:
   - Add `UserID` field to `Environment` model (string, indexed, NOT NULL, FK to User.ID)
   - Add `UserID` field to `Service` model (string, indexed, NOT NULL, FK to User.ID)
   - Add `UserID` field to `EnvironmentMetadata` model (string, indexed, NOT NULL, FK to User.ID)
   - Add `User` relationship field to each model for GORM preloading

2. **Migration Strategy**:
   - DELETE all existing records from:
     - `environment_metadata` table (has FK to environments)
     - `services` table (has FK to environments)
     - `environments` table
   - Add UserID column with NOT NULL constraint
   - No backward compatibility needed (pre-auth system has no users)

3. **GORM Relationships**:
   - Define foreign key relationships using GORM tags
   - Enable cascading deletes if appropriate
   - Support preloading User with `db.Preload("User")`

4. **Indexes**:
   - Create index on UserID in all three tables
   - Enables fast filtering by owner: `WHERE user_id = ?`

## Implementation Plan

### Phase 1: Update Models
1. Add UserID field to `Environment` struct in `api/internal/store/models.go`:
   ```go
   type Environment struct {
       ID                   string          `gorm:"primaryKey;type:text" json:"id"`
       UserID               string          `gorm:"index;not null;type:text" json:"userId"`
       Name                 string          `gorm:"index;not null" json:"name"`
       // ... existing fields ...
       
       User                 *User           `gorm:"foreignKey:UserID" json:"user,omitempty"`
       Services             []Service       `gorm:"foreignKey:EnvironmentID" json:"services,omitempty"`
   }
   ```

2. Add UserID field to `Service` struct:
   ```go
   type Service struct {
       ID               string    `gorm:"primaryKey;type:text" json:"id"`
       UserID           string    `gorm:"index;not null;type:text" json:"userId"`
       EnvironmentID    string    `gorm:"index;not null" json:"environmentId"`
       // ... existing fields ...
       
       User             *User       `gorm:"foreignKey:UserID" json:"user,omitempty"`
       Environment      *Environment `gorm:"foreignKey:EnvironmentID" json:"environment,omitempty"`
   }
   ```

3. Add UserID field to `EnvironmentMetadata` struct:
   ```go
   type EnvironmentMetadata struct {
       ID            string `gorm:"primaryKey;type:text"`
       UserID        string `gorm:"index;not null;type:text"`
       EnvironmentID string `gorm:"index;not null"`
       // ... existing fields ...
       
       User          *User        `gorm:"foreignKey:UserID"`
       Environment   *Environment `gorm:"foreignKey:EnvironmentID"`
   }
   ```

### Phase 2: Create Migration Function
Create `api/internal/store/migrations.go` with data cleanup function:
```go
package store

import (
    "github.com/rs/zerolog/log"
    "gorm.io/gorm"
)

// DeleteAllPreAuthData removes all environments, services, and metadata created
// before authentication was implemented. This is necessary because UserID
// foreign key will be added with NOT NULL constraint.
func DeleteAllPreAuthData(db *gorm.DB) error {
    log.Warn().Msg("deleting all pre-authentication data (environments, services, metadata)")
    
    // Delete in order: metadata → services → environments (respects FKs)
    if err := db.Exec("DELETE FROM environment_metadata").Error; err != nil {
        return err
    }
    if err := db.Exec("DELETE FROM services").Error; err != nil {
        return err
    }
    if err := db.Exec("DELETE FROM environments").Error; err != nil {
        return err
    }
    
    log.Info().Msg("successfully deleted all pre-authentication data")
    return nil
}
```

### Phase 3: Update AutoMigrate Logic
Update `store.go` to delete data before migration:
```go
func Open(sqlitePath string) (*gorm.DB, error) {
    if sqlitePath == "" {
        sqlitePath = "mirage.db"
    }
    db, err := gorm.Open(sqlite.Open(sqlitePath), &gorm.Config{})
    if err != nil {
        return nil, err
    }
    
    // Check if User table exists (indicates if this is first run with auth)
    if !db.Migrator().HasTable(&User{}) {
        log.Info().Msg("first run with authentication - User table will be created")
    }
    
    // If Environment table exists but doesn't have UserID column, delete old data
    if db.Migrator().HasTable(&Environment{}) && !db.Migrator().HasColumn(&Environment{}, "user_id") {
        log.Warn().Msg("detected existing data without UserID - deleting for migration")
        if err := DeleteAllPreAuthData(db); err != nil {
            log.Error().Err(err).Msg("failed to delete pre-auth data")
            return nil, err
        }
    }
    
    // Run AutoMigrate with User first, then models with foreign keys
    if err := db.AutoMigrate(&User{}, &Environment{}, &Service{}, &EnvironmentMetadata{}); err != nil {
        return nil, err
    }
    return db, nil
}
```

Apply same logic to `OpenFromURL()`.

### Phase 4: Update Tests
1. Update all tests that create Environments or Services:
   - Create a test User first
   - Set UserID when creating test data
   - Example:
     ```go
     user := User{
         ID: uuid.New().String(),
         ClerkUserID: "user_test123",
         Email: "test@example.com",
         IsActive: true,
         CreatedAt: time.Now(),
         UpdatedAt: time.Now(),
     }
     db.Create(&user)
     
     env := Environment{
         ID: "env-1",
         UserID: user.ID,  // ← Now required
         Name: "test-env",
         Type: EnvironmentTypeDev,
         // ...
     }
     db.Create(&env)
     ```

2. Update test files:
   - `api/internal/store/store_test.go`
   - `api/internal/controller/environment_test.go`
   - `api/internal/controller/services_test.go`

## Verification

### Model Changes Checklist
- [ ] UserID field added to Environment model
- [ ] UserID field added to Service model
- [ ] UserID field added to EnvironmentMetadata model
- [ ] User relationship field added to all three models
- [ ] GORM tags include `index`, `not null`, `foreignKey`
- [ ] JSON tags added for UserID fields

### Migration Checklist
- [ ] Migration function created in `migrations.go`
- [ ] Data deletion logic added to `Open()` and `OpenFromURL()`
- [ ] Migration detects existing data without UserID
- [ ] AutoMigrate runs successfully after data deletion
- [ ] Foreign key constraints enforced by database

### Testing Checklist
- [ ] All existing tests updated to create User first
- [ ] Tests that create Environments now set UserID
- [ ] Tests that create Services now set UserID
- [ ] All tests pass after migration changes
- [ ] Foreign key violations are caught (test creating Environment without UserID fails)

## Test Plan

**Objective**: Verify UserID foreign keys are correctly added and enforced

**Test Scope**: Database schema changes, foreign key constraints, and data integrity

**Environment & Setup**:
- In-memory SQLite database for tests
- GORM AutoMigrate to create schema with foreign keys

**Test Scenarios**:

1. **Fresh Database - User Created First**
   - Given: Empty database
   - When: AutoMigrate runs
   - Then: User, Environment, Service, EnvironmentMetadata tables created with UserID columns

2. **Create Environment with Valid UserID**
   - Given: User exists in database
   - When: Environment created with UserID set to existing user
   - Then: Environment is created successfully

3. **Create Environment without UserID**
   - Given: User exists in database
   - When: Attempt to create Environment without UserID set
   - Then: NOT NULL constraint violation error

4. **Create Environment with Invalid UserID**
   - Given: User with ID "user-123" exists
   - When: Attempt to create Environment with UserID "user-999" (doesn't exist)
   - Then: Foreign key constraint violation error

5. **Filter Environments by UserID**
   - Given: Two users each with multiple environments
   - When: Query `WHERE user_id = ?`
   - Then: Only that user's environments returned

6. **Preload User Relationship**
   - Given: Environment with UserID set
   - When: Query with `.Preload("User")`
   - Then: Environment returned with User data populated

7. **Migration from Existing Data**
   - Given: Database with existing environments (no UserID column)
   - When: OpenFromURL() runs with new model
   - Then: Old data is deleted, new schema created, AutoMigrate succeeds

**Success Criteria**:
- Foreign key constraints enforced
- Cannot create resources without UserID
- Cannot create resources with invalid UserID
- Filtering by UserID works efficiently (index used)
- Preloading relationships works
- Migration handles existing data correctly

## Files Modified

- `api/internal/store/models.go` - Add UserID fields and User relationships to Environment, Service, EnvironmentMetadata
- `api/internal/store/migrations.go` - Create DeleteAllPreAuthData function
- `api/internal/store/store.go` - Add migration logic to detect and delete pre-auth data
- `api/internal/store/store_test.go` - Update tests to create User before other entities
- `api/internal/controller/environment_test.go` - Update environment tests to include UserID
- `api/internal/controller/services_test.go` - Update service tests to include UserID

## Notes

### Migration Safety

**Why Delete All Data?**:
- Existing data has no owner (no users exist yet)
- Cannot assign arbitrary UserID to existing resources
- UserID column must be NOT NULL for data integrity
- This is acceptable because:
  - System is pre-production (test data only)
  - No real user data exists
  - PRD explicitly states: "Delete existing test data (no migration needed)"

**Alternative Approaches Considered**:
1. ❌ Make UserID nullable initially - Defeats purpose of ownership model
2. ❌ Assign all existing data to system user - Creates fake ownership
3. ✅ Delete all data - Clean slate, proper ownership from day one

### Foreign Key Behavior

**On Delete Cascade**:
Consider adding `constraint:OnDelete:CASCADE` to User relationships:
```go
User *User `gorm:"foreignKey:UserID;constraint:OnDelete:CASCADE"`
```

This would automatically delete all user's resources when user is deleted. However:
- PRD specifies soft delete (IsActive flag)
- Hard deleting users should be rare
- Explicitly handling orphaned resources is safer
- **Decision**: Do NOT add cascade delete for now

**On Update Cascade**:
User.ID should never change (UUID), so ON UPDATE CASCADE not needed.

### Index Strategy

**UserID Indexes**:
- Essential for queries like `WHERE user_id = ?`
- Will be heavily used in list operations
- Small overhead on writes, massive benefit on reads

**Composite Indexes** (future optimization):
- `(user_id, created_at)` for paginated lists
- `(user_id, status)` for filtered queries
- Not adding now - optimize later if needed

### Testing Strategy

**Test Data Helpers**:
Consider creating test helper functions:
```go
// test/helpers/fixtures.go
func CreateTestUser(db *gorm.DB, email string) *store.User {
    user := &store.User{
        ID: uuid.New().String(),
        ClerkUserID: "user_test_" + uuid.New().String(),
        Email: email,
        IsActive: true,
        CreatedAt: time.Now(),
        UpdatedAt: time.Now(),
    }
    db.Create(user)
    return user
}
```

This reduces duplication across test files.

### Integration Dependencies

**Task 16-3 Must Complete First**:
- User model must exist before adding foreign keys
- AutoMigrate order matters: User → Environment → Service

**Task 16-5 (Middleware) Will Use This**:
- Middleware loads User and stores in context
- Controllers filter resources by `context.UserID`

**Task 16-7 & 16-8 (Controllers) Will Use This**:
- Environment controller: `WHERE user_id = ?` filters
- Service controller: Verify environment ownership before creating services

### Breaking Changes

**API Breaking Change**:
After this migration, all endpoints that create resources will require:
1. Valid JWT token (task 16-5)
2. User record in database (task 16-6)
3. UserID will be automatically set by controllers

Frontend does NOT send UserID - it's extracted from authenticated session.

