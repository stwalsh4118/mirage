# [16-1] Research and document Clerk Go SDK

[Back to task list](./tasks.md)

## Description

Research the Clerk Go SDK v2 (`github.com/clerk/clerk-sdk-go/v2`) to understand JWT verification patterns, middleware implementation, and best practices. Create a comprehensive implementation guide document (`16-1-clerk-go-guide.md`) that will serve as the authoritative reference for implementing Clerk authentication in the Mirage backend.

This task focuses on understanding:
- How to verify Clerk JWTs in Go
- How to extract user information from verified tokens
- Best practices for middleware implementation with Gin
- Error handling patterns
- Configuration requirements

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-07 00:00:00 | Created | N/A | Proposed | Task file created | AI Agent |

## Requirements

1. **Research Areas**:
   - Clerk Go SDK v2 installation and initialization
   - JWT token verification methods and patterns
   - Public key fetching and caching (JWKS)
   - Claims extraction (user ID, session ID, etc.)
   - Error handling for invalid/expired tokens
   - Gin middleware integration patterns
   - Context propagation for authenticated user data
   - Configuration via environment variables

2. **Documentation Requirements**:
   - Create `docs/delivery/16/16-1-clerk-go-guide.md`
   - Date-stamped with research date
   - Link to official Clerk Go SDK documentation
   - Include code examples for:
     - SDK initialization
     - JWT verification
     - Middleware implementation with Gin
     - Context helpers for extracting user data
     - Error response patterns
   - List required environment variables
   - Note any gotchas or common pitfalls

3. **API Coverage**:
   - `clerk.NewClient()` initialization
   - JWT verification methods
   - User retrieval from verified tokens
   - Session validation
   - Webhook signature verification (for 16-6)

## Implementation Plan

### Phase 1: SDK Discovery
1. Review official Clerk Go SDK v2 documentation:
   - GitHub repository: https://github.com/clerk/clerk-sdk-go
   - Official docs: https://clerk.com/docs/references/backend/overview
   - Package documentation: https://pkg.go.dev/github.com/clerk/clerk-sdk-go/v2
2. Identify key packages and types:
   - Client initialization
   - JWT verification APIs
   - User management APIs
3. Review example projects or code samples from Clerk

### Phase 2: JWT Verification Research
1. Understand JWT verification flow:
   - How to get Clerk public keys (JWKS endpoint)
   - Token validation process
   - Claims structure and extraction
2. Research best practices for:
   - Token caching
   - Key rotation handling
   - Clock skew tolerance
3. Identify configuration needed:
   - Secret key vs publishable key usage
   - JWKS URL configuration
   - Token validation options

### Phase 3: Middleware Pattern Research
1. Study Gin middleware patterns for authentication
2. Determine how to:
   - Extract JWT from Authorization header
   - Verify token using Clerk SDK
   - Load user record from database
   - Store user in Gin context
   - Handle various error cases (401 responses)
3. Research context key patterns for type-safe user retrieval

### Phase 4: Error Handling Patterns
1. Identify error types from Clerk SDK
2. Map to appropriate HTTP status codes:
   - 401 Unauthorized (missing/invalid token)
   - 401 Unauthorized (expired token)
   - 404 Not Found (user not in database)
   - 500 Internal Server Error (SDK errors)
3. Design error response format

### Phase 5: Documentation Creation
1. Create `16-1-clerk-go-guide.md` with sections:
   - Overview and purpose
   - SDK installation (`go get`)
   - Configuration (environment variables)
   - Code examples for each pattern
   - Integration guide for Mirage
   - Common pitfalls and solutions
   - References to official documentation

## Verification

### Research Completeness Checklist
- [ ] Official Clerk Go SDK v2 documentation reviewed
- [ ] JWT verification API understood
- [ ] Middleware pattern for Gin identified
- [ ] User loading from database pattern defined
- [ ] Context propagation pattern determined
- [ ] Error handling patterns documented
- [ ] Required environment variables listed
- [ ] Code examples created for all patterns

### Documentation Quality Checklist
- [ ] Guide document created at correct location
- [ ] Date-stamped with research date
- [ ] Links to official documentation included
- [ ] Code examples are complete and compilable
- [ ] Environment variables clearly listed
- [ ] Integration steps are actionable
- [ ] Common pitfalls section included
- [ ] References section complete

## Test Plan

**Objective**: Validate that the research and documentation are sufficient for implementation

**Test Scope**: Documentation review and example code validation

**Validation Method**:
1. Documentation review confirms all required topics are covered
2. Code examples use correct SDK v2 API calls
3. Environment variables are clearly defined
4. Integration steps are clear and actionable
5. No critical gaps that would block implementation tasks 16-5 and 16-6

**Success Criteria**:
- Guide document is comprehensive and actionable
- Code examples demonstrate key patterns clearly
- Subsequent tasks (16-5, 16-6) can be implemented using only this guide and official docs
- No need to research basic patterns during implementation

## Files Modified

- `docs/delivery/16/16-1-clerk-go-guide.md` - Created comprehensive Clerk Go SDK implementation guide

## Notes

### Key Questions to Answer
1. What is the exact package import path for Clerk Go SDK v2?
2. How do we initialize the Clerk client with just the secret key?
3. What method verifies a JWT and returns user claims?
4. How do we handle expired tokens vs invalid signatures?
5. What's the recommended way to cache JWKS public keys?
6. How do we extract the Clerk user ID from verified token claims?
7. What context keys should we use for storing user data in Gin?
8. How do we verify webhook signatures (needed for task 16-6)?

### Integration Points with Mirage
- Gin framework middleware integration
- GORM User model loading after JWT verification
- Context propagation through request handlers
- Error response format matching existing API patterns
- Environment variable configuration via `internal/config`

### Dependencies for Later Tasks
This research feeds directly into:
- **16-5**: Implement JWT verification middleware (uses JWT patterns)
- **16-6**: Implement webhook handler (uses signature verification)
- **16-10**: Apply middleware to routes (uses middleware pattern)

### External Resources
- Clerk Go SDK: https://github.com/clerk/clerk-sdk-go
- Clerk Backend API Docs: https://clerk.com/docs/references/backend/overview
- JWT Middleware Patterns with Gin: https://github.com/gin-gonic/gin#using-middleware
- Go JWT Libraries: https://github.com/golang-jwt/jwt

