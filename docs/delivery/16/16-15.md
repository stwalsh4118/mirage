# [16-15] Add protected route guards to frontend

[Back to task list](./tasks.md)

## Description

Implement route protection on the frontend to ensure unauthenticated users are redirected to the sign-in page when attempting to access protected pages. Use Clerk's authentication helpers to guard routes at the page level or layout level.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-07 00:00:00 | Created | N/A | Proposed | Task file created | AI Agent |

## Requirements

1. **Protected Routes**:
   - Dashboard/home page (if it shows user data)
   - Environment management pages
   - Service management pages
   - User profile pages
   - Any page that makes authenticated API calls

2. **Public Routes**:
   - Landing page (if separate from dashboard)
   - Sign-in page
   - Sign-up page
   - Health check page

3. **Implementation Strategy**:
   - Use Clerk middleware (preferred for App Router)
   - Or use `<SignedIn>` / `<SignedOut>` components
   - Or check auth in page components with redirect

4. **User Experience**:
   - Redirect to sign-in with return URL
   - Loading state while checking auth
   - No flash of unauthorized content

## Implementation Plan

### Option A: Clerk Middleware (Recommended for App Router)

Update `web/src/middleware.ts`:

```typescript
import { authMiddleware } from "@clerk/nextjs";

export default authMiddleware({
  // Routes that can be accessed while signed out
  publicRoutes: [
    "/",            // Landing page (if public)
    "/sign-in(.*)", // Sign-in and sub-routes
    "/sign-up(.*)", // Sign-up and sub-routes
    "/health",      // Health check
  ],
  
  // Routes that can always be accessed (even signed out)
  ignoredRoutes: [
    "/api/webhooks/clerk", // Webhook endpoint
  ],
});

export const config = {
  // Protect all routes including api routes
  matcher: ["/((?!.+\\.[\\w]+$|_next).*)", "/", "/(api|trpc)(.*)"],
};
```

### Option B: Page-Level Protection with Redirect

Create auth wrapper component:

```typescript
// web/src/components/ProtectedPage.tsx
'use client';

import { useAuth } from '@clerk/nextjs';
import { useRouter } from 'next/navigation';
import { useEffect } from 'react';

export function ProtectedPage({ children }: { children: React.ReactNode }) {
  const { isLoaded, isSignedIn } = useAuth();
  const router = useRouter();
  
  useEffect(() => {
    if (isLoaded && !isSignedIn) {
      // Save current URL for redirect after sign-in
      const currentUrl = window.location.pathname + window.location.search;
      router.push(`/sign-in?redirect_url=${encodeURIComponent(currentUrl)}`);
    }
  }, [isLoaded, isSignedIn, router]);
  
  // Show loading state while checking auth
  if (!isLoaded) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 dark:border-white mx-auto"></div>
          <p className="mt-4 text-gray-600 dark:text-gray-400">Loading...</p>
        </div>
      </div>
    );
  }
  
  // Don't render content if not signed in (will redirect)
  if (!isSignedIn) {
    return null;
  }
  
  return <>{children}</>;
}
```

Use in page:

```typescript
// web/src/app/dashboard/page.tsx
import { ProtectedPage } from '@/components/ProtectedPage';

export default function DashboardPage() {
  return (
    <ProtectedPage>
      <div>
        {/* Dashboard content */}
      </div>
    </ProtectedPage>
  );
}
```

### Option C: Clerk SignedIn/SignedOut Components

```typescript
// web/src/app/page.tsx
import { SignedIn, SignedOut, RedirectToSignIn } from '@clerk/nextjs';

export default function HomePage() {
  return (
    <>
      <SignedIn>
        {/* Content for signed-in users */}
        <Dashboard />
      </SignedIn>
      
      <SignedOut>
        {/* Redirect to sign-in */}
        <RedirectToSignIn />
      </SignedOut>
    </>
  );
}
```

### Phase 2: Add Loading States
Create loading component:

```typescript
// web/src/components/AuthLoading.tsx
export function AuthLoading() {
  return (
    <div className="flex items-center justify-center min-h-screen bg-gray-50 dark:bg-gray-900">
      <div className="text-center">
        <div className="inline-block">
          <div className="animate-spin rounded-full h-16 w-16 border-4 border-gray-300 border-t-blue-600"></div>
        </div>
        <h2 className="mt-4 text-lg font-medium text-gray-900 dark:text-white">
          Loading...
        </h2>
        <p className="mt-2 text-sm text-gray-600 dark:text-gray-400">
          Verifying authentication
        </p>
      </div>
    </div>
  );
}
```

### Phase 3: Handle Return URL After Sign-In
Update sign-in page to handle redirects:

```typescript
// web/src/app/sign-in/[[...sign-in]]/page.tsx
import { SignIn } from "@clerk/nextjs";

export default function SignInPage({
  searchParams,
}: {
  searchParams: { redirect_url?: string };
}) {
  const redirectUrl = searchParams.redirect_url || "/";
  
  return (
    <div className="flex min-h-screen items-center justify-center">
      <SignIn
        routing="path"
        path="/sign-in"
        signUpUrl="/sign-up"
        afterSignInUrl={redirectUrl}
      />
    </div>
  );
}
```

## Verification

### Route Protection Checklist
- [ ] Middleware configured (if using Option A)
- [ ] Protected pages redirect when not signed in
- [ ] Public pages accessible without auth
- [ ] Return URL preserved in redirect
- [ ] After sign-in, user redirected back to original page

### UX Checklist
- [ ] Loading state shows while checking auth
- [ ] No flash of protected content
- [ ] Smooth redirects (no jarring jumps)
- [ ] Clear loading messages

### Security Checklist
- [ ] Cannot access protected pages without auth
- [ ] Cannot bypass protection with direct URLs
- [ ] API calls protected (from task 16-13)
- [ ] No sensitive data in public routes

## Test Plan

**Objective**: Verify route protection works correctly

**Test Scope**: Route guards, redirects, loading states

**Manual Testing Steps**:

1. **Access Protected Page While Signed Out**:
   - Sign out (if signed in)
   - Navigate to `/dashboard` (or any protected page)
   - Verify redirected to `/sign-in`
   - Verify redirect_url in query params

2. **Sign In and Return to Original Page**:
   - From sign-in page (with redirect_url)
   - Sign in
   - Verify redirected back to original page
   - Verify page loads correctly

3. **Access Public Pages**:
   - Sign out
   - Navigate to public pages (/, /health)
   - Verify accessible without redirect

4. **Test Direct URL Access**:
   - Sign out
   - Paste protected page URL directly
   - Verify redirected to sign-in

5. **Test While Signed In**:
   - Sign in
   - Navigate to protected pages
   - Verify pages load without redirect
   - Verify content displays

6. **Test Loading States**:
   - Slow down network (DevTools)
   - Navigate to protected page
   - Verify loading state shows
   - Verify content appears after auth check

**Success Criteria**:
- Protected pages require authentication
- Public pages remain accessible
- Redirects preserve return URL
- No unauthorized access possible
- Good UX with loading states

## Files Modified

- `web/src/middleware.ts` - Configure Clerk middleware (Option A)
- `web/src/components/ProtectedPage.tsx` - Create protected page wrapper (Option B)
- `web/src/components/AuthLoading.tsx` - Create loading component
- `web/src/app/sign-in/[[...sign-in]]/page.tsx` - Handle return URL

## Notes

### Clerk Middleware Features

**Auto-Protection**:
- Protects routes by default
- Specify public routes
- Ignore specific routes (webhooks)

**Redirect Behavior**:
- Automatically redirects to sign-in
- Preserves return URL
- Configurable redirect URLs

### Loading State Best Practices

**Why Show Loading**:
- Auth check takes time (network, token verification)
- Better UX than blank screen
- Prevents flash of unauthenticated content

**Loading Duration**:
- Usually < 500ms
- May be longer on slow connections
- Show loading immediately (no delay)

### Return URL Security

**Validation**:
- Validate return URL is internal
- Prevent open redirect vulnerabilities
- Check URL starts with `/`

**Example Validation**:
```typescript
function getSafeRedirectUrl(url: string): string {
  // Only allow internal URLs
  if (!url.startsWith('/')) {
    return '/';
  }
  // Prevent protocol-relative URLs
  if (url.startsWith('//')) {
    return '/';
  }
  return url;
}
```

### App Router vs Pages Router

**App Router** (current Mirage setup):
- Use middleware for route protection
- Or use page-level checks
- Server components need different approach

**Pages Router**:
- Use `getServerSideProps` with `auth()`
- Or client-side protection
- Different patterns

### Alternative: Server-Side Protection

For App Router Server Components:

```typescript
// app/dashboard/page.tsx
import { auth } from '@clerk/nextjs';
import { redirect } from 'next/navigation';

export default function DashboardPage() {
  const { userId } = auth();
  
  if (!userId) {
    redirect('/sign-in');
  }
  
  return <div>Dashboard</div>;
}
```

### Performance Considerations

**Client-Side Checks**:
- Fast for returning users (cached)
- May flash loading state
- Good for SPA-like experience

**Server-Side Checks**:
- No loading flash
- Better SEO
- Slower initial load

**Recommendation**: Use middleware (best of both worlds)

### Mobile Considerations

**Navigation**:
- Back button should work correctly
- History management
- Deep linking support

**Loading States**:
- Appropriate size for mobile
- Don't block entire screen
- Allow background taps (if modal)

### Integration Dependencies

**Requires**:
- Task 16-11: Clerk SDK installed
- Task 16-12: Sign-in page for redirects
- Task 16-13: API authentication

**Completes**:
- Frontend authentication implementation
- All protected pages secured
- Ready for E2E testing

**Testing**:
- Task 16-20: E2E tests verify route protection

