# [16-19] Write integration tests for ownership checks

[Back to task list](./tasks.md)

## Description

Write integration tests to verify resource ownership is correctly enforced across all controllers. Test that users can only access their own resources and receive appropriate error responses when attempting to access others' resources.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-07 00:00:00 | Created | N/A | Proposed | Task file created | AI Agent |

## Requirements

1. **Environment Ownership Tests**:
   - Test creating environment (UserID set automatically)
   - Test user can view own environment
   - Test user cannot view other user's environment
   - Test user can delete own environment
   - Test user cannot delete other user's environment

2. **Service Ownership Tests**:
   - Test creating service in own environment
   - Test cannot create service in other user's environment
   - Test user can view own services
   - Test user cannot view other user's services
   - Test user can delete own services
   - Test user cannot delete other user's services

3. **Test Fixtures**:
   - Create multiple test users
   - Create resources for each user
   - Test cross-user access attempts

4. **Test Coverage**:
   - All controller endpoints with ownership checks
   - All error response codes (403, 404)
   - Resource isolation verified

## Implementation Plan

### Phase 1: Create Test File
Create `api/internal/controller/ownership_test.go`:

```go
package controller

import (
    "bytes"
    "encoding/json"
    "net/http"
    "net/http/httptest"
    "testing"
    "time"
    
    "github.com/gin-gonic/gin"
    "github.com/google/uuid"
    "github.com/stwalsh4118/mirageapi/internal/store"
    "gorm.io/driver/sqlite"
    "gorm.io/gorm"
)

func setupTestDBWithUsers(t *testing.T) (*gorm.DB, *store.User, *store.User) {
    db, err := gorm.Open(sqlite.Open(":memory:"), &gorm.Config{})
    if err != nil {
        t.Fatalf("failed to open test database: %v", err)
    }
    
    if err := db.AutoMigrate(&store.User{}, &store.Environment{}, &store.Service{}); err != nil {
        t.Fatalf("failed to migrate: %v", err)
    }
    
    // Create two test users
    user1 := &store.User{
        ID:          uuid.New().String(),
        ClerkUserID: "user_test1",
        Email:       "user1@example.com",
        IsActive:    true,
        CreatedAt:   time.Now(),
        UpdatedAt:   time.Now(),
    }
    
    user2 := &store.User{
        ID:          uuid.New().String(),
        ClerkUserID: "user_test2",
        Email:       "user2@example.com",
        IsActive:    true,
        CreatedAt:   time.Now(),
        UpdatedAt:   time.Now(),
    }
    
    db.Create(user1)
    db.Create(user2)
    
    t.Cleanup(func() {
        sqlDB, _ := db.DB()
        sqlDB.Close()
    })
    
    return db, user1, user2
}

func setAuthenticatedUser(c *gin.Context, user *store.User) {
    c.Set("auth:user", user)
}

func TestEnvironment_Ownership_Create(t *testing.T) {
    db, user1, _ := setupTestDBWithUsers(t)
    
    controller := &EnvironmentController{DB: db}
    
    // Create environment as user1
    gin.SetMode(gin.TestMode)
    w := httptest.NewRecorder()
    c, _ := gin.CreateTestContext(w)
    
    setAuthenticatedUser(c, user1)
    
    payload := map[string]interface{}{
        "projectId": "proj_123",
        "name":      "test-env",
    }
    payloadBytes, _ := json.Marshal(payload)
    c.Request = httptest.NewRequest("POST", "/api/v1/provision/environment", bytes.NewReader(payloadBytes))
    
    controller.ProvisionEnvironment(c)
    
    // Parse response
    var response map[string]interface{}
    json.Unmarshal(w.Body.Bytes(), &response)
    envID := response["environmentId"].(string)
    
    // Verify environment created with user1's ID
    var env store.Environment
    db.First(&env, "id = ?", envID)
    
    if env.UserID != user1.ID {
        t.Errorf("expected UserID %s, got %s", user1.ID, env.UserID)
    }
}

func TestEnvironment_Ownership_CannotViewOthers(t *testing.T) {
    db, user1, user2 := setupTestDBWithUsers(t)
    
    // Create environment owned by user1
    env := &store.Environment{
        ID:                   uuid.New().String(),
        UserID:               user1.ID,
        Name:                 "user1-env",
        Type:                 store.EnvironmentTypeDev,
        RailwayEnvironmentID: "railway_env_123",
        CreatedAt:            time.Now(),
        UpdatedAt:            time.Now(),
    }
    db.Create(env)
    
    controller := &EnvironmentController{DB: db}
    
    // Try to access as user2
    gin.SetMode(gin.TestMode)
    w := httptest.NewRecorder()
    c, _ := gin.CreateTestContext(w)
    c.Params = gin.Params{{Key: "id", Value: env.RailwayEnvironmentID}}
    
    setAuthenticatedUser(c, user2)
    
    controller.GetEnvironmentMetadata(c)
    
    // Should return 404 (not 403 to avoid info disclosure)
    if w.Code != http.StatusNotFound {
        t.Errorf("expected 404, got %d", w.Code)
    }
}

func TestEnvironment_Ownership_CanViewOwn(t *testing.T) {
    db, user1, _ := setupTestDBWithUsers(t)
    
    // Create environment owned by user1
    env := &store.Environment{
        ID:                   uuid.New().String(),
        UserID:               user1.ID,
        Name:                 "user1-env",
        Type:                 store.EnvironmentTypeDev,
        RailwayEnvironmentID: "railway_env_123",
        CreatedAt:            time.Now(),
        UpdatedAt:            time.Now(),
    }
    db.Create(env)
    
    // Create metadata
    metadata := &store.EnvironmentMetadata{
        ID:            uuid.New().String(),
        UserID:        user1.ID,
        EnvironmentID: env.ID,
        CreatedAt:     time.Now(),
        UpdatedAt:     time.Now(),
    }
    db.Create(metadata)
    
    controller := &EnvironmentController{DB: db}
    
    // Access as user1
    gin.SetMode(gin.TestMode)
    w := httptest.NewRecorder()
    c, _ := gin.CreateTestContext(w)
    c.Params = gin.Params{{Key: "id", Value: env.RailwayEnvironmentID}}
    
    setAuthenticatedUser(c, user1)
    
    controller.GetEnvironmentMetadata(c)
    
    // Should return 200
    if w.Code != http.StatusOK {
        t.Errorf("expected 200, got %d", w.Code)
    }
}

func TestService_Ownership_CannotCreateInOthersEnvironment(t *testing.T) {
    db, user1, user2 := setupTestDBWithUsers(t)
    
    // Create environment owned by user1
    env := &store.Environment{
        ID:                   uuid.New().String(),
        UserID:               user1.ID,
        Name:                 "user1-env",
        Type:                 store.EnvironmentTypeDev,
        RailwayEnvironmentID: "railway_env_123",
        CreatedAt:            time.Now(),
        UpdatedAt:            time.Now(),
    }
    db.Create(env)
    
    controller := &ServicesController{DB: db}
    
    // Try to create service as user2
    gin.SetMode(gin.TestMode)
    w := httptest.NewRecorder()
    c, _ := gin.CreateTestContext(w)
    
    setAuthenticatedUser(c, user2)
    
    payload := map[string]interface{}{
        "projectId":     "proj_123",
        "environmentId": env.ID,
        "services": []map[string]interface{}{
            {
                "name":   "test-service",
                "repo":   "github.com/test/repo",
                "branch": "main",
            },
        },
    }
    payloadBytes, _ := json.Marshal(payload)
    c.Request = httptest.NewRequest("POST", "/api/v1/provision/services", bytes.NewReader(payloadBytes))
    
    controller.ProvisionServices(c)
    
    // Should return 403 (forbidden - user2 doesn't own environment)
    if w.Code != http.StatusForbidden {
        t.Errorf("expected 403, got %d", w.Code)
    }
}

func TestService_Ownership_CannotViewOthers(t *testing.T) {
    db, user1, user2 := setupTestDBWithUsers(t)
    
    // Create service owned by user1
    service := &store.Service{
        ID:               uuid.New().String(),
        UserID:           user1.ID,
        EnvironmentID:    "env_123",
        Name:             "user1-service",
        RailwayServiceID: "railway_svc_123",
        CreatedAt:        time.Now(),
        UpdatedAt:        time.Now(),
    }
    db.Create(service)
    
    controller := &ServicesController{DB: db}
    
    // Try to access as user2
    gin.SetMode(gin.TestMode)
    w := httptest.NewRecorder()
    c, _ := gin.CreateTestContext(w)
    c.Params = gin.Params{{Key: "id", Value: service.ID}}
    
    setAuthenticatedUser(c, user2)
    
    controller.GetService(c)
    
    // Should return 404
    if w.Code != http.StatusNotFound {
        t.Errorf("expected 404, got %d", w.Code)
    }
}

func TestService_Ownership_CanViewOwn(t *testing.T) {
    db, user1, _ := setupTestDBWithUsers(t)
    
    // Create service owned by user1
    service := &store.Service{
        ID:               uuid.New().String(),
        UserID:           user1.ID,
        EnvironmentID:    "env_123",
        Name:             "user1-service",
        RailwayServiceID: "railway_svc_123",
        DeploymentType:   store.DeploymentTypeSourceRepo,
        ExposedPortsJSON: "[]",
        CreatedAt:        time.Now(),
        UpdatedAt:        time.Now(),
    }
    db.Create(service)
    
    controller := &ServicesController{DB: db}
    
    // Access as user1
    gin.SetMode(gin.TestMode)
    w := httptest.NewRecorder()
    c, _ := gin.CreateTestContext(w)
    c.Params = gin.Params{{Key: "id", Value: service.ID}}
    
    setAuthenticatedUser(c, user1)
    
    controller.GetService(c)
    
    // Should return 200
    if w.Code != http.StatusOK {
        t.Errorf("expected 200, got %d: %s", w.Code, w.Body.String())
    }
}
```

### Phase 2: Run Tests
```bash
cd api/internal/controller
go test -v -run Ownership
go test -cover
```

## Verification

### Test Coverage Checklist
- [ ] Environment creation sets UserID
- [ ] Users can view own environments
- [ ] Users cannot view other users' environments
- [ ] Service creation verifies environment ownership
- [ ] Users can view own services
- [ ] Users cannot view other users' services
- [ ] Appropriate error codes (403, 404)

### Resource Isolation Checklist
- [ ] User1 resources isolated from User2
- [ ] No data leakage between users
- [ ] Database constraints enforced
- [ ] Foreign keys work correctly

## Test Plan

**Objective**: Verify resource ownership is enforced

**Test Scope**: Integration tests with multiple users

**Key Test Scenarios**: All implemented as Go test functions

**Success Criteria**:
- All tests pass
- Resource isolation verified
- Appropriate error responses
- No unauthorized access possible

## Files Modified

- `api/internal/controller/ownership_test.go` - Create ownership integration tests

## Notes

### Multiple User Testing

**Pattern**:
- Create 2+ test users
- Create resources for each
- Test cross-user access
- Verify isolation

### Error Code Strategy

**404 vs 403**:
- Use 404 for read operations (don't reveal existence)
- Use 403 for write operations (ownership clear)

### Integration Dependencies

**Requires**:
- Task 16-7: Environment ownership implemented
- Task 16-8: Service ownership implemented
- Task 16-4: UserID foreign keys

**Prepares For**:
- Task 16-20: E2E tests build on these

