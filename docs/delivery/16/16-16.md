# [16-16] Update environment and service creation flows with user context

[Back to task list](./tasks.md)

## Description

Update the environment and service creation wizard to work with authenticated users. Ensure API calls use authenticated fetch, remove any UserID fields from payloads (backend sets from context), and verify the wizard works end-to-end with the new authentication system.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-07 00:00:00 | Created | N/A | Proposed | Task file created | AI Agent |

## Requirements

1. **Remove UserID from Frontend**:
   - Don't send UserID in API requests
   - Backend extracts from authenticated context
   - Clean up any UserID-related UI code

2. **Use Authenticated API Client**:
   - All wizard API calls use authenticated fetch
   - JWT token sent automatically
   - Handle 401 errors gracefully

3. **Wizard Flow Updates**:
   - Provision project: Use authenticated fetch
   - Provision environment: Use authenticated fetch
   - Provision services: Use authenticated fetch
   - Discovery: Use authenticated fetch

4. **Error Handling**:
   - Handle authentication failures
   - Show appropriate error messages
   - Redirect to sign-in if needed

5. **User Experience**:
   - No visible changes to wizard flow
   - Authentication happens transparently
   - Created resources owned by authenticated user

## Implementation Plan

### Phase 1: Update Wizard Store API Calls
Update `web/src/store/wizard.ts`:

```typescript
import { useAuthenticatedFetch } from '@/hooks/useAuthenticatedFetch';

// In wizard store (if using Zustand with hooks)
// Or create wrapper functions

export async function provisionProjectWithAuth(fetch: any, data: any) {
  const response = await fetch('/api/v1/provision/project', {
    method: 'POST',
    body: JSON.stringify({
      name: data.newProjectName,
      environmentName: data.defaultEnvironmentName,
    }),
  });
  return response;
}

export async function provisionEnvironmentWithAuth(fetch: any, data: any) {
  const response = await fetch('/api/v1/provision/environment', {
    method: 'POST',
    body: JSON.stringify({
      projectId: data.projectId,
      name: data.environmentName,
      envType: data.templateKind,
      wizardInputs: data.wizardInputs,
      // Note: No userId field - backend sets from auth context
    }),
  });
  return response;
}

export async function provisionServicesWithAuth(fetch: any, data: any) {
  const response = await fetch('/api/v1/provision/services', {
    method: 'POST',
    body: JSON.stringify({
      projectId: data.projectId,
      environmentId: data.environmentId,
      railwayEnvironmentId: data.railwayEnvironmentId,
      services: data.services,
      // Note: No userId field - backend sets from auth context
    }),
  });
  return response;
}
```

### Phase 2: Update Wizard Component
Update wizard dialog component:

```typescript
// web/src/components/wizard/CreateEnvironmentDialog.tsx
import { useAuthenticatedFetch } from '@/hooks/useAuthenticatedFetch';

export function CreateEnvironmentDialog(props: CreateEnvironmentDialogProps) {
  const fetch = useAuthenticatedFetch();
  const wizard = useWizardStore();
  
  const handleProvision = async () => {
    try {
      wizard.setState({ isProvisioning: true });
      
      // Step 1: Create/select project
      let projectId = wizard.existingProjectId;
      if (!projectId) {
        const projectRes = await provisionProjectWithAuth(fetch, {
          newProjectName: wizard.newProjectName,
          defaultEnvironmentName: wizard.defaultEnvironmentName,
        });
        projectId = projectRes.projectId;
      }
      
      // Step 2: Create environment
      const envRes = await provisionEnvironmentWithAuth(fetch, {
        projectId,
        environmentName: wizard.environmentName,
        templateKind: wizard.templateKind,
        wizardInputs: wizard.getAllInputs(),
      });
      
      // Step 3: Create services
      if (wizard.selectedServiceIndices.length > 0) {
        await provisionServicesWithAuth(fetch, {
          projectId,
          environmentId: envRes.environmentId,
          railwayEnvironmentId: envRes.railwayEnvironmentId,
          services: wizard.getSelectedServices(),
        });
      }
      
      // Success!
      wizard.setState({ isProvisioning: false });
      onSuccess?.();
    } catch (error) {
      console.error('Provision failed:', error);
      wizard.setState({
        isProvisioning: false,
        error: error instanceof Error ? error.message : 'Provision failed',
      });
    }
  };
  
  return (
    <Dialog {...props}>
      {/* Wizard UI */}
      <button onClick={handleProvision}>
        Create Environment
      </button>
    </Dialog>
  );
}
```

### Phase 3: Update Discovery API Calls
Update discovery controller:

```typescript
// web/src/lib/api/discovery.ts
import { useAuthenticatedFetch } from '@/hooks/useAuthenticatedFetch';

export async function discoverDockerfilesWithAuth(
  fetch: any,
  body: DiscoveryRequest
): Promise<DiscoveryResults> {
  return fetch<DiscoveryResults>('/api/v1/discovery/dockerfiles', {
    method: 'POST',
    body: JSON.stringify(body),
  });
}
```

Use in component:

```typescript
const fetch = useAuthenticatedFetch();
const results = await discoverDockerfilesWithAuth(fetch, {
  repoUrl: wizard.repositoryUrl,
  branch: wizard.repositoryBranch,
  githubToken: wizard.githubToken,
});
```

### Phase 4: Remove UserID References
Search and remove any UserID-related code:

```bash
# Search for userId in frontend
grep -r "userId" web/src
grep -r "user_id" web/src

# Remove any:
# - userId fields in request payloads
# - userId state in wizard store
# - userId props in components
```

### Phase 5: Update Error Handling
Add authentication-specific error handling:

```typescript
try {
  await provisionEnvironmentWithAuth(fetch, data);
} catch (error) {
  if (error instanceof Error) {
    if (error.message.includes('401')) {
      // Authentication failed - redirect
      window.location.href = '/sign-in';
    } else if (error.message.includes('403')) {
      // Authorization failed
      toast.error('You do not have permission to perform this action');
    } else {
      // Other errors
      toast.error(error.message);
    }
  }
}
```

## Verification

### API Call Checklist
- [ ] All wizard API calls use authenticated fetch
- [ ] No UserID in request payloads
- [ ] JWT tokens sent with all requests
- [ ] Error handling for auth failures

### Wizard Flow Checklist
- [ ] Project creation works
- [ ] Environment creation works
- [ ] Service creation works
- [ ] Discovery works
- [ ] End-to-end flow completes successfully

### Resource Ownership Checklist
- [ ] Created environments owned by authenticated user
- [ ] Created services owned by authenticated user
- [ ] Resources visible in user's list
- [ ] Resources not visible to other users

## Test Plan

**Objective**: Verify wizard works with authentication

**Test Scope**: Full wizard flow with authenticated user

**Manual Testing Steps**:

1. **Sign In**:
   - Sign in to application
   - Verify signed in (profile button visible)

2. **Open Wizard**:
   - Click "Create Environment" button
   - Verify wizard opens

3. **Complete Wizard Flow**:
   - Select/create project
   - Enter repository URL
   - Run discovery
   - Select services
   - Configure environment
   - Click "Create"

4. **Verify Creation**:
   - Wait for provision to complete
   - Verify environment created
   - Verify services created
   - Check backend logs for UserID

5. **Verify Ownership**:
   - List environments via API
   - Verify new environment in list
   - Sign in as different user
   - Verify environment NOT in their list

6. **Test Error Cases**:
   - Start wizard while signed out
   - Verify redirected to sign-in
   - Try with expired token (if possible)
   - Verify appropriate error handling

**Success Criteria**:
- Complete wizard flow works with auth
- Resources owned by authenticated user
- No UserID in request payloads
- Error handling works correctly

## Files Modified

- `web/src/store/wizard.ts` - Update API calls to use authenticated fetch
- `web/src/components/wizard/CreateEnvironmentDialog.tsx` - Use authenticated fetch hook
- `web/src/lib/api/discovery.ts` - Update discovery API calls
- Remove any files/code with UserID fields (if any)

## Notes

### Backend Sets UserID

**Important**: Frontend never sends UserID
- Backend extracts from JWT
- Set in authenticated middleware
- Controllers use `GetCurrentUserID()`
- Automatic and secure

### Transparent Authentication

**User Perspective**:
- Wizard looks the same
- No visible auth fields
- No "sign in to continue" prompts
- Just worksâ„¢

### Error Scenarios

**401 Unauthorized**:
- Token missing or invalid
- Action: Redirect to sign-in
- Save wizard state (optional)

**403 Forbidden**:
- Authenticated but not authorized
- Example: Try to create service in another user's environment
- Action: Show error message

**500 Server Error**:
- Backend error
- Action: Show generic error
- User can retry

### Wizard State Persistence

**Optional Enhancement** (not in scope):
- Save wizard state to localStorage
- Restore after sign-in redirect
- Better UX for interrupted flows

**Example**:
```typescript
// Before redirect
localStorage.setItem('wizardState', JSON.stringify(wizard.getState()));

// After sign-in
const savedState = localStorage.getItem('wizardState');
if (savedState) {
  wizard.setState(JSON.parse(savedState));
  localStorage.removeItem('wizardState');
}
```

### Testing Considerations

**Manual Testing**:
- Test complete flow multiple times
- Test with different users
- Verify ownership isolation

**Automated Testing** (task 16-20):
- E2E test for wizard flow
- Create environment as user A
- Verify user B cannot see it

### Integration Dependencies

**Requires**:
- Task 16-13: Authenticated fetch hook
- Task 16-7/16-8: Backend ownership checks
- Task 16-10: Backend middleware applied

**Completes**:
- Frontend authentication integration
- All user-facing flows work with auth
- Ready for full E2E testing

**Testing**:
- Task 16-20: E2E CoS test verifies complete flow

