# [16-2] Setup Clerk application and configure webhooks

[Back to task list](./tasks.md)

## Description

Create Clerk application accounts for development and production environments, configure authentication settings, and set up webhook endpoints to sync user data with the Mirage database. This task establishes the Clerk infrastructure that all other authentication tasks depend on.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-07 00:00:00 | Created | N/A | Proposed | Task file created | AI Agent |

## Requirements

1. **Clerk Account Setup**:
   - Create Clerk account at https://clerk.com
   - Create application for "Mirage" platform
   - Set up separate instances for development and production (or use dev for both initially)

2. **Authentication Configuration**:
   - Enable email/password authentication
   - Configure session token expiration (default 7 days)
   - Set up JWT template for API tokens
   - Configure allowed redirect URLs

3. **Webhook Configuration**:
   - Create webhook endpoint pointing to Mirage backend
   - Subscribe to events:
     - `user.created`
     - `user.updated`
     - `user.deleted`
   - Configure webhook signing secret for verification
   - Set up webhook delivery retry policy

4. **Environment Variables**:
   - Document all required environment variables
   - Create `.env.example` with placeholders
   - Set up local `.env` for development

5. **API Keys and Secrets**:
   - Frontend publishable key: `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY`
   - Backend secret key: `CLERK_SECRET_KEY`
   - Webhook signing secret: `CLERK_WEBHOOK_SECRET`
   - Store securely (not in git)

## Implementation Plan

### Phase 1: Create Clerk Application
1. Sign up at https://clerk.com
2. Create new application:
   - Application name: "Mirage"
   - Select "Email" and "Password" authentication methods
   - Choose region closest to deployment (or US for global)
3. Note the Application ID for reference

### Phase 2: Configure Authentication Settings
1. Navigate to "User & Authentication" settings:
   - Enable email verification (recommended)
   - Enable password requirements (min 8 chars)
   - Configure session duration (default 7 days is good)
2. Navigate to "JWT Templates":
   - Use default template (includes standard claims)
   - Verify `sub` claim contains user ID
   - Verify `iat`, `exp` claims are present

### Phase 3: Set Up Webhook Endpoint
1. Navigate to "Webhooks" in Clerk dashboard
2. Click "Add Endpoint"
3. Configure webhook:
   - **Endpoint URL**: 
     - Dev: `http://localhost:8090/api/webhooks/clerk` (use ngrok for testing)
     - Prod: `https://api.mirage.yourdomain.com/api/webhooks/clerk`
   - **Description**: "Mirage user sync"
   - **Subscribe to events**:
     - ✅ `user.created`
     - ✅ `user.updated`
     - ✅ `user.deleted`
   - **Signing Secret**: Copy and save securely (needed for verification)

4. For local development, use ngrok:
   ```bash
   ngrok http 8090
   # Use the ngrok URL for webhook endpoint
   # Example: https://abc123.ngrok.io/api/webhooks/clerk
   ```

### Phase 4: Configure Allowed Redirect URLs
1. Navigate to "Paths" in Clerk dashboard
2. Add allowed redirect URLs:
   - Dev: `http://localhost:3000/*`
   - Prod: `https://mirage.yourdomain.com/*`
3. Configure sign-in and sign-up paths:
   - Sign-in URL: `/sign-in`
   - Sign-up URL: `/sign-up`
   - After sign-in redirect: `/`
   - After sign-up redirect: `/`

### Phase 5: Extract and Document API Keys
1. Navigate to "API Keys" in Clerk dashboard
2. Copy the following keys:
   - **Publishable Key** (starts with `pk_test_` or `pk_live_`)
   - **Secret Key** (starts with `sk_test_` or `sk_live_`)
3. Copy webhook signing secret from webhook configuration
4. DO NOT commit these to git

### Phase 6: Create Environment Variable Files
1. Create `.env.example` in project root:
   ```bash
   # Clerk Frontend (Next.js)
   NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_xxxxx
   NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
   NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up
   NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/
   NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/
   
   # Clerk Backend (Go API)
   CLERK_SECRET_KEY=sk_test_xxxxx
   CLERK_WEBHOOK_SECRET=whsec_xxxxx
   ```

2. Create actual `.env` file with real values (gitignored)

3. Update `.gitignore` to ensure `.env` is excluded:
   ```
   .env
   .env.local
   .env.*.local
   ```

### Phase 7: Document Setup Process
Create `docs/setup/clerk-setup.md` with:
- Step-by-step Clerk dashboard setup
- How to obtain API keys
- Webhook configuration steps
- Local development with ngrok
- Production deployment considerations
- Troubleshooting common issues

## Verification

### Clerk Application Checklist
- [ ] Clerk account created
- [ ] Application created with name "Mirage"
- [ ] Email/password authentication enabled
- [ ] Session settings configured
- [ ] JWT template verified

### Webhook Configuration Checklist
- [ ] Webhook endpoint added in Clerk dashboard
- [ ] All required events subscribed (user.created, user.updated, user.deleted)
- [ ] Webhook signing secret obtained
- [ ] Endpoint URL is correct (dev or prod)
- [ ] For local dev: ngrok tunnel set up

### Environment Variables Checklist
- [ ] `.env.example` created with all required variables
- [ ] `.env` created with actual keys (not committed)
- [ ] `.gitignore` updated to exclude `.env` files
- [ ] Publishable key starts with `pk_test_` or `pk_live_`
- [ ] Secret key starts with `sk_test_` or `sk_live_`
- [ ] Webhook secret starts with `whsec_`

### Redirect URLs Checklist
- [ ] Development URLs configured (localhost:3000)
- [ ] Production URLs configured (when available)
- [ ] Sign-in path set to `/sign-in`
- [ ] Sign-up path set to `/sign-up`

### Documentation Checklist
- [ ] Setup guide created in `docs/setup/clerk-setup.md`
- [ ] All steps documented clearly
- [ ] Screenshots included (optional but helpful)
- [ ] Troubleshooting section included

## Test Plan

**Objective**: Verify Clerk application is correctly configured and ready for integration

**Test Scope**: Configuration validation and webhook connectivity

**Manual Testing Steps**:

1. **Verify Publishable Key**:
   - Key format is correct (starts with `pk_test_` or `pk_live_`)
   - Key is copied to `.env` file
   - Frontend can load Clerk SDK with this key

2. **Verify Secret Key**:
   - Key format is correct (starts with `sk_test_` or `sk_live_`)
   - Key is copied to `.env` file
   - Backend can initialize Clerk client

3. **Test Webhook Endpoint Reachability**:
   - Use Clerk dashboard "Test" button to send test webhook
   - Verify endpoint receives the webhook (check logs)
   - Verify webhook signature can be validated (task 16-6)

4. **Test Authentication Flow** (after frontend integration):
   - Visit sign-up page
   - Create test account
   - Verify redirect back to app
   - Verify JWT token is issued

**Success Criteria**:
- All API keys obtained and documented
- Webhook endpoint configured and reachable
- Environment variables properly set up
- Documentation is clear and complete
- No keys committed to git

## Files Modified

- `.env.example` - Create template with all Clerk environment variables
- `.env` - Create with actual keys (gitignored)
- `.gitignore` - Ensure .env files are excluded
- `docs/setup/clerk-setup.md` - Create comprehensive setup guide

## Notes

### Clerk Dashboard Navigation

**Key Sections**:
- **User & Authentication**: Configure auth methods, session settings
- **JWT Templates**: View/customize JWT claims
- **API Keys**: Get publishable and secret keys
- **Webhooks**: Configure webhook endpoints and events
- **Paths**: Set redirect URLs and custom paths

### Development vs Production

**Development**:
- Use test keys (`pk_test_`, `sk_test_`)
- Webhook endpoint via ngrok tunnel
- More lenient settings for testing
- Email verification optional

**Production**:
- Use live keys (`pk_live_`, `sk_live_`)
- Webhook endpoint at production URL
- Enable all security features
- Email verification required
- Set up custom domain (optional)

### Webhook Events

**user.created**:
- Fired when new user signs up
- Payload includes: id, email, first_name, last_name, profile_image_url
- Mirage creates User record in database

**user.updated**:
- Fired when user profile changes (name, email, image)
- Payload includes updated fields
- Mirage updates User record

**user.deleted**:
- Fired when user is deleted in Clerk
- Mirage sets IsActive=false (soft delete)
- Resources remain but user cannot access

### Webhook Delivery

**Retry Policy**:
- Clerk retries failed webhooks automatically
- Exponential backoff (immediate, 5s, 5m, 30m, 2h, 5h, 10h)
- Maximum 7 retry attempts
- Can manually replay from dashboard

**Idempotency**:
- Webhooks may be delivered multiple times
- Use webhook ID to deduplicate
- Webhook handler must be idempotent (task 16-6)

### Local Development with ngrok

**Setup ngrok**:
```bash
# Install ngrok
brew install ngrok  # or download from ngrok.com

# Start tunnel
ngrok http 8090

# Copy forwarding URL (e.g., https://abc123.ngrok.io)
# Use in Clerk webhook configuration
```

**Alternative: clerk webhook testing**:
- Use Clerk CLI for local webhook testing
- Or use test events from dashboard

### Security Best Practices

**API Key Storage**:
- ✅ Store in environment variables
- ✅ Use `.env` file (gitignored)
- ✅ Never commit to git
- ✅ Rotate keys if exposed
- ❌ Don't hardcode in source
- ❌ Don't log keys

**Webhook Secret**:
- Used to verify webhook authenticity
- Must match between Clerk and backend
- Treat as sensitive as API keys

### Production Deployment Considerations

**Environment Variables**:
- Set in production environment (Railway, Vercel, etc.)
- Use platform's secret management
- Backend: Railway environment variables
- Frontend: Vercel environment variables

**Webhook URL**:
- Must be publicly accessible
- HTTPS required for production
- Configure after deploying backend
- Update in Clerk dashboard

**Custom Domain** (optional):
- Configure custom domain in Clerk
- Use for branded auth experience
- Requires DNS configuration

### Troubleshooting

**Webhook Not Receiving Events**:
- Check endpoint URL is correct
- Verify backend is running
- Check firewall/network settings
- For local dev: verify ngrok tunnel is active
- Check Clerk dashboard webhook logs

**Invalid API Keys**:
- Verify keys are copied correctly (no extra spaces)
- Check test vs live key environment
- Regenerate keys if needed

**JWT Verification Fails**:
- Verify secret key matches environment
- Check JWT template configuration
- Ensure clock sync on servers

### Cost Considerations

**Clerk Pricing** (as of 2024):
- Free tier: 10,000 monthly active users
- Includes all features needed for Mirage
- Production usage may require paid plan
- Check current pricing at clerk.com/pricing

### Future Enhancements

**Additional Auth Methods** (not in PBI 16):
- OAuth providers (Google, GitHub, etc.)
- Multi-factor authentication (MFA)
- Passwordless authentication
- SAML SSO (enterprise)

**Advanced Features** (PBI 18):
- Organizations and members
- Role-based access control
- Custom JWT claims
- Session management APIs

