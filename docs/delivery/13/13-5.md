# [13-5] Implement metadata retrieval API endpoints

[Back to task list](./tasks.md)

## Description

Create new REST API endpoints to retrieve persisted environment metadata, service configurations, and support template listing. These endpoints will power the UI display and future cloning workflows.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-03 00:00:00 | Created | N/A | Proposed | Task file created | AI Agent |
| 2025-10-04 00:00:00 | Status Change | Proposed | InProgress | Started implementing metadata retrieval endpoints | AI Agent |
| 2025-10-04 00:00:00 | Status Change | InProgress | Review | All endpoints implemented, code compiles successfully | AI Agent |
| 2025-10-04 00:00:00 | Status Change | Review | Done | Task approved and complete | sean |

## Requirements

1. Implement GET endpoints for retrieving stored data:
   - `GET /api/v1/environments/:id/metadata` - Get complete environment metadata with wizard inputs
   - `GET /api/v1/environments/:id/services` - Get all services for an environment
   - `GET /api/v1/services/:id` - Get single service with build configuration
   - `GET /api/v1/templates` - List environment templates (IsTemplate=true)
2. Return properly formatted JSON with all persisted fields
3. Handle missing records gracefully (404)
4. Include proper error responses
5. Use proper HTTP status codes

## Implementation Plan

1. Add endpoints to `api/internal/controller/environment.go`:
   - `GetEnvironmentMetadata(c *gin.Context)` - retrieve by environment ID
   - `ListEnvironmentServices(c *gin.Context)` - get all services for an environment
   - `ListTemplates(c *gin.Context)` - query environments where IsTemplate=true
2. Add endpoint to `api/internal/controller/services.go`:
   - `GetService(c *gin.Context)` - retrieve service by ID
3. Create DTO types for responses:
   - `EnvironmentMetadataDTO` with parsed wizard inputs
   - `ServiceDTO` with parsed build configuration
   - `TemplateListItemDTO` for template listings
4. Register new routes in `RegisterRoutes`
5. Handle JSON unmarshaling for BuildArgsJSON, ExposedPortsJSON, WizardInputsJSON
6. Return 404 for missing records
7. Add proper error logging

## Verification

- All endpoints return correct data for existing records
- Missing records return 404
- JSON fields are properly unmarshaled
- Response structure matches DTOs
- Error handling works correctly

## Test Plan

**Objective**: Verify metadata retrieval endpoints return correct data

**Test Scope**: API endpoint tests

**Key Test Scenarios**:
1. Get environment metadata for environment with metadata
2. Get environment metadata for environment without metadata (404)
3. Get services for environment - verify all fields returned
4. Get single service with build config - verify JSON fields parsed
5. List templates - returns only environments with IsTemplate=true
6. Test pagination for templates list (if implemented)
7. Verify proper HTTP status codes

**Success Criteria**:
- All endpoints return correct status codes
- Response data matches database records
- JSON unmarshaling works correctly
- Error responses are informative
- Missing records handled gracefully

## Files Modified

- `api/internal/controller/environment.go` - Added metadata retrieval endpoints and DTOs
- `api/internal/controller/services.go` - Added service retrieval endpoint

## Implementation Summary

**New API Endpoints Added:**

1. **GET /api/v1/environments/:id/metadata** - Get complete environment metadata
   - Returns wizard inputs and provision outputs as JSON
   - Handles missing records with 404
   - Unmarshals JSON fields from database

2. **GET /api/v1/environments/:id/services** - List all services for an environment
   - Returns array of ServiceDetailDTO with full build configuration
   - Includes deployment type, source repo, Docker image info
   - Parses ExposedPortsJSON into array

3. **GET /api/v1/templates** - List environment templates
   - Queries EnvironmentMetadata where IsTemplate=true
   - Preloads associated Environment and Services for counts
   - Returns template metadata with environment info

4. **GET /api/v1/services/:id** - Get single service details
   - Returns complete service configuration
   - Includes build config, runtime config, deployment info
   - Handles missing records with 404

**DTOs Created:**

1. **EnvironmentMetadataDTO** - Complete environment metadata with parsed JSON fields
2. **ServiceDetailDTO** - Service with full build and runtime configuration
3. **TemplateListItemDTO** - Template list item with environment summary

**Helper Functions:**

1. **serviceToDTO()** - Converts store.Service to ServiceDetailDTO (in environment.go)
2. **serviceModelToServiceDetailDTO()** - Converts store.Service to ServiceDetailDTO (in services.go)
   - Both parse ExposedPortsJSON from string to []int
   - Both format timestamps as RFC3339

**Key Implementation Details:**

- All endpoints return proper HTTP status codes (200, 404, 400, 500)
- JSON fields are unmarshaled safely with error handling
- Missing records return 404 with informative error messages
- Database errors are logged with context
- Status normalization applied where appropriate
- Timestamps formatted as RFC3339 for consistency

**Verification Results:**

- ✅ Backend compiles successfully (`go build ./...` - exit code 0)
- ✅ No linter errors in modified files
- ✅ All routes registered correctly
- ✅ DTOs properly structured for JSON serialization
- ✅ Error handling comprehensive
