# [13-5] Implement metadata retrieval API endpoints

[Back to task list](./tasks.md)

## Description

Create new REST API endpoints to retrieve persisted environment metadata, service configurations, and support template listing. These endpoints will power the UI display and future cloning workflows.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-03 00:00:00 | Created | N/A | Proposed | Task file created | AI Agent |

## Requirements

1. Implement GET endpoints for retrieving stored data:
   - `GET /api/v1/environments/:id/metadata` - Get complete environment metadata with wizard inputs
   - `GET /api/v1/environments/:id/services` - Get all services for an environment
   - `GET /api/v1/services/:id` - Get single service with build configuration
   - `GET /api/v1/templates` - List environment templates (IsTemplate=true)
2. Return properly formatted JSON with all persisted fields
3. Handle missing records gracefully (404)
4. Include proper error responses
5. Use proper HTTP status codes

## Implementation Plan

1. Add endpoints to `api/internal/controller/environment.go`:
   - `GetEnvironmentMetadata(c *gin.Context)` - retrieve by environment ID
   - `ListEnvironmentServices(c *gin.Context)` - get all services for an environment
   - `ListTemplates(c *gin.Context)` - query environments where IsTemplate=true
2. Add endpoint to `api/internal/controller/services.go`:
   - `GetService(c *gin.Context)` - retrieve service by ID
3. Create DTO types for responses:
   - `EnvironmentMetadataDTO` with parsed wizard inputs
   - `ServiceDTO` with parsed build configuration
   - `TemplateListItemDTO` for template listings
4. Register new routes in `RegisterRoutes`
5. Handle JSON unmarshaling for BuildArgsJSON, ExposedPortsJSON, WizardInputsJSON
6. Return 404 for missing records
7. Add proper error logging

## Verification

- All endpoints return correct data for existing records
- Missing records return 404
- JSON fields are properly unmarshaled
- Response structure matches DTOs
- Error handling works correctly

## Test Plan

**Objective**: Verify metadata retrieval endpoints return correct data

**Test Scope**: API endpoint tests

**Key Test Scenarios**:
1. Get environment metadata for environment with metadata
2. Get environment metadata for environment without metadata (404)
3. Get services for environment - verify all fields returned
4. Get single service with build config - verify JSON fields parsed
5. List templates - returns only environments with IsTemplate=true
6. Test pagination for templates list (if implemented)
7. Verify proper HTTP status codes

**Success Criteria**:
- All endpoints return correct status codes
- Response data matches database records
- JSON unmarshaling works correctly
- Error responses are informative
- Missing records handled gracefully

## Files Modified

- `api/internal/controller/environment.go` - Add metadata retrieval endpoints
- `api/internal/controller/services.go` - Add service retrieval endpoint
- `api/internal/controller/environment_test.go` - Add endpoint tests
- `api/internal/controller/services_test.go` - Add endpoint tests
