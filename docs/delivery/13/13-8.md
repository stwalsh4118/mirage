# [13-8] Add database cleanup for Railway resource deletion

[Back to task list](./tasks.md)

## Description

Implement database cleanup when Railway resources (projects, environments, services) are deleted. Currently, deletion endpoints only remove resources from Railway but leave orphaned records in our database, causing data integrity issues and stale UI displays.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-04 00:00:00 | Created | N/A | Proposed | Task file created | AI Agent |
| 2025-10-04 00:00:00 | Status Change | Proposed | InProgress | Started implementing database cleanup for deletions | AI Agent |
| 2025-10-04 00:00:00 | Status Change | InProgress | Review | Implementation complete, all tests passing | AI Agent |
| 2025-10-04 00:00:00 | Status Change | Review | Done | Implementation complete, all tests passing | AI Agent |


## Requirements

1. **Delete Railway Environment**: Clean up database when environment is deleted
   - Delete environment record from `environments` table
   - Delete metadata from `environment_metadata` table (if exists)
   - Cascade delete all services from `services` table
   - Use database transaction for atomicity

2. **Delete Railway Project**: Clean up all project resources
   - Find all environments with matching `railway_project_id`
   - For each environment, delete: environment record, metadata, services
   - Use database transaction for atomicity
   - Log all deletions for audit trail

3. **Add Service Deletion Endpoint**: Allow individual service deletion
   - Create `DELETE /railway/service/:id` endpoint
   - Delete from Railway via client
   - Delete service record from database
   - Handle case where Railway deletion succeeds but DB fails

4. **Error Handling**:
   - If Railway deletion succeeds but DB cleanup fails: log error, don't fail request
   - If Railway deletion fails: don't attempt DB cleanup
   - Return appropriate HTTP status codes and error messages

## Implementation Plan

1. **Update `DeleteRailwayEnvironment` in `api/internal/controller/projects.go`**:
   ```go
   // After successful Railway deletion:
   - Look up environment by railway_environment_id
   - Start transaction
     - Delete services where environment_id = mirage_env_id
     - Delete metadata where environment_id = mirage_env_id
     - Delete environment where id = mirage_env_id
   - Commit transaction
   - Log results
   ```

2. **Update `DeleteRailwayProject` in `api/internal/controller/projects.go`**:
   ```go
   // After successful Railway deletion:
   - Find all environments where railway_project_id = project_id
   - Start transaction
     - For each environment:
       - Delete services where environment_id = env.id
       - Delete metadata where environment_id = env.id
       - Delete environment where id = env.id
   - Commit transaction
   - Log deletion counts
   ```

3. **Add `DeleteRailwayService` in new file or services controller**:
   ```go
   // DELETE /railway/service/:id
   - Accept Railway service ID
   - Call Railway.DestroyService
   - Look up service by railway_service_id
   - Delete service record from database
   - Return 204 No Content on success
   ```

4. **Add deletion methods to Railway client** (if not exists):
   - `DestroyService(ctx, serviceID)` - may already exist, verify

5. **Add logging**:
   - Log Railway API calls
   - Log database operations (rows affected)
   - Log any errors or partial failures

## Verification

### Manual Testing Required
User should verify the following scenarios with actual Railway resources:

1. **Environment Deletion**:
   - Create an environment with metadata and services via wizard
   - Delete the environment via API: `DELETE /railway/environment/:id`
   - Verify in database that services, metadata, and environment records are all deleted
   - Verify no orphaned records remain

2. **Project Deletion**:
   - Create a project with multiple environments
   - Delete the project via API: `DELETE /railway/project/:id`
   - Verify in database that all environments, services, and metadata are deleted
   - Check that Railway project is also deleted

3. **Service Deletion**:
   - Provision a service in an environment
   - Delete the service via API: `DELETE /railway/service/:id`
   - Verify in database that service record is deleted
   - Verify Railway service is also deleted

4. **Error Handling**:
   - Test deletion with invalid IDs (should return appropriate errors)
   - Test deletion when Railway API fails (database should remain intact)
   - Test deletion when database is unavailable (Railway deletion should succeed, log error)

### Automated Tests
- All existing tests pass: `go test ./...` ✅
- Mock client updated to implement `DestroyService()` method ✅

## Test Plan

**Objective**: Verify deletion endpoints clean up database correctly

**Test Scope**: Integration tests for deletion flows

**Key Test Scenarios**:

### DeleteRailwayEnvironment
1. Delete environment with no services - verify env and metadata deleted
2. Delete environment with multiple services - verify cascade deletion
3. Delete environment without metadata - verify no error
4. Railway deletion succeeds, DB cleanup fails - verify error logged, 204 returned
5. Railway deletion fails - verify no DB cleanup attempted

### DeleteRailwayProject  
6. Delete project with single environment - verify all records deleted
7. Delete project with multiple environments - verify all environments and their resources deleted
8. Delete project with no environments - verify no errors
9. Verify transaction rollback on DB error

### DeleteRailwayService
10. Delete service successfully - verify removed from Railway and database
11. Railway deletion succeeds, DB deletion fails - verify logged, request succeeds
12. Railway deletion fails - verify error returned, no DB deletion

**Success Criteria**:
- All deletion endpoints clean up database records
- Transactions prevent partial deletions
- Errors are handled gracefully
- No orphaned records in database after deletions
- Appropriate HTTP status codes returned
- All deletions logged for audit trail

## Files Modified

### Railway Client
- `api/internal/railway/service.go`
  - Added `DestroyService()` method with `DestroyServiceInput` type
  - Implements GraphQL `serviceDelete` mutation

### Controllers
- `api/internal/controller/projects.go`
  - Updated `DeleteRailwayEnvironment()` to clean up database:
    - Deletes services for the environment
    - Deletes environment metadata
    - Deletes environment record
    - Uses transaction for atomic cleanup
  - Updated `DeleteRailwayProject()` to clean up database:
    - Finds all environments for the project
    - Deletes services, metadata, and environment records for each
    - Uses transaction for atomic cleanup
  - Added `gorm` import for `gorm.ErrRecordNotFound`

- `api/internal/controller/services.go`
  - Added `DestroyService()` method to `RailwayServiceClient` interface
  - Added `DeleteRailwayService()` endpoint handler
  - Registered `DELETE /railway/service/:id` route
  - Cleans up service record from database after Railway deletion

### Tests
- `api/internal/controller/services_test.go`
  - Added `destroyServiceFunc` field to `mockRailwayClient`
  - Implemented `DestroyService()` method on mock

## Notes

**Transaction Strategy**:
- Railway deletion first (fail fast if Railway API fails)
- Database cleanup in transaction (ensures atomicity)
- If Railway succeeds but DB fails: log error, return success (Railway is source of truth)

**Cascade Deletion Order**:
1. Services (foreign key to environment)
2. Metadata (foreign key to environment)
3. Environment (parent record)

**Foreign Key Constraints**:
- Our SQLite/Postgres schema should have proper foreign keys
- Consider adding `ON DELETE CASCADE` for automatic cleanup (future enhancement)

## Related Issues

- Complements PBI 13 tasks 13-3 (persistence) and 13-5 (retrieval)
- Prevents orphaned records that would confuse users
- Essential for PBI 15 (environment cloning) to avoid cloning stale data

