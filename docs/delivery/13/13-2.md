# [13-2] Create EnvironmentMetadata model for wizard inputs and provision outputs

[Back to task list](./tasks.md)

## Description

Create a new `EnvironmentMetadata` GORM model to store complete wizard state and provision outputs. This enables environment cloning, branch-based deployments, and template creation. This is a net-new model, not extending an existing one.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-03 00:00:00 | Created | N/A | Proposed | Task file created | AI Agent |

## Requirements

1. Create new `EnvironmentMetadata` model to store:
   - Complete wizard state (all inputs from all steps)
   - Provision outputs (created Railway IDs)
   - Template metadata (name, description, isTemplate flag)
   - Cloning lineage (clonedFromEnvID)
2. Store wizard state as JSON for maximum flexibility
3. Foreign key relationship to `Environment` table
4. Support template functionality for future PBI 15
5. Include timestamps for audit trail

## Implementation Plan

1. Add `EnvironmentMetadata` struct to `api/internal/store/models.go`:
   - ID (primary key, uuid)
   - EnvironmentID (foreign key, indexed, not null)
   - IsTemplate (boolean, default false)
   - TemplateName (*string, nullable)
   - TemplateDescription (*string, nullable)
   - ClonedFromEnvID (*string, nullable)
   - WizardInputsJSON (text, stores complete wizard state)
   - ProvisionOutputsJSON (text, stores Railway IDs and metadata)
   - CreatedAt, UpdatedAt (timestamps)
2. Use `gorm:"type:text"` for JSON columns
3. Add GORM tags for indexing (EnvironmentID, IsTemplate)
4. Update `store.go` AutoMigrate to include EnvironmentMetadata
5. Add helper functions for JSON marshaling/unmarshaling

## Verification

- Model compiles without errors
- GORM tags are correct for all fields
- Foreign key relationship works
- JSON columns can store complex nested structures
- AutoMigrate includes the new table

## Test Plan

**Objective**: Verify EnvironmentMetadata model can persist wizard state

**Test Scope**: Database model operations

**Key Test Scenarios**:
1. Create EnvironmentMetadata with wizard inputs JSON
2. Store and retrieve complex nested JSON structures
3. Query by EnvironmentID foreign key
4. Query templates (IsTemplate = true)
5. Handle nil/empty optional fields
6. Verify timestamps are auto-populated

**Success Criteria**:
- CRUD operations work correctly
- JSON marshaling preserves complex data structures
- Foreign key constraints are enforced
- Template queries work correctly
- Database migration succeeds

## Files Modified

- `api/internal/store/models.go` - Add EnvironmentMetadata model
- `api/internal/store/store.go` - Add to AutoMigrate
- `api/internal/store/store_test.go` - Add unit tests
