# [13-2] Create EnvironmentMetadata model for wizard inputs and provision outputs

[Back to task list](./tasks.md)

## Description

Create a new `EnvironmentMetadata` GORM model to store complete wizard state and provision outputs. This enables environment cloning, branch-based deployments, and template creation. This is a net-new model, not extending an existing one.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-03 00:00:00 | Created | N/A | Proposed | Task file created | AI Agent |
| 2025-10-04 00:00:00 | Status Change | Proposed | InProgress | Started creating EnvironmentMetadata model | AI Agent |
| 2025-10-04 00:00:00 | Status Change | InProgress | Review | Model created, tests passing | AI Agent |
| 2025-10-04 00:00:00 | Status Change | Review | Done | Task approved and complete | sean |

## Requirements

1. Create new `EnvironmentMetadata` model to store:
   - Complete wizard state (all inputs from all steps)
   - Provision outputs (created Railway IDs)
   - Template metadata (name, description, isTemplate flag)
   - Cloning lineage (clonedFromEnvID)
2. Store wizard state as JSON for maximum flexibility
3. Foreign key relationship to `Environment` table
4. Support template functionality for future PBI 15
5. Include timestamps for audit trail

## Implementation Plan

1. Add `EnvironmentMetadata` struct to `api/internal/store/models.go`:
   - ID (primary key, uuid)
   - EnvironmentID (foreign key, indexed, not null)
   - IsTemplate (boolean, default false)
   - TemplateName (*string, nullable)
   - TemplateDescription (*string, nullable)
   - ClonedFromEnvID (*string, nullable)
   - WizardInputsJSON (text, stores complete wizard state)
   - ProvisionOutputsJSON (text, stores Railway IDs and metadata)
   - CreatedAt, UpdatedAt (timestamps)
2. Use `gorm:"type:text"` for JSON columns
3. Add GORM tags for indexing (EnvironmentID, IsTemplate)
4. Update `store.go` AutoMigrate to include EnvironmentMetadata
5. Add helper functions for JSON marshaling/unmarshaling

## Verification

- Model compiles without errors
- GORM tags are correct for all fields
- Foreign key relationship works
- JSON columns can store complex nested structures
- AutoMigrate includes the new table

## Test Plan

**Objective**: Verify EnvironmentMetadata model can persist wizard state

**Test Scope**: Database model operations

**Key Test Scenarios**:
1. Create EnvironmentMetadata with wizard inputs JSON
2. Store and retrieve complex nested JSON structures
3. Query by EnvironmentID foreign key
4. Query templates (IsTemplate = true)
5. Handle nil/empty optional fields
6. Verify timestamps are auto-populated

**Success Criteria**:
- CRUD operations work correctly
- JSON marshaling preserves complex data structures
- Foreign key constraints are enforced
- Template queries work correctly
- Database migration succeeds

## Files Modified

- `api/internal/store/models.go` - Added EnvironmentMetadata model with complete wizard state storage
- `api/internal/store/store.go` - Added EnvironmentMetadata to both AutoMigrate functions
- `api/internal/store/store_test.go` - Added 6 comprehensive test cases covering all functionality

## Implementation Summary

**EnvironmentMetadata Model Created:**
- Primary key ID field
- EnvironmentID foreign key (indexed, not null)
- IsTemplate flag (indexed, default false) for template functionality
- TemplateName and TemplateDescription (nullable) for template metadata
- ClonedFromEnvID (nullable) for tracking cloning lineage
- WizardInputsJSON (datatypes.JSON with jsonb type) for storing complete wizard state
- ProvisionOutputsJSON (datatypes.JSON with jsonb type) for storing Railway provision outputs
- CreatedAt and UpdatedAt timestamps for audit trail

**Database Integration:**
- Added to both SQLite and PostgreSQL AutoMigrate functions
- Foreign key relationship to Environment table
- Proper indexing on EnvironmentID and IsTemplate for query performance
- Uses GORM's `datatypes.JSON` type with PostgreSQL `jsonb` for efficient JSON storage
- Added dependency: `gorm.io/datatypes v1.2.7` for native JSON type support

**Tests Added (All Passing âœ“):**
1. `TestEnvironmentMetadata_CreateWithWizardInputs` - Create and retrieve complex wizard state
2. `TestEnvironmentMetadata_QueryByEnvironmentID` - Query by foreign key
3. `TestEnvironmentMetadata_TemplateFields` - Template functionality and queries
4. `TestEnvironmentMetadata_ClonedFromEnvID` - Cloning lineage tracking
5. `TestEnvironmentMetadata_OptionalFieldsNil` - Nil handling for optional fields
6. `TestEnvironmentMetadata_ComplexNestedJSON` - Deep nested JSON structure preservation

All tests pass successfully, validating:
- CRUD operations work correctly
- JSON marshaling preserves complex data structures
- Foreign key constraints are enforced
- Template queries work correctly
- Database migration succeeds
- Timestamps are auto-populated
