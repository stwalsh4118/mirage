# [13-1] Extend Environment and Service models with build configuration fields

[Back to task list](./tasks.md)

## Description

Extend the existing `Environment` and `Service` GORM models to include all the fields needed to store wizard inputs and build configurations. Remove the unused `Template` model. These models exist but are not currently being populated by the wizard flow.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-03 00:00:00 | Created | N/A | Proposed | Task file created | AI Agent |
| 2025-10-03 00:00:00 | Status Change | Proposed | InProgress | Started extending models | AI Agent |
| 2025-10-03 00:00:00 | Status Change | InProgress | Review | Models extended, Template removed, tests passing | AI Agent |
| 2025-10-03 00:00:00 | Status Change | Review | Done | Task approved and complete | sean |

## Requirements

1. Extend `Service` model to include build configuration fields:
   - DockerfilePath (for monorepo services)
   - BuildContext
   - BuildArgsJSON (JSON array/map)
   - ExposedPortsJSON (JSON array of integers)
   - HealthCheckPath
   - StartCommand
   - RootDirectory
2. Verify `Environment` model has all needed fields (it mostly does already)
3. Remove unused `Template` model
4. Update AutoMigrate calls to remove Template
5. Ensure all JSON fields use proper GORM tags
6. Keep existing fields that are already in use

## Implementation Plan

1. Update `Service` struct in `api/internal/store/models.go`:
   - Add `DockerfilePath *string`
   - Add `BuildContext *string`
   - Add `RootDirectory *string`
   - Add `BuildArgsJSON string` (JSON text)
   - Add `ExposedPortsJSON string` (JSON text)
   - Add `HealthCheckPath *string`
   - Add `StartCommand *string`
   - Add `TargetStage *string`
2. Review `Environment` model - verify it has:
   - RailwayProjectID field (currently missing, needed for provision outputs)
3. Delete `Template` struct
4. Update `store.go`:
   - Remove `&Template{}` from both AutoMigrate calls
   - Keep `&Environment{}` and `&Service{}`
5. Add GORM tags: `gorm:"type:text"` for JSON columns, nullable for optional fields

## Verification

- Models compile without errors
- GORM tags are correct for all new fields
- Template model is completely removed
- AutoMigrate runs successfully
- Existing fields are preserved

## Test Plan

**Objective**: Verify extended models can be created and migrated

**Test Scope**: Database model operations

**Key Test Scenarios**:
1. Run AutoMigrate and verify no errors
2. Create Service with new fields populated
3. Create Service with new fields as nil (optional)
4. Verify JSON columns can store arrays and objects
5. Verify existing Service records still work after migration

**Success Criteria**:
- Database migration completes successfully
- All new fields are accessible
- Null/empty values handled correctly
- No breaking changes to existing data

## Files Modified

- `api/internal/store/models.go` - Extended Service model with build config fields, added RailwayProjectID to Environment, removed Template model
- `api/internal/store/store.go` - Removed Template from AutoMigrate calls
- `api/internal/store/store_test.go` - Added comprehensive tests for new fields

## Implementation Summary

**Extended Service Model:**
- Added `DockerfilePath`, `BuildContext`, `RootDirectory` - Dockerfile configuration
- Added `BuildArgsJSON` - JSON storage for build arguments
- Added `TargetStage` - multi-stage build target
- Added `ExposedPortsJSON` - JSON storage for exposed ports
- Added `HealthCheckPath`, `StartCommand` - runtime configuration
- All new fields use proper GORM tags with nullable pointers for optional fields

**Extended Environment Model:**
- Added `RailwayProjectID` - needed to store provision outputs

**Removed:**
- Deleted unused `Template` model completely
- Removed from both AutoMigrate functions

**Tests Added:**
- `TestService_BuildConfiguration` - verifies all new build config fields
- `TestService_OptionalFieldsNil` - verifies nil handling for optional fields
- `TestEnvironment_RailwayProjectID` - verifies new Environment field
- All tests passing âœ“
