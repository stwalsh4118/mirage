# [13-7] E2E CoS Test

[Back to task list](./tasks.md)

## Description

End-to-end testing to verify that the complete wizard-to-database-to-retrieval flow works correctly. Validates all PBI 13 Conditions of Satisfaction are met: persistence is working, metadata is captured, and data can be retrieved.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-03 00:00:00 | Created | N/A | Proposed | Task file created | AI Agent |

## Requirements

Verify all PBI 13 acceptance criteria:
1. Service build configurations persisted on service creation ✓
2. Dockerfile paths and build contexts stored ✓
3. Build arguments captured and stored as JSON ✓
4. Docker image references stored (registry, name, tag, digest) ✓
5. Service ports and health check configs persisted ✓
6. Environment metadata stores wizard inputs ✓
7. Provision outputs (Railway IDs) are stored ✓
8. Complete wizard state preserved and retrievable ✓
9. "Save as Template" foundation is in place ✓
10. Database persistence works end-to-end ✓

## Implementation Plan

1. Create comprehensive E2E test file: `api/internal/controller/provision_persistence_e2e_test.go`
2. Test complete wizard flow with database persistence:
   - Create project → verify Environment record created
   - Create environment → verify Environment + EnvironmentMetadata created
   - Create services → verify Service records created with build config
   - Retrieve metadata → verify all wizard inputs preserved
   - Retrieve services → verify build configuration accessible
3. Test both deployment types:
   - Repository with multiple discovered Dockerfiles
   - Docker image deployments
4. Test JSON field marshaling:
   - Build args as arrays
   - Exposed ports as arrays
   - Complete wizard state as nested JSON
5. Test error cases:
   - Database write failures
   - Missing Railway IDs
   - Invalid JSON structures
6. Test retrieval edge cases:
   - Environments without metadata (shouldn't happen but handle gracefully)
   - Services with minimal vs full configuration

## Verification

- All PBI 13 acceptance criteria pass
- Complete provision-to-retrieval flow works
- Both repo and image deployment types persist correctly
- JSON marshaling/unmarshaling preserves data
- Edge cases handled appropriately

## Test Plan

**Objective**: Verify complete persistence and retrieval workflow

**Test Scope**: End-to-end integration tests covering all PBI 13 features

**Environment & Setup**:
- Test database with clean state
- Mock Railway API responses
- Test data for various service configurations

**Key Test Scenarios**:

### Scenario 1: Repository-based Environment with Dockerfile Discovery
1. Call ProvisionProject with new project
2. Verify Environment record created in database
3. Call ProvisionServices with multiple discovered services
4. Verify Service records created with:
   - DockerfilePath set correctly
   - BuildContext stored
   - BuildArgsJSON contains discovered args
   - ExposedPortsJSON contains port array
5. Call GetEnvironmentMetadata
6. Verify wizard inputs preserved exactly

### Scenario 2: Docker Image-based Environment
1. Call ProvisionEnvironment for existing project
2. Verify EnvironmentMetadata created with wizard inputs
3. Call ProvisionServices with image-based services
4. Verify Service records contain:
   - ImageRegistry, ImageName, ImageTag, ImageDigest
   - DeploymentType = "docker_image"
5. Retrieve services and validate image config

### Scenario 3: Complex Configuration
1. Create environment with:
   - Mix of repo and image services
   - Per-service environment variables
   - Global environment variables
   - Custom TTL
2. Verify all configuration persisted
3. Retrieve and validate completeness

### Scenario 4: Template Foundation
1. Create environment
2. Update IsTemplate flag
3. List templates endpoint returns the environment
4. Template metadata accessible

### Scenario 5: Missing Metadata Handling
1. Query metadata for non-existent environment
2. Verify 404 response
3. No errors logged

**Success Criteria**:
- All scenarios pass without errors
- Retrieved data exactly matches stored data
- JSON fields preserve complex structures
- API responses have correct status codes and structure
- No data loss during marshal/unmarshal
- Database constraints are enforced
- Transaction rollback works on errors

## Files Modified

- `api/internal/controller/provision_persistence_e2e_test.go` - New comprehensive E2E test file
- Update test fixtures/helpers as needed for test data
