# [15-3] Implement environment variable upsert to Railway in Go client

[Back to task list](./tasks.md)

## Description

Implement the ability to set/update environment variables in a Railway environment. This allows the clone operation to copy environment variables from the source environment to the target environment with optional overrides.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-06 00:00:00 | Created | N/A | Proposed | Task file created | ai-agent |

## Requirements

1. **GraphQL Mutation File**:
   - Create `api/internal/railway/queries/mutations/environment-variables-upsert.graphql`
   - Mutation should set/update multiple variables atomically
   - Support both creation and updates (upsert behavior)

2. **Go Client Method**:
   - Add `UpsertEnvironmentVariables` method to Railway client
   - Input: environment ID, map of key-value pairs
   - Support batch updates for efficiency
   - Handle partial failures appropriately
   - Return success/failure information

3. **Type Definitions**:
   - Define input/output types for the method
   - Consider batch size limitations
   - Define clear error types

4. **Idempotency**:
   - Ensure method is idempotent
   - Safe to retry on failure
   - Handle duplicate keys gracefully

5. **Security**:
   - Transmit secrets securely
   - Don't log secret values
   - Use appropriate Railway API mechanisms for secrets

## Implementation Plan

1. **Create GraphQL Mutation**:
   ```graphql
   # api/internal/railway/queries/mutations/environment-variables-upsert.graphql
   mutation UpsertEnvironmentVariables(
     $environmentId: String!
     $variables: [VariableInput!]!
   ) {
     variableCollectionUpsert(
       environmentId: $environmentId
       variables: $variables
     ) {
       success
     }
   }
   ```

2. **Add Method to Railway Client** (`api/internal/railway/variables.go`):
   ```go
   //go:embed queries/mutations/environment-variables-upsert.graphql
   var gqlUpsertEnvironmentVariables string
   
   type UpsertEnvironmentVariablesInput struct {
       EnvironmentID string
       Variables     map[string]string
   }
   
   type UpsertEnvironmentVariablesResult struct {
       Success bool
   }
   
   // UpsertEnvironmentVariables sets or updates environment variables
   func (c *Client) UpsertEnvironmentVariables(ctx context.Context, in UpsertEnvironmentVariablesInput) (UpsertEnvironmentVariablesResult, error) {
       // Convert map to array of variable inputs
       variables := make([]map[string]any, 0, len(in.Variables))
       for key, value := range in.Variables {
           variables = append(variables, map[string]any{
               "name":  key,
               "value": value,
           })
       }
       
       vars := map[string]any{
           "environmentId": in.EnvironmentID,
           "variables":     variables,
       }
       
       var resp struct {
           VariableCollectionUpsert struct {
               Success bool `json:"success"`
           } `json:"variableCollectionUpsert"`
       }
       
       if err := c.execute(ctx, gqlUpsertEnvironmentVariables, vars, &resp); err != nil {
           return UpsertEnvironmentVariablesResult{}, err
       }
       
       log.Info().
           Str("environment_id", in.EnvironmentID).
           Int("variable_count", len(in.Variables)).
           Bool("success", resp.VariableCollectionUpsert.Success).
           Msg("upserted environment variables")
       
       return UpsertEnvironmentVariablesResult{
           Success: resp.VariableCollectionUpsert.Success,
       }, nil
   }
   ```

3. **Add Tests** (`api/internal/railway/variables_test.go`):
   - Test successful upsert
   - Test empty variables (no-op)
   - Test large batch sizes
   - Test error handling
   - Test idempotency

## Test Plan

### Unit Tests

1. **Test Successful Upsert**:
   - Mock Railway API to return success
   - Verify mutation is called with correct variables
   - Verify success is returned

2. **Test Empty Variables**:
   - Verify no mutation is sent for empty map
   - Or verify it handles empty gracefully

3. **Test Batch Size**:
   - Test with 1, 10, 100 variables
   - Verify all are sent correctly
   - Consider batch splitting if Railway has limits

4. **Test Error Handling**:
   - Mock Railway API errors
   - Verify errors are propagated
   - Verify partial failures are handled

5. **Test Idempotency**:
   - Call method twice with same variables
   - Verify second call succeeds
   - Verify no duplicate variables created

6. **Test Security**:
   - Verify variable values are NOT logged
   - Verify only count is logged

### Success Criteria

- All unit tests pass
- Method successfully upserts variables to Railway
- Error handling is robust
- Idempotency is guaranteed
- Security considerations are met
- No secrets logged

## Verification

- [ ] GraphQL mutation file created
- [ ] Go method implemented in railway client
- [ ] Type definitions added
- [ ] Error handling implemented
- [ ] Idempotency verified
- [ ] Unit tests added and passing
- [ ] No secrets logged
- [ ] Variable count logged appropriately
- [ ] Method handles empty variable maps
- [ ] Method handles large variable sets
- [ ] Partial failure handling tested

## Files Modified

### New Files
- `api/internal/railway/queries/mutations/environment-variables-upsert.graphql` - GraphQL mutation for upserting variables

### Modified Files
- `api/internal/railway/variables.go` - Implementation of UpsertEnvironmentVariables
- `api/internal/railway/variables_test.go` - Additional unit tests

