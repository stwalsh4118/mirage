# [15-2] Implement environment variable fetching from Railway in Go client

[Back to task list](./tasks.md)

## Description

Implement the ability to fetch all environment variables for a given Railway environment. This is a critical component of the cloning workflow, as environment variables must be fetched from the source environment and applied to the target environment.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-06 00:00:00 | Created | N/A | Proposed | Task file created | ai-agent |
| 2025-10-06 16:00:00 | Status Change | Proposed | Agreed | Starting implementation based on task 15-1 research | AI_Agent |
| 2025-10-06 16:01:00 | Status Change | Agreed | InProgress | Implementing GetEnvironmentVariables | AI_Agent |
| 2025-10-06 16:15:00 | Status Change | InProgress | Review | Implementation complete, all tests passing | AI_Agent |
| 2025-10-06 16:30:00 | Significant Update | Review | Review | Added GetAllEnvironmentAndServiceVariables for efficient bulk fetching | AI_Agent |
| 2025-10-07 00:00:00 | Status Change | Review | Done | Task completed and approved | User |

## Requirements

1. **GraphQL Query File**:
   - Create `api/internal/railway/queries/queries/environment-variables.graphql`
   - Query should fetch all variables for an environment
   - Include necessary fields: key, value, metadata

2. **Go Client Method**:
   - Add `GetEnvironmentVariables` method to Railway client
   - Input: environment ID
   - Output: map of variable key-value pairs or structured type
   - Handle pagination if necessary
   - Handle empty results gracefully

3. **Type Definitions**:
   - Define `EnvironmentVariable` struct if needed
   - Define input/output types for the method
   - Consider whether to return all variables or filtered set

4. **Error Handling**:
   - Handle Railway API errors
   - Handle network errors
   - Return meaningful error messages
   - Log errors appropriately

5. **Security Considerations**:
   - Variables may contain secrets
   - Log carefully (don't log values)
   - Handle transmission securely

## Implementation Plan

1. **Create GraphQL Query**:
   ```graphql
   # api/internal/railway/queries/queries/environment-variables.graphql
   query EnvironmentVariables($environmentId: String!) {
     variables(environmentId: $environmentId) {
       edges {
         node {
           id
           name
           value
           # Additional fields as needed
         }
       }
     }
   }
   ```

2. **Add Method to Railway Client** (`api/internal/railway/variables.go`):
   ```go
   package railway
   
   import (
       "context"
       _ "embed"
   )
   
   //go:embed queries/queries/environment-variables.graphql
   var gqlEnvironmentVariables string
   
   type EnvironmentVariable struct {
       Name  string `json:"name"`
       Value string `json:"value"`
   }
   
   type GetEnvironmentVariablesInput struct {
       EnvironmentID string
   }
   
   type GetEnvironmentVariablesResult struct {
       Variables map[string]string
   }
   
   // GetEnvironmentVariables fetches all environment variables for an environment
   func (c *Client) GetEnvironmentVariables(ctx context.Context, in GetEnvironmentVariablesInput) (GetEnvironmentVariablesResult, error) {
       vars := map[string]any{
           "environmentId": in.EnvironmentID,
       }
       
       var resp struct {
           Variables struct {
               Edges []struct {
                   Node EnvironmentVariable `json:"node"`
               } `json:"edges"`
           } `json:"variables"`
       }
       
       if err := c.execute(ctx, gqlEnvironmentVariables, vars, &resp); err != nil {
           return GetEnvironmentVariablesResult{}, err
       }
       
       // Convert to map
       result := make(map[string]string)
       for _, edge := range resp.Variables.Edges {
           result[edge.Node.Name] = edge.Node.Value
       }
       
       log.Info().
           Str("environment_id", in.EnvironmentID).
           Int("variable_count", len(result)).
           Msg("fetched environment variables")
       
       return GetEnvironmentVariablesResult{Variables: result}, nil
   }
   ```

3. **Add Tests** (`api/internal/railway/variables_test.go`):
   - Test successful variable fetching
   - Test empty variables
   - Test error handling
   - Mock Railway API responses

## Test Plan

### Unit Tests

1. **Test Successful Fetch**:
   - Mock Railway API to return variables
   - Verify variables are parsed correctly
   - Verify map structure is correct

2. **Test Empty Variables**:
   - Mock Railway API to return empty list
   - Verify empty map is returned
   - Verify no errors occur

3. **Test Error Handling**:
   - Mock Railway API errors
   - Verify errors are propagated
   - Verify error messages are meaningful

4. **Test Security**:
   - Verify variable values are NOT logged
   - Verify only variable count is logged

### Success Criteria

- All unit tests pass
- Method successfully fetches variables from Railway
- Error handling is robust
- Security considerations are met
- Logging is appropriate (no secrets logged)

## Verification

- [x] GraphQL query file created
- [x] Go method implemented in railway client
- [x] Type definitions added
- [x] Error handling implemented
- [x] Unit tests added and passing
- [x] No secrets logged
- [x] Variable count logged appropriately
- [x] Method can handle empty variable sets
- [x] Method can handle nil maps (Railway API returns flat map, no pagination needed)

## Files Modified

### New Files
- `api/internal/railway/queries/queries/variables-get.graphql` - GraphQL query for fetching variables
- `api/internal/railway/variables.go` - Implementation of GetEnvironmentVariables and GetAllEnvironmentAndServiceVariables
- `api/internal/railway/variables_test.go` - Unit tests

### Modified Files
None - All implementation is in new files

### Additional Implementation
Added `GetAllEnvironmentAndServiceVariables` method which fetches variables for ALL services in an environment at once. This is the preferred method for cloning workflows as it's more efficient than calling GetEnvironmentVariables multiple times.

