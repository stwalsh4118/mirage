# [15-4] Add snapshot endpoint to fetch environment data

[Back to task list](./tasks.md)

## Description

Implement a simple endpoint that returns all the data needed to recreate an environment: environment details, services configuration, and environment variables from Railway. This is used to pre-populate the creation wizard when cloning.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-06 00:00:00 | Created | N/A | Proposed | Task file created | ai-agent |

## Requirements

1. **API Endpoint**:
   - Route: `GET /api/environments/:id/snapshot`
   - Returns complete environment data for cloning
   - No resource creation - read-only operation

2. **Response Structure**:
   ```json
   {
     "environment": {
       "id": "...",
       "name": "dev-api",
       "type": "dev",
       "railwayProjectId": "...",
       "sourceRepo": "...",
       "sourceBranch": "main",
       "ttlSeconds": 86400
     },
     "services": [
       {
         "name": "api",
         "deploymentType": "source_repo",
         "sourceRepo": "...",
         "sourceBranch": "main",
         "dockerfilePath": "./Dockerfile",
         "rootDirectory": "./services/api"
       }
     ],
     "environmentVariables": {
       "NODE_ENV": "development",
       "API_KEY": "xyz"
     }
   }
   ```

3. **Data Fetching**:
   - Fetch environment from database
   - Fetch all services from database
   - Fetch environment variables from Railway API (not database)

4. **Validation**:
   - Verify environment exists
   - Handle Railway API errors gracefully
   - Return empty variables object if Railway fetch fails

## Implementation Plan

Add to `api/internal/controller/environment.go`:

```go
type EnvironmentSnapshot struct {
    Environment          store.Environment     `json:"environment"`
    Services             []store.Service       `json:"services"`
    EnvironmentVariables map[string]string     `json:"environmentVariables"`
}

func (c *EnvironmentController) GetEnvironmentSnapshot(ctx *gin.Context) {
    envID := ctx.Param("id")
    
    // Fetch environment with services
    var env store.Environment
    if err := c.DB.Preload("Services").First(&env, "id = ?", envID).Error; err != nil {
        if errors.Is(err, gorm.ErrRecordNotFound) {
            ctx.JSON(http.StatusNotFound, gin.H{"error": "environment not found"})
            return
        }
        ctx.JSON(http.StatusInternalServerError, gin.H{"error": err.Error()})
        return
    }
    
    // Fetch env vars from Railway API
    vars := make(map[string]string)
    if env.RailwayEnvironmentID != "" {
        result, err := c.Railway.GetEnvironmentVariables(ctx, railway.GetEnvironmentVariablesInput{
            EnvironmentID: env.RailwayEnvironmentID,
        })
        if err != nil {
            log.Warn().Err(err).Msg("failed to fetch environment variables for snapshot")
            // Don't fail - just return empty vars
        } else {
            vars = result.Variables
        }
    }
    
    snapshot := EnvironmentSnapshot{
        Environment:          env,
        Services:             env.Services,
        EnvironmentVariables: vars,
    }
    
    ctx.JSON(http.StatusOK, snapshot)
}
```

Register route:
```go
r.GET("/environments/:id/snapshot", c.GetEnvironmentSnapshot)
```

## Test Plan

### Unit Tests

1. **Test Successful Snapshot**: Verify all data returned
2. **Test Environment Not Found**: Verify 404
3. **Test Railway API Failure**: Verify graceful handling with empty vars
4. **Test Empty Services**: Verify works with no services

### Success Criteria

- Endpoint returns complete environment data
- Services include all configuration fields
- Variables fetched from Railway API
- Errors handled gracefully without failing
- Read-only operation - creates nothing

## Verification

- [ ] Endpoint implemented and registered
- [ ] Returns environment, services, variables
- [ ] Railway variables fetched correctly
- [ ] Error handling robust
- [ ] Unit tests passing
- [ ] No resources created

## Files Modified

### Modified Files
- `api/internal/controller/environment.go` - Add GetEnvironmentSnapshot endpoint
- `api/internal/controller/environment_test.go` - Add unit tests
