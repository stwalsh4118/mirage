# [15-6] Pre-populate wizard from environment snapshot

[Back to task list](./tasks.md)

## Description

When a source environment is selected in clone mode, fetch its snapshot and pre-populate all wizard steps. Users can then modify any values (branch, variables, services) before creating the new environment using the existing provision endpoints.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-06 00:00:00 | Created | N/A | Proposed | Task file created | ai-agent |
| 2025-10-07 00:00:00 | Status Change | Proposed | Agreed | Starting implementation of snapshot pre-population | AI_Agent |
| 2025-10-07 00:01:00 | Status Change | Agreed | InProgress | Implementing snapshot fetch and pre-population | AI_Agent |
| 2025-10-07 00:02:00 | Status Change | InProgress | Review | Implementation complete with all polish | AI_Agent |
| 2025-10-07 00:03:00 | Status Change | Review | Done | Task completed and approved | User |

## Requirements

1. **Data Fetching**:
   - Watch `cloneSourceEnvId` for changes
   - Fetch snapshot when source selected
   - Handle loading and error states
   - Show loading indicator in wizard

2. **Pre-population**:
   - **Project Step**: Use source's project or allow changing
   - **Source Step**: Pre-fill repo URL and branch
   - **Discovery Step**: Pre-select all source services
   - **Config Step**: Pre-fill environment variables
   - **Strategy Step**: Pre-fill environment type and TTL

3. **User Modifications**:
   - All fields remain fully editable
   - Users can change branch, add/remove services, modify variables
   - No special indicators needed - it's just regular creation with pre-filled data

4. **Regular Provisioning**:
   - Call existing provision endpoints
   - No special clone API needed
   - Variables included in regular provision request

## Implementation Plan

1. **Add API Hook** (`web/src/lib/api/environments.ts`):
   ```typescript
   export async function getEnvironmentSnapshot(environmentId: string) {
     const response = await fetch(
       `${API_BASE}/api/environments/${environmentId}/snapshot`
     )
     if (!response.ok) throw new Error('Failed to fetch snapshot')
     return response.json()
   }
   ```

2. **Add React Query Hook** (`web/src/hooks/useEnvironments.ts`):
   ```typescript
   export function useEnvironmentSnapshot(environmentId: string | null) {
     return useQuery({
       queryKey: ['environment-snapshot', environmentId],
       queryFn: () => getEnvironmentSnapshot(environmentId!),
       enabled: !!environmentId,
     })
   }
   ```

3. **Fetch and Pre-populate in Dialog** (`web/src/components/wizard/CreateEnvironmentDialog.tsx`):
   ```tsx
   export function CreateEnvironmentDialog(props) {
     const { sourceMode, cloneSourceEnvId, setField } = useWizardStore()
     const snapshot = useEnvironmentSnapshot(cloneSourceEnvId)
     
     // Pre-populate when snapshot data arrives
     useEffect(() => {
       if (snapshot.data && sourceMode === 'clone') {
         const { environment, services, environmentVariables } = snapshot.data
         
         // Project
         setField('existingProjectId', environment.railwayProjectId)
         setField('projectSelectionMode', 'existing')
         
         // Source
         if (services[0]?.sourceRepo) {
           setField('deploymentSource', 'repo')
           setField('sourceRepoUrl', services[0].sourceRepo)
           setField('sourceBranch', services[0].sourceBranch || 'main')
         }
         
         // Discovery - map services to discoveredServices format
         const discoveredServices = services.map(s => ({
           name: s.name,
           path: s.rootDirectory || '.',
           selected: true,
           dockerfilePath: s.dockerfilePath,
           deploymentType: s.deploymentType,
           dockerImage: s.dockerImage,
           imageRegistry: s.imageRegistry,
           imageTag: s.imageTag,
         }))
         setField('discoveredServices', discoveredServices)
         
         // Config
         setField('environmentVariables', environmentVariables)
         
         // Strategy
         setField('templateKind', environment.type)
         if (environment.ttlSeconds) {
           setField('ttlHours', Math.floor(environment.ttlSeconds / 3600))
         }
       }
     }, [snapshot.data, sourceMode])
     
     // Show loading state
     if (sourceMode === 'clone' && snapshot.isLoading) {
       return (
         <DialogContent>
           <div className="flex items-center justify-center h-64">
             <Spinner />
             <span className="ml-2">Loading environment...</span>
           </div>
         </DialogContent>
       )
     }
     
     // Show error state
     if (sourceMode === 'clone' && snapshot.isError) {
       return (
         <DialogContent>
           <Alert variant="destructive">
             <AlertTitle>Failed to load environment</AlertTitle>
             <AlertDescription>
               {snapshot.error?.message}
             </AlertDescription>
           </Alert>
         </DialogContent>
       )
     }
     
     // Regular wizard render
     return (
       <DialogContent>
         {/* ... existing wizard UI ... */}
       </DialogContent>
     )
   }
   ```

4. **Optional: Add Context Alerts to Steps**:
   ```tsx
   // In StepSource.tsx
   const { sourceMode } = useWizardStore()
   
   {sourceMode === 'clone' && (
     <Alert>
       <Info className="h-4 w-4" />
       <AlertDescription>
         Pre-filled from source environment. You can modify any values.
       </AlertDescription>
     </Alert>
   )}
   ```

## Test Plan

### Component Tests

1. **Test Snapshot Fetch**:
   - Select source environment
   - Verify API called
   - Verify loading state shown
   - Verify data returned

2. **Test Pre-population**:
   - Mock snapshot data
   - Verify all wizard fields populated:
     - Project ID
     - Repo URL and branch
     - Services selected
     - Variables filled
     - Type and TTL set

3. **Test Modifications**:
   - Pre-populate fields
   - Change branch, unselect services, modify variables
   - Verify changes persisted in state

4. **Test Loading State**:
   - Mock slow API
   - Verify loading spinner shown
   - Verify wizard disabled during load

5. **Test Error State**:
   - Mock API error
   - Verify error message shown
   - Verify user can go back

6. **Test Regular Provision**:
   - Complete wizard in clone mode
   - Verify calls regular provision endpoints
   - Verify no special clone API called

### Success Criteria

- Snapshot fetches when source selected
- All fields pre-populated correctly
- Users can modify any pre-filled values
- Loading/error states work
- Regular provision endpoints used
- No special clone logic in provision flow

## Verification

- [x] API hook implemented
- [x] React Query hook created
- [x] Fetch triggered on source selection
- [x] Pre-population logic complete
- [x] All wizard steps receive data
- [x] Fields remain editable
- [x] Loading state implemented
- [x] Error state implemented
- [x] Build passing
- [x] Uses regular provision endpoints

## Files Modified

### New Files
- None (adds to existing files)

### Modified Files
- `web/src/lib/api/railway.ts` - Added EnvironmentSnapshot and ServiceVariablesSnapshot types with complete field definitions, added getEnvironmentSnapshot API function
- `web/src/hooks/useRailway.ts` - Added useEnvironmentSnapshot React Query hook with proper enablement logic
- `web/src/components/wizard/CreateEnvironmentDialog.tsx` - Added snapshot fetching, pre-population useEffect that maps snapshot data to wizard state fields (project, source, discovery, config), loading state UI with spinner, error state UI with fallback option, set discoveryTriggered flag to show pre-populated services
- `web/src/components/wizard/steps/StepConfig.tsx` - Added auto-selection of first service in clone mode to immediately show pre-populated service variables
- `api/internal/store/models.go` - Added JSON tags to Environment and Service structs for proper camelCase serialization
- `docs/delivery/15/15-6.md` - Updated task status to InProgress
