# [15-7] E2E CoS Test

[Back to task list](./tasks.md)

## Description

End-to-end testing of the environment cloning workflow. Verify that cloning works using the simplified approach: snapshot → pre-fill wizard → regular provision.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-06 00:00:00 | Created | N/A | Proposed | Task file created | ai-agent |

## Requirements

### Test Coverage

Verify the core cloning functionality:

1. ✅ Clone button available on environment detail page
2. ✅ Clicking clone opens wizard with source pre-selected
3. ✅ Wizard pre-fills with source environment data
4. ✅ User can change branch
5. ✅ User can exclude services
6. ✅ User can modify environment variables
7. ✅ User can change environment type and TTL
8. ✅ Creating environment uses regular provision endpoints
9. ✅ New environment created successfully in Railway
10. ✅ Services created with correct configuration
11. ✅ Environment variables applied from modified wizard data
12. ✅ No environment variables stored in local database

## Implementation Plan

### Manual Testing Checklist

#### Setup
- [ ] Create source environment "clone-test-source"
- [ ] Add 2 services: api (repo), worker (repo)
- [ ] Set 3 environment variables via Railway
- [ ] Verify environment healthy

#### Clone Workflow
- [ ] Navigate to source environment detail page
- [ ] Click "Clone" button
- [ ] Verify wizard opens
- [ ] Verify "Clone from existing" is selected
- [ ] Verify source environment pre-selected in dropdown
- [ ] Click "Next" to advance to Source step
- [ ] Verify repo URL pre-filled
- [ ] Verify branch pre-filled (e.g., "main")
- [ ] Change branch to "develop"
- [ ] Click "Next" to Discovery step
- [ ] Verify both services pre-selected
- [ ] Uncheck "worker" service
- [ ] Click "Next" to Config step
- [ ] Verify 3 environment variables shown
- [ ] Change "NODE_ENV" value from "development" to "staging"
- [ ] Add new variable "FEATURE_FLAG" = "enabled"
- [ ] Click "Next" to Strategy step
- [ ] Change environment type to "staging"
- [ ] Set TTL to 48 hours
- [ ] Click "Next" to Review step
- [ ] Verify configuration shown
- [ ] Click "Create Environment"
- [ ] Verify provision progress shown
- [ ] Wait for completion
- [ ] Verify success, navigate to new environment

#### Verification in Railway
- [ ] Log into Railway dashboard
- [ ] Find the new environment
- [ ] Verify 1 service (api) - worker excluded
- [ ] Verify api service on "develop" branch (not main)
- [ ] Open environment variables
- [ ] Verify 4 variables total
- [ ] Verify NODE_ENV = "staging" (modified)
- [ ] Verify FEATURE_FLAG = "enabled" (new)
- [ ] Verify other 2 variables unchanged from source

#### Verification in Mirage
- [ ] Navigate to new environment detail page
- [ ] Verify environment name correct
- [ ] Verify type is "staging"
- [ ] Verify TTL shows 48 hours
- [ ] Verify 1 service listed (api)
- [ ] Query database
- [ ] Confirm NO environment variables stored locally
- [ ] Confirm only Railway IDs stored

### Automated Tests

Create `web/tests/e2e/clone.spec.ts`:
```typescript
import { test, expect } from '@playwright/test'

test.describe('Environment Cloning', () => {
  test('clone environment with modifications', async ({ page }) => {
    // Navigate to source environment
    await page.goto('/environments/test-env-id')
    
    // Click clone button
    await page.click('button:has-text("Clone")')
    
    // Verify wizard opens in clone mode
    await expect(page.locator('input[value="clone"]')).toBeChecked()
    
    // Source should be pre-selected
    await expect(page.locator('select[name="cloneSource"]')).toHaveValue('test-env-id')
    
    // Navigate to Source step
    await page.click('button:has-text("Next")')
    
    // Change branch
    const branchInput = page.locator('input[name="branch"]')
    await expect(branchInput).toHaveValue('main')
    await branchInput.fill('develop')
    
    // Navigate to Discovery
    await page.click('button:has-text("Next")')
    
    // Deselect a service
    await page.uncheck('text=worker')
    
    // Navigate to Config
    await page.click('button:has-text("Next")')
    
    // Modify a variable
    const nodeEnvInput = page.locator('input[value="development"]')
    await nodeEnvInput.fill('staging')
    
    // Navigate to Strategy
    await page.click('button:has-text("Next")')
    
    // Change type
    await page.selectOption('select[name="envType"]', 'staging')
    
    // Navigate to Review
    await page.click('button:has-text("Next")')
    
    // Create
    await page.click('button:has-text("Create Environment")')
    
    // Wait for success
    await page.waitForSelector('text=Environment created successfully', {
      timeout: 120000
    })
    
    // Verify navigation to new environment
    await expect(page).toHaveURL(/\/environments\/.*/)
    
    // Verify environment details
    await expect(page.locator('text=staging')).toBeVisible()
  })
  
  test('snapshot endpoint returns correct data', async ({ request }) => {
    const response = await request.get('/api/environments/test-env-id/snapshot')
    expect(response.ok()).toBeTruthy()
    
    const data = await response.json()
    expect(data).toHaveProperty('environment')
    expect(data).toHaveProperty('services')
    expect(data).toHaveProperty('environmentVariables')
  })
})
```

## Success Criteria

### Must Pass

- Clone button opens wizard with source pre-filled
- Branch can be changed
- Services can be excluded
- Variables can be modified and added
- Regular provision endpoints used (no special clone API)
- New environment created successfully
- Services match selection and configuration
- Variables applied from modified wizard state
- No variables stored in local database

### Performance

- Snapshot loads quickly (< 2 seconds)
- Provision completes in reasonable time (< 3 minutes)

## Verification

- [ ] Test environment created
- [ ] Manual checklist completed
- [ ] Clone workflow tested end-to-end
- [ ] Branch modification tested
- [ ] Service filtering tested
- [ ] Variable modification tested
- [ ] Regular provision endpoints verified
- [ ] Railway resources verified
- [ ] Database verified (no local env vars)
- [ ] Automated tests written
- [ ] Automated tests passing

## Files Modified

### New Files
- `web/tests/e2e/clone.spec.ts` - Playwright E2E tests
- `docs/delivery/15/test-results.md` - Test execution results
