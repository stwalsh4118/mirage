# [10-8] Add deletion functionality for projects and environments

[Back to task list](./tasks.md)

## Description
Add comprehensive deletion functionality to allow users to delete entire Railway projects or individual environments. This includes backend API endpoints, Railway GraphQL integration, frontend UI controls, and proper error handling with confirmation dialogs.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-09-30 15:00:00 | Created | N/A | Proposed | Task file created | ai-agent |
| 2025-09-30 15:15:00 | Status Change | Proposed | Agreed | Task approved by User | sean |
| 2025-09-30 15:16:00 | Status Change | Agreed | InProgress | Starting with frontend environment deletion | ai-agent |
| 2025-09-30 16:00:00 | Progress Update | InProgress | InProgress | Completed Railway environment deletion for both dashboard and project detail pages | ai-agent |
| 2025-09-30 16:30:00 | Progress Update | InProgress | InProgress | Completed all environment deletion functionality including backend API, frontend UI, and bug fixes | ai-agent |
| 2025-09-30 17:00:00 | Progress Update | InProgress | InProgress | Completed Railway project deletion functionality for backend and frontend | ai-agent |

## Requirements

### Backend Requirements
1. Implement Railway GraphQL `projectDelete` mutation wrapper in the Railway client
2. Add `DELETE /railway/project/:id` endpoint to delete entire Railway projects
3. Enhance existing `DELETE /environments/:id` endpoint to handle cascading deletes if needed
4. Add proper error handling for deletion failures (e.g., permission issues, non-existent resources)
5. Log all deletion operations with audit trail

### Frontend Requirements
1. Add "Delete Project" action to project detail views
2. Ensure "Delete Environment" action is available in environment views/cards
3. Implement confirmation dialogs for both project and environment deletion
4. Show clear warnings about data loss and irreversibility
5. Provide loading states during deletion operations
6. Handle and display deletion errors gracefully
7. Update UI state after successful deletion (remove from lists, redirect if needed)

### Safety Requirements
1. Confirmation dialogs must clearly state what will be deleted
2. Consider showing what child resources will be affected (e.g., environments in a project)
3. Prevent accidental deletions with clear UX patterns
4. Graceful handling of "already deleted" scenarios (idempotency)

## Implementation Plan

### Phase 1: Backend - Railway Client Integration
1. Add `DeleteProject` method to Railway client (`api/internal/railway/project_delete.go`)
   - Use `projectDelete` mutation from Railway GraphQL API
   - Input: project ID
   - Return: boolean success or error
2. Add proper error handling and logging

### Phase 2: Backend - Controller Endpoints
1. Add `DeleteRailwayProject` handler to EnvironmentController
   - Route: `DELETE /railway/project/:id`
   - Call Railway client's `DeleteProject` method
   - Return appropriate HTTP status codes
2. Review and enhance existing `DestroyEnvironment` endpoint if needed
   - Ensure it properly handles Railway environment deletion
   - Add any missing error cases

### Phase 3: Frontend - UI Components
1. Add delete button/action to project detail page
   - Implement confirmation dialog with project details
   - Wire up to backend DELETE endpoint
   - Handle success/error states
2. Ensure environment deletion is accessible from:
   - Dashboard environment cards
   - Environment detail view
   - Project detail page (for environments within a project)
3. Implement shared confirmation dialog component if not already present
4. Add loading states and error toasts

### Phase 4: Testing & Polish
1. Test deletion flows end-to-end
2. Test error scenarios (network failures, permission errors)
3. Verify UI updates correctly after deletions
4. Ensure audit logs are created

## Test Plan

### Backend Tests
**Objective**: Verify Railway client and controller endpoints properly handle deletion operations

**Test Scope**: Railway client `DeleteProject` method, controller endpoints

**Key Test Scenarios**:
1. **Successful project deletion**
   - Mock Railway API to return success
   - Verify client calls correct mutation with correct variables
   - Verify controller returns 204 No Content
2. **Successful environment deletion**
   - Verify existing endpoint works as expected
   - Verify Railway environment is deleted
   - Verify database record is removed
3. **Error handling**
   - Non-existent project/environment returns 404
   - Railway API errors are properly surfaced
   - Permission errors return appropriate status codes

**Success Criteria**: All backend tests pass; deletion operations are logged

### Frontend Tests
**Objective**: Verify deletion UI flows work correctly and safely

**Test Scope**: Delete buttons, confirmation dialogs, API integration

**Key Test Scenarios**:
1. **Project deletion flow**
   - Click delete button shows confirmation dialog
   - Dialog shows correct project name/details
   - Confirm triggers API call
   - Success removes project from UI
   - Error shows appropriate message
2. **Environment deletion flow**
   - Similar to project deletion
   - Available from multiple entry points
3. **Edge cases**
   - Deletion during loading states
   - Double-click prevention
   - Already-deleted resources handled gracefully

**Success Criteria**: All deletion flows work smoothly with appropriate confirmations and error handling

### Integration Tests
**Objective**: Verify end-to-end deletion against real Railway API

**Environment**: Test Railway account with disposable projects

**Key Test Scenarios**:
1. Create a test project via API, then delete it
2. Create a test environment, then delete it
3. Verify Railway API confirms deletion
4. Test cascading behavior (what happens to environments when project is deleted)

**Success Criteria**: Real deletions work correctly; no orphaned resources

## Verification
- [x] Backend endpoint `DELETE /railway/project/:id` exists and works
- [x] Railway client has `DestroyProject` method that calls Railway GraphQL API
- [x] Project deletion is accessible from UI with confirmation dialog (Dashboard + Project Detail page)
- [x] Environment deletion is accessible from multiple UI locations (Dashboard + Project Detail pages)
- [x] Confirmation dialogs clearly explain what will be deleted
- [x] Loading states prevent double-deletions
- [x] Errors are displayed to users with actionable messages
- [x] UI state updates correctly after deletion (removed from lists via React Query invalidation)
- [x] Deletion operations are logged for audit trail (backend logs deletions with appropriate warning levels)
- [ ] All tests pass (manual testing completed, automated tests not yet written)

## Files Modified

### Backend (Go)
- ✅ `api/internal/railway/env.go` - Fixed Railway `environmentDelete` mutation
  - Corrected JSON field name from 'deleteEnvironment' to 'environmentDelete'
  - Changed response type from struct{ID string} to bool
  - Simplified mutation to not select fields since it returns boolean
  - Commit: 207ed6e
- ✅ `api/internal/railway/project_delete.go` - **NEW** Railway client method for project deletion
  - Added `DestroyProject` method that calls Railway GraphQL `projectDelete` mutation
  - Returns boolean success or error
  - Warning-level logging for irreversible operations
- ✅ `api/internal/controller/projects.go` - Added deletion endpoint handlers
  - `DeleteRailwayEnvironment`: Route `DELETE /api/v1/railway/environment/:id`
  - `DeleteRailwayProject`: Route `DELETE /api/v1/railway/project/:id`
  - Both return 204 No Content on success
  - Proper error handling and logging
  - Commit: 50c790f (environment), NEW (project)
- ✅ `api/internal/controller/environment.go` - Registered deletion routes
  - Added route registration for both environment and project deletion
  - Commit: 50c790f (environment), NEW (project)

### Frontend (TypeScript/React)
- ✅ `web/src/lib/api.ts` - Fixed fetchJSON to handle 204 No Content responses
  - Added check for 204 status code before parsing JSON
  - Returns empty object for 204 responses
  - Fixes JSON parsing error on DELETE operations
  - Commit: f3ea4fc
- ✅ `web/src/lib/api/railway.ts` - Added deletion API functions
  - `deleteRailwayEnvironment()`: Calls `DELETE /api/v1/railway/environment/:id`
  - `deleteRailwayProject()`: Calls `DELETE /api/v1/railway/project/:id`
  - Both functions follow same pattern
  - Commit: 7ef0956 (environment), NEW (project)
- ✅ `web/src/hooks/useRailway.ts` - Added deletion React Query hooks
  - `useDeleteRailwayEnvironment()`: Invalidates railway-projects-details
  - `useDeleteRailwayProject()`: Invalidates both railway-projects-details and railway-projects
  - Commit: 7ef0956 (environment), NEW (project)
- ✅ `web/src/components/dashboard/RailwayEnvironmentCard.tsx` - Added delete functionality
  - Three-dot menu with delete option
  - Confirmation dialog with service count warning
  - Loading states during deletion
  - Success/error toast notifications using sonner
  - Works with or without href prop
  - Commit: 01d5bd0
- ✅ `web/src/components/project/environment-card.tsx` - Added delete functionality
  - Three-dot menu in card header
  - Confirmation dialog with detailed warnings
  - Proper event propagation handling (stops card click)
  - Loading states and toasts using sonner
  - Commit: 01d5bd0
- ✅ `web/src/components/dashboard/ProjectCard.tsx` - **NEW** Added project delete functionality
  - Three-dot menu with delete option in card header
  - Confirmation dialog showing impact (environments, services count)
  - Loading states and toast notifications using sonner
  - Destructive styling for delete action
- ✅ `web/src/components/project/project-detail.tsx` - **NEW** Added project delete to detail page
  - Delete button in Quick Actions sidebar
  - Confirmation dialog with detailed impact warning
  - Redirects to dashboard after successful deletion
  - Loading states and toast notifications using sonner

## Implementation Summary

### Completed: Railway Environment Deletion
✅ **Full implementation** of Railway environment deletion functionality:
- Backend API endpoint with proper error handling
- Railway GraphQL mutation integration (with bug fix)
- Frontend UI components in both dashboard and project detail views
- Confirmation dialogs with contextual warnings
- Loading states and error handling
- React Query integration for automatic UI updates
- Fix for 204 No Content response handling

Environment deletion commits: 50c790f, 207ed6e, 7ef0956, 01d5bd0, f3ea4fc

### Completed: Railway Project Deletion
✅ **Full implementation** of Railway project deletion functionality:
- Backend API endpoint `DELETE /api/v1/railway/project/:id`
- Railway GraphQL `projectDelete` mutation wrapper in client
- Frontend UI components:
  - Three-dot menu in ProjectCard (dashboard view)
  - Delete button in ProjectDetail Quick Actions sidebar
- Comprehensive confirmation dialogs showing:
  - Environment count
  - Service count  
  - Clear warnings about irreversibility
- Loading states and disabled buttons during deletion
- Toast notifications for success/error using sonner
- Automatic UI updates via React Query cache invalidation
- Redirect to dashboard after deletion from detail page
- Warning-level logging in backend for audit trail

Project deletion files are new (not yet committed)

### Implementation Notes
- Both deletion features follow consistent patterns:
  - Backend: Railway client method → Controller endpoint → Route registration
  - Frontend: API function → React Query hook → UI component integration
- Used sonner for toast notifications (consistent with environment cards)
- All confirmation dialogs clearly state the irreversible nature of deletions
- Loading states prevent double-clicks and race conditions
- React Query automatically invalidates and refetches affected queries
