# [10-1] Implement Environment Creation Wizard (dev/prod templates)

[Back to task list](./tasks.md)

## Description
Create a multi-step wizard that can either create a new Railway project or use an existing one, then create an environment within it and apply a selected template (dev/prod) which may provision initial services and configuration.

## Status History
| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-09-05 12:10:00 | Created | N/A | Proposed | Task created (moved from 1-9) | ai-agent |
| 2025-09-12 09:10:00 | Status Change | Proposed | Agreed | Task approved by User | sean |
| 2025-09-12 09:12:00 | Status Change | Agreed | InProgress | Started design breakdown | ai-agent |
| 2025-09-30 14:00:00 | Status Change | InProgress | Review | Core wizard UI complete; submission logic exists; needs progress UI and error handling integration | ai-agent |

## Requirements
- Step 0: Choose Project: create new Railway project or select existing.
- Step 1: Source: repo/branch selection (manual input for MVP).
- Step 2: Configuration: template (dev/prod), TTL, env var editor with inheritance preview.
- Step 3: Strategy & Review: strategy toggle (simple), review summary, confirm.
- On submit: create project if needed; create environment; apply template (provision initial services, set env vars); show progress and errors.

## Implementation Plan
- Build stepper component and forms; add project selection step.
- Client-side validation; summarize final spec; confirm dialog.
- Call backend APIs for createProject, createEnvironment, createService(s), configuration updates.
- Idempotent handling and retries; persist intermediate IDs for resume.

## Design Breakdown

### Scope and Flows
- New Project + Environment:
  1) Create Railway Project
  2) Create Environment in project
  3) Apply template (provision services, set env vars)
- Existing Project + New Environment:
  1) Select Railway Project
  2) Create Environment in project
  3) Apply template

### Wizard Steps
- Step 0: Project selection/creation
- Step 1: Source (repo/branch)
- Step 2: Configuration (template, TTL, env vars with inheritance preview)
- Step 3: Strategy & Review (sequential/parallel toggle, summary, confirm)

## UI Design

### Placement & Layout
- Route: `/dashboard/environments/new` (page, not modal). Accessible from dashboard CTA.
- Structure: page header (title, breadcrumb), horizontal stepper, content card, sticky footer actions.
- Visual style: translucent glass cards with sepia/dusty-brown base theme, subtle blur, and elevated shadows; minimal borders; high-contrast text.

### Stepper
- Shows all steps with current, completed, and upcoming states.
- Clickable to navigate back to completed steps; forward navigation gated by validation.

### Common Footer Actions
- Left: Back (disabled on Step 0), Cancel.
- Right: Next/Confirm primary button; shows loading on submit. Keyboard: Enter to continue, Esc to cancel.

### Step 0: Project selection/creation
- Controls:
  - Toggle: "Use existing project" | "Create new project".
  - Existing: searchable select of projects (name + id); async load with debounce.
  - New: text input for project name; optional default environment name.
- Validation: require either selected project or valid new name; enforce name length/charset.
- Help: explain hierarchy and that you can create envs in existing projects.

### Step 1: Source (repo/branch)
- Controls:
  - Text input for repo URL (e.g., `github.com/org/repo`).
  - Branch select/input (default `main`).
- Validation: repo URL format; branch non-empty. Allow skip if template provisions placeholder services only.
- Info: note that repo/branch may be used when creating initial services.

### Step 2: Configuration
- Controls:
  - Environment name (default from template, editable).
  - Template select: `dev` | `prod` with descriptions.
  - TTL input (hours/days) with helper.
  - Env var editor: key/value rows; inheritance preview pane (read-only list showing effective vars).
- Validation: unique env name within project (checked after selection in Step 0), TTL bounds, non-empty keys.
- UX: add/remove rows, paste multi-line `KEY=VALUE` to import.

### Step 3: Strategy & Review
- Controls:
  - Strategy toggle: Sequential | Parallel (MVP can default to Sequential; still present for future).
  - Review card: project (new/existing), env name, template, TTL, repo/branch, variables (collapsed by default).
- Actions: Confirm creates resources; shows progress screen.

### Progress & Result
- After Confirm, replace footer with progress and disable navigation; show per-stage statuses:
  1) Create Project (skip if existing)
  2) Create Environment
  3) Apply Template (services, env vars)
- Each stage shows Pending → Running → Success/Error; on error, show Retry and Cleanup options.
- On success: show "View environment" CTA to navigate to details/dashboard; persist IDs.

### Empty/Loading/Error States
- Loading skeletons for async selects.
- Inline error banners with remediation hints; fields with error messages.
- Global error fallback with support ID (requestId).

### Responsiveness & A11y
- Two-column layout collapses to single-column on small screens.
- Labels associated with inputs; ARIA roles on stepper and progress list; focus management between steps.

### Component Inventory
- `WizardLayout`, `WizardStepper`, `WizardFooter`.
- `ProjectSelector`, `RepoBranchForm`, `EnvConfigForm`, `ReviewSummary`, `ProgressList`.

### Shadcn UI components
- Core
  - Buttons: `Button`
  - Inputs: `Input`, `Textarea`
  - Selects: `Select`, `SelectTrigger`, `SelectContent`, `SelectItem`
  - Radios/Toggles: `RadioGroup`, `RadioGroupItem`, `Switch`
  - Cards/Containers: `Card`, `CardHeader`, `CardContent`, `CardFooter`
  - Forms: `Form`, `FormField`, `FormItem`, `FormLabel`, `FormControl`, `FormMessage`
  - Alerts/Feedback: `Alert`, `AlertTitle`, `AlertDescription`, `useToast`/`Toaster`
  - Dialogs/Confirms: `AlertDialog` (for destructive/confirm), `Dialog` (for auxiliary flows)
  - Progress/Status: `Progress`, `Badge`, `Skeleton`
  - Navigation: `Breadcrumb`, `Tabs` (for environment/services details elsewhere)
- Enhanced
  - Combobox/Command: `Command`, `CommandInput`, `CommandList`, `CommandItem` (project search)
  - Popover: `Popover`, `PopoverTrigger`, `PopoverContent` (combobox display)
  - Calendar/Date Picker: `Calendar` block + `Popover` (TTL presets/date)
  - Tooltip/Hover: `Tooltip`, `TooltipTrigger`, `TooltipContent`, `HoverCard` (inline help, previews)
  - Sheet/Drawer: `Sheet`, `SheetTrigger`, `SheetContent` (advanced settings)
  - Collapsible/Accordion: `Collapsible`, `CollapsibleTrigger`, `CollapsibleContent`, `Accordion` (group advanced options)
  - Resizable: `ResizablePanelGroup`, `ResizablePanel`, `ResizableHandle` (vars editor vs preview)
  - Scroll: `ScrollArea` for long lists within cards
  - ToggleGroup: `ToggleGroup`, `ToggleGroupItem` (template/strategy selection)
  - Separator: `Separator` for stepper and section dividers
  - Badges/Chips: `Badge` to show selections (repo/branch, template)
- Stepper
  - No native stepper in shadcn; compose `WizardStepper` using `Separator`, `Badge`, `Icons`, and state styles. Make steps clickable only for completed ones.
- Forms
  - Use `Form` with `react-hook-form` and `zod` resolver for validation; surface errors via `FormMessage` and `Alert` banners.
- Theming
  - Apply existing sepia/glass theme tokens to `Card` surfaces and `Button` variants; ensure sufficient contrast.

### Frontend Architecture
- Components: `Wizard`, `StepProject`, `StepSource`, `StepConfig`, `StepReview`
- State: central wizard store (React context or Zustand) with serializable state, including tentative IDs
- Data hooks: `useRailwayProjects`, `useCreateProject`, `useCreateEnvironment`, `useCreateService`, `useSetEnvVars`
- Progress UI: per-stage progress with statuses (pending, running, success, error)

### Backend Contracts (aligned to confirmed mutations)
- POST `/api/provision/project`
  - body: `{ defaultEnvironmentName?: string, requestId: string }`
  - performs GraphQL `projectCreate(input: { defaultEnvironmentName })`
  - returns: `{ projectId, baseEnvironmentId }`
- POST `/api/provision/environment`
  - body: `{ projectId: string, name?: string, requestId: string }`
  - performs GraphQL `environmentCreate(input: { projectId, name })`
  - returns: `{ environmentId }`
- POST `/api/provision/services`
  - body: `{ environmentId: string, services: [{ name: string, repo?: string, branch?: string }], requestId: string }`
  - performs GraphQL `serviceCreate(input: { environmentId, name, source: { repo }, branch })` for each service
  - returns: `{ serviceIds: string[] }`
- POST `/api/provision/envvars`
  - body: `{ projectId: string, environmentId: string, variables: [{ key: string, value: string }], requestId: string }`
  - returns: `{ ok: true }`
- All endpoints accept `requestId` for idempotency and should return created IDs even on retry

### Idempotency and Resume
- Generate a client `requestId` at submission; pass to all backend calls
- Persist intermediate `projectId`, `environmentId`, and `serviceIds`
- On error, allow retry from the failed step with existing IDs

### Error Handling
- Classify errors into validation, transient, permission
- Transient: automatic retry with backoff; show retry count
- Validation/permission: actionable guidance and links
- Cleanup affordance for partially created resources

### Telemetry
- Emit events for step started/succeeded/failed with timings and IDs (hashed)

### Security
- Never expose tokens to client; backend performs Railway calls
- Validate all inputs server-side

### Constants
- Define constants for polling intervals, retry limits, and step identifiers

### Open Items
- Confirm Railway GraphQL mutation names via introspection (see 10-5-railway-guide)
- Decide initial service templates for dev/prod

## Test Plan
- Validate form controls and navigation.
- Happy path for new project + env + template.
- Happy path for existing project + env + template.
- Failure scenarios for each step with retry guidance.

## Verification
- End-to-end creation works for both new and existing projects.
- Created environment appears on dashboard with initial services.

## Files Modified
- Frontend wizard pages/components and API hooks.

