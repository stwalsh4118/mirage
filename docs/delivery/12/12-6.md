# [12-6] Integrate Dockerfile discovery into service creation wizard

[Back to task list](./tasks.md)

## Description
Integrate the Dockerfile discovery UI into the existing environment creation wizard, adding a new step for repository scanning and service selection, then wiring selected services through to the final provisioning step.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-01 00:00:00 | Created | N/A | Proposed | Task file created | AI Agent |

## Requirements

1. Add new wizard step: "Service Discovery" between repository selection and configuration:
   - Step flow: **Source** → **Service Discovery** → **Configuration** → **Review**

2. In "Source" step, when repository is selected:
   - Show "Scan for Dockerfiles" button
   - Trigger discovery API call
   - Navigate to Service Discovery step when results return

3. In "Service Discovery" step:
   - Display `DockerfileDiscoveryView` component
   - Allow service selection
   - Allow service name editing
   - Show preview of services to be created
   - "Skip" option to continue without Dockerfile-based services

4. Wire selected services to provisioning:
   - Transform selected services into `ServiceSpec[]` format
   - Include `dockerfilePath` for each service
   - Merge with any manually configured services
   - Pass to existing `ProvisionServices` API call

5. Update wizard state management:
   - Add `discoveredServices` to wizard state
   - Add `selectedServiceIds` array
   - Add service name overrides map

6. Handle edge cases:
   - No Dockerfiles found: show message, allow skip
   - Discovery error: show error, allow retry or skip
   - User goes back: preserve selections

## Implementation Plan

1. Update wizard type definitions:
   ```typescript
   type WizardState = {
     // ... existing fields ...
     discoveredServices?: DiscoveredService[];
     selectedServiceIds?: string[];
     serviceNameOverrides?: Record<string, string>;
   };
   ```

2. Update `CreateEnvironmentDialog.tsx`:
   - Add Service Discovery step to stepper
   - Add step component for discovery UI
   - Add navigation logic

3. Create `ServiceDiscoveryStep.tsx`:
   - Integrate `DockerfileDiscoveryView`
   - Handle service selection state
   - Provide next/back/skip buttons
   - Update wizard state on selection

4. Update service provisioning logic:
   - In final provisioning step, map selected services to `ServiceSpec[]`
   - Include `dockerfilePath` field from discovery results
   - Merge with existing service specs

5. Update `useProvisionEnvironment` hook (or similar):
   - Accept discovered services
   - Transform to API format
   - Include in provisioning request

6. Add loading and error UI for discovery step

## Verification

- [ ] New Service Discovery step appears in wizard
- [ ] Discovery triggered when repository selected
- [ ] Loading state shown during scan
- [ ] Discovery results displayed correctly
- [ ] Service selection state persisted across steps
- [ ] Selected services included in final provisioning call
- [ ] `dockerfilePath` correctly passed to backend
- [ ] Skip option works (continues without discovery services)
- [ ] Back navigation preserves selections
- [ ] Error states handled gracefully
- [ ] Services created in Railway with correct Dockerfile paths

## Test Plan

### Component Tests
1. **ServiceDiscoveryStep state management**:
   - Selection updates wizard state
   - Name overrides stored correctly
   - Skip updates state appropriately

2. **Wizard flow**:
   - Step progression works correctly
   - Back/next buttons enabled appropriately
   - State persists across navigation

### Integration Tests
1. **Full wizard flow with discovery**:
   - Start wizard
   - Select repository
   - Trigger discovery
   - Select services
   - Override service name
   - Complete wizard
   - Verify services created with correct paths

2. **Skip discovery flow**:
   - Start wizard
   - Skip discovery step
   - Verify wizard completes without discovered services

3. **Error recovery flow**:
   - Trigger discovery error
   - Retry discovery
   - Verify recovery works

### End-to-End Tests
1. **Complete environment creation with Dockerfiles**:
   - Real repository with monorepo structure
   - Discover 3 services
   - Select 2 services
   - Rename 1 service
   - Complete wizard
   - Verify Railway environment created
   - Verify 2 services created with RAILWAY_DOCKERFILE_PATH set
   - Verify services deploy successfully

## Files Modified

- `web/src/components/wizard/CreateEnvironmentDialog.tsx`
- `web/src/components/wizard/ServiceDiscoveryStep.tsx` (new)
- `web/src/hooks/useProvisionEnvironment.ts` (or similar)
- `web/src/lib/api/railway.ts` (update types)

