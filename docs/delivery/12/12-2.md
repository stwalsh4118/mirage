# [12-2] Implement backend Dockerfile scanner

[Back to task list](./tasks.md)

## Description
Create a Go service that can scan a repository (from a local clone or archive) to discover all Dockerfiles, parse basic metadata, and identify service boundaries. This provides the foundation for monorepo Dockerfile discovery.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-01 00:00:00 | Created | N/A | Proposed | Task file created | AI Agent |
| 2025-10-02 00:00:00 | Status Update | Proposed | InProgress | Starting implementation with GitHub API approach | AI Agent |
| 2025-10-02 00:00:00 | Status Update | InProgress | Done | Scanner implemented with GitHub API, caching, and tests passing | sean |

## Requirements

1. Create `internal/scanner` package with Dockerfile discovery capability
2. Recursively scan directory tree for Dockerfiles:
   - Match `Dockerfile` (exact)
   - Match `*.dockerfile` patterns (e.g., `prod.dockerfile`)
   - Configurable depth limit and ignore patterns (.git, node_modules, etc.)
3. Parse Dockerfile metadata:
   - EXPOSE directives (extract port numbers)
   - ARG directives (extract build argument names)
   - FROM directive (extract base image)
4. Detect service boundaries using heuristics:
   - Look for `package.json`, `go.mod`, `requirements.txt` in same or parent directory
   - Identify conventional structure patterns (`services/`, `apps/`, `packages/`)
   - Infer service name from directory name
5. Build context detection:
   - Default to Dockerfile's parent directory
   - Support explicit WORKDIR analysis
6. Return structured results:
   ```go
   type DockerfileInfo struct {
       Path          string   // Relative path from repo root
       ServiceName   string   // Inferred service name
       BuildContext  string   // Relative path for build context
       ExposedPorts  []int    // From EXPOSE directives
       BuildArgs     []string // From ARG directives
       BaseImage     string   // From FROM directive
   }
   ```

## Implementation Plan

1. Create `api/internal/scanner/dockerfile.go`
2. Implement `ScanForDockerfiles(rootPath string) ([]DockerfileInfo, error)`
3. Implement recursive directory walker with ignore patterns
4. Implement Dockerfile parser:
   - Use simple line-by-line parsing (regex-based)
   - Extract EXPOSE, ARG, FROM directives
5. Implement service boundary detection:
   - Check for package manager manifests
   - Apply directory structure heuristics
6. Write unit tests for:
   - Dockerfile discovery in nested structures
   - Metadata parsing from various Dockerfile formats
   - Service name inference
7. Add comprehensive logging for debugging

## Verification

- [ ] Scanner discovers Dockerfiles at various depths
- [ ] Correctly identifies `*.dockerfile` patterns
- [ ] Parses EXPOSE directives correctly
- [ ] Parses ARG directives correctly
- [ ] Extracts base image from FROM directive
- [ ] Infers sensible service names from directory structure
- [ ] Respects ignore patterns (.git, node_modules)
- [ ] Returns proper build context paths
- [ ] Unit tests pass with >80% coverage

## Test Plan

### Unit Tests
Create test fixtures with sample repository structures:

**Test Scenario 1**: Simple monorepo
```
services/
  api/
    Dockerfile
    go.mod
  worker/
    Dockerfile
    package.json
```
Expected: Discovers 2 Dockerfiles, infers names "api" and "worker"

**Test Scenario 2**: Multiple Dockerfile variants
```
apps/
  frontend/
    Dockerfile
    prod.dockerfile
    package.json
```
Expected: Discovers 2 Dockerfiles in same service

**Test Scenario 3**: Nested structure
```
packages/
  backend/
    services/
      auth/
        Dockerfile
        go.mod
```
Expected: Discovers Dockerfile, infers name from context

**Test Scenario 4**: Dockerfile parsing
```dockerfile
FROM node:18-alpine
ARG NODE_ENV=production
ARG BUILD_VERSION
EXPOSE 3000
EXPOSE 9090
```
Expected: Extracts ports [3000, 9090], args [NODE_ENV, BUILD_VERSION], base "node:18-alpine"

## Files Modified

- `api/internal/scanner/dockerfile.go` (new)
- `api/internal/scanner/dockerfile_test.go` (new)

