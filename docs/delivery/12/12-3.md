# [12-3] Extend Railway service creation to support Dockerfile paths

[Back to task list](./tasks.md)

## Description
Extend the Railway client and service creation flow to support setting `RAILWAY_DOCKERFILE_PATH` as a service variable when creating services from repositories with custom Dockerfile locations.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-01 00:00:00 | Created | N/A | Proposed | Task file created | AI Agent |
| 2025-10-02 00:00:00 | Status Update | Proposed | InProgress | Starting implementation | AI Agent |
| 2025-10-02 00:00:00 | Status Update | InProgress | Review | Implementation complete, all tests passing | AI Agent |
| 2025-10-02 00:00:00 | Status Update | Review | Done | Task approved and completed | sean |

## Requirements

1. Extend `railway.CreateServiceInput` struct to support service variables:
   ```go
   type CreateServiceInput struct {
       // ... existing fields ...
       Variables map[string]string `json:"variables,omitempty"` // Service variables like RAILWAY_DOCKERFILE_PATH
   }
   ```

2. Extend Railway client to set variables during service creation:
   - Use the mutation structure researched in task 12-1
   - Handle variable setting in the `serviceCreate` mutation
   - Support multiple variables simultaneously

3. Add validation:
   - Ensure Dockerfile path is relative to repo root
   - Validate path format (no absolute paths, no `..` escaping)

4. Update `controller.ServiceSpec` to accept dockerfile path:
   ```go
   type ServiceSpec struct {
       // ... existing fields ...
       DockerfilePath *string `json:"dockerfilePath,omitempty"` // Relative path to Dockerfile
   }
   ```

5. Wire through controller â†’ client layers

6. Add logging for variable setting operations

## Implementation Plan

1. Update `api/internal/railway/service.go`:
   - Add `Variables` field to `CreateServiceInput`
   - Modify `CreateService` to include variables in mutation
   - Use mutation structure from task 12-1 guide

2. Update `api/internal/controller/services.go`:
   - Add `DockerfilePath` to `ServiceSpec`
   - In `ProvisionServices`, if `DockerfilePath` is set:
     - Create variables map with `RAILWAY_DOCKERFILE_PATH` key
     - Pass to Railway client

3. Add validation helper:
   - Create `validateDockerfilePath(path string) error`
   - Check for absolute paths, parent directory traversal
   - Ensure path is reasonable (not empty, reasonable length)

4. Update tests:
   - Unit test for variable passing in Railway client
   - Integration test for service creation with dockerfile path

## Verification

- [x] `CreateServiceInput` includes `Variables` field
- [x] Railway mutation correctly sets service variables
- [x] `ServiceSpec` includes `DockerfilePath` field
- [x] Controller correctly maps `DockerfilePath` to `RAILWAY_DOCKERFILE_PATH` variable
- [x] Path validation rejects invalid paths
- [x] Service creation succeeds with custom Dockerfile path
- [x] Railway builds from specified Dockerfile location (via variable setting)
- [x] Logging shows variable setting operations

## Test Plan

### Unit Tests
1. Test variable passing in Railway client:
   - Mock GraphQL call
   - Verify variables are included in mutation input
   - Verify mutation structure matches Railway API

2. Test controller mapping:
   - Verify `DockerfilePath` is correctly converted to `RAILWAY_DOCKERFILE_PATH`
   - Verify missing dockerfile path doesn't break existing functionality

3. Test path validation:
   - Reject absolute paths (`/services/api/Dockerfile`)
   - Reject parent traversal (`../../Dockerfile`)
   - Accept valid relative paths (`services/api/Dockerfile`)

### Integration Tests
Create service with custom Dockerfile path and verify:
1. Service is created successfully
2. Railway variable is set correctly
3. Subsequent deployments use the specified Dockerfile
4. Build context is correctly inferred by Railway

## Files Modified

- `api/internal/railway/service.go` - Added Variables field to CreateServiceInput; updated CreateService to include variables in mutation
- `api/internal/controller/services.go` - Added DockerfilePath to ServiceSpec; added validateDockerfilePath function; updated ProvisionServices to map DockerfilePath to RAILWAY_DOCKERFILE_PATH; added logging
- `api/internal/railway/service_test.go` - Added TestCreateServiceInput_WithVariables to test variable passing
- `api/internal/controller/services_test.go` - Added tests for path validation (TestValidateDockerfilePath_ValidPaths, TestValidateDockerfilePath_InvalidPaths, TestValidateDockerfilePath_MaxLength) and integration tests (TestProvisionServices_WithDockerfilePath, TestProvisionServices_DockerfilePathOnlyForRepoDeployment, TestProvisionServices_InvalidDockerfilePath)

