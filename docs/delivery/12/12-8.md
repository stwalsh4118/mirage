# [12-8] Enhance wizard to support per-service environment variables

[Back to task list](./tasks.md)

## Description
Enhance the environment variable configuration in the wizard to support both global (environment-level) and service-specific variables. With the ability to provision multiple services through service discovery, users need to configure different environment variables for each service while also supporting shared variables across all services.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-03 00:00:00 | Created | N/A | Proposed | Task file created | AI Agent |
| 2025-10-03 12:22:00 | Status Update | Proposed | InProgress | Started implementation of per-service environment variables | AI Agent |
| 2025-10-03 12:22:00 | Status Update | InProgress | Review | Implementation complete with backend and frontend changes | AI Agent |
| 2025-10-03 14:30:00 | Status Update | Review | Done | All features implemented and tested, including paste-to-parse functionality | Sean |

## Requirements

### 1. Data Model Changes

**Frontend Wizard State** (`web/src/store/wizard.ts`):
- Modify `environmentVariables` to support both global and per-service variables
- Add `serviceEnvironmentVariables` to store service-specific env vars
- Structure:
  ```typescript
  // Global variables applied to all services
  environmentVariables: Array<{ key: string; value: string }>;
  
  // Per-service variables (keyed by service index or name)
  serviceEnvironmentVariables: Record<number, Array<{ key: string; value: string }>>;
  ```

**Backend Service Spec** (`api/internal/controller/services.go`):
- The `EnvVars` field already exists in `ServiceSpec` but is not being used
- Need to wire it up to the Railway service creation

### 2. UX Design

**Option A: Inline Configuration in Discovery Step**
- Add expandable section for each discovered service
- Show "Configure Variables" button/accordion per service
- Inline editor for service-specific variables
- Visual indicator showing which services have custom variables

**Option B: Dedicated Configuration Step**
- Add new step between Discovery and Config: "Service Configuration"
- Show tabs or sections for each selected service
- Configure variables for each service individually
- Show inherited global variables with ability to override

**Option C: Enhanced Config Step**
- Keep Config step but enhance it
- Show "Global Variables" section (applies to all)
- Show "Service-Specific Variables" section below
- Dropdown/tabs to select which service to configure
- Show preview of effective variables for each service

**Recommended Approach**: Option C - Enhanced Config Step
- Maintains linear wizard flow
- Clearly separates global vs service-specific concerns
- Users can set common variables once
- Advanced users can customize per-service as needed

### 3. Variable Merging Strategy

When creating services, variables should be merged in this order:
1. Start with global environment variables
2. Merge service-specific variables (overrides global)
3. Add system variables (e.g., `RAILWAY_DOCKERFILE_PATH`)

Example:
```
Global: { PORT: "3000", NODE_ENV: "production" }
Service "api" specific: { PORT: "8080", DB_NAME: "api_db" }
System: { RAILWAY_DOCKERFILE_PATH: "services/api/Dockerfile" }

Result for "api" service:
{
  PORT: "8080",           // Overridden by service-specific
  NODE_ENV: "production", // From global
  DB_NAME: "api_db",      // Service-specific only
  RAILWAY_DOCKERFILE_PATH: "services/api/Dockerfile" // System
}
```

### 4. UI Components

**Service Variable Editor**:
- Reusable component for editing variables
- Shows variable source (global/service-specific/system)
- Allows add/edit/delete operations
- Shows visual diff when overriding global variables

**Variable Preview Panel**:
- Shows effective variables for selected service
- Color-coded by source (global/service/system)
- Tooltip explaining each variable's origin

### 5. Backend Integration

**Update `CreateEnvironmentDialog.tsx` provisioning logic**:
```typescript
// Build services with merged variables
servicesToCreate.forEach((service, index) => {
  const globalVars = Object.fromEntries(
    state.environmentVariables
      .filter(v => v.key.trim())
      .map(v => [v.key, v.value])
  );
  
  const serviceVars = Object.fromEntries(
    (state.serviceEnvironmentVariables[index] || [])
      .filter(v => v.key.trim())
      .map(v => [v.key, v.value])
  );
  
  // Merge: service-specific overrides global
  const mergedVars = { ...globalVars, ...serviceVars };
  
  service.environmentVariables = mergedVars;
});
```

**Update `services.go` to use `EnvVars` field**:
```go
// In ProvisionServices function, merge service env vars with system vars
if s.EnvVars != nil && len(s.EnvVars) > 0 {
    if input.Variables == nil {
        input.Variables = make(map[string]string)
    }
    
    // Add all user-specified env vars
    for k, v := range s.EnvVars {
        input.Variables[k] = v
    }
}

// System variables like RAILWAY_DOCKERFILE_PATH are added after
// so they always take precedence
if s.DockerfilePath != nil && *s.DockerfilePath != "" {
    if input.Variables == nil {
        input.Variables = make(map[string]string)
    }
    input.Variables["RAILWAY_DOCKERFILE_PATH"] = *s.DockerfilePath
}
```

### 6. Validation

- Validate variable key names (no spaces, valid identifiers)
- Warn about overriding system variables (RAILWAY_*)
- Show confirmation when service-specific vars override global vars
- Validate no duplicate keys within same service
- Check for common mistakes (e.g., `PORT` as string vs number)

### 7. Edge Cases

- **No services selected**: Only global variables matter
- **Single service**: Service-specific vars still useful for clarity
- **Skipped discovery**: Falls back to current behavior (global only)
- **Image-based deployment**: Variables should still work
- **Empty variable values**: Allow empty strings as valid values

## Implementation Plan

### Phase 1: Backend Changes (10 min)

1. **Update `services.go`**:
   - Modify `ProvisionServices` to merge `EnvVars` into `Variables`
   - Ensure system variables (RAILWAY_DOCKERFILE_PATH) are added last
   - Add logging for merged variables

2. **Add tests**:
   - Test variable merging logic
   - Test that RAILWAY_DOCKERFILE_PATH takes precedence
   - Test with empty/nil EnvVars

### Phase 2: Frontend State (15 min)

1. **Update `wizard.ts`**:
   - Add `serviceEnvironmentVariables` field
   - Update initial state
   - Add helper methods for managing service variables

2. **Update types**:
   - Add TypeScript types for service-specific variables
   - Update `ProvisionServicesRequest` type

### Phase 3: UI Components (30 min)

1. **Create `ServiceVariableEditor.tsx`**:
   - Component for editing service-specific variables
   - Show inherited global variables (read-only)
   - Allow adding service-specific variables
   - Show override indicators

2. **Create `VariableSourceBadge.tsx`**:
   - Visual badge showing variable source (global/service/system)
   - Color-coded badges
   - Tooltips with explanations

3. **Update `StepConfig.tsx`**:
   - Add "Service-Specific Variables" section
   - Service selector (tabs or dropdown)
   - Integrate `ServiceVariableEditor` component
   - Add preview panel

### Phase 4: Integration (20 min)

1. **Update `CreateEnvironmentDialog.tsx`**:
   - Modify service creation to merge variables
   - Pass merged variables in `environmentVariables` field
   - Add logging for debugging

2. **Update `StepReview.tsx`**:
   - Show per-service variable summary
   - Indicate which services have custom variables
   - Expandable view of effective variables per service

### Phase 5: Testing & Polish (15 min)

1. **Manual testing**:
   - Test with multiple services
   - Test variable overrides
   - Test with discovery skipped
   - Test with image-based deployment

2. **Polish**:
   - Add helpful tooltips
   - Add validation messages
   - Improve loading states

## Verification

### Backend
- [x] `EnvVars` field is wired to `Variables` in service creation
- [x] Variables are merged correctly (user vars + system vars)
- [x] `RAILWAY_DOCKERFILE_PATH` takes precedence over user vars
- [x] Empty/nil `EnvVars` handled gracefully
- [x] Logging shows merged variables for debugging

### Frontend State
- [x] `serviceEnvironmentVariables` added to wizard state
- [x] State persists across navigation (zustand persistence)
- [x] Service-specific variables cleared when service deselected (state management)
- [x] Global variables persist independently

### UI Components
- [x] Service variable editor shows inherited global variables
- [x] Can add/edit/delete service-specific variables
- [x] Variable source badges display correctly
- [x] Override indicators show when service var overrides global
- [x] Preview panel shows effective variables

### Integration
- [x] Multiple services created with correct variables
- [x] Global variables applied to all services
- [x] Service-specific overrides work correctly
- [x] System variables not overridden by user variables
- [x] Review step shows accurate variable summary

### Edge Cases
- [x] Works with single service
- [x] Works with discovery skipped (fallback to global only)
- [x] Works with image-based deployment
- [ ] Handles empty variable values (assumed working, needs manual testing)
- [ ] Validates variable key names (not implemented yet, can be future enhancement)

## Test Plan

### Unit Tests

**Backend** (`api/internal/controller/services_test.go`):
```go
func TestProvisionServices_WithEnvVars(t *testing.T) {
    tests := []struct {
        name           string
        envVars        map[string]string
        dockerfilePath *string
        expected       map[string]string
    }{
        {
            name: "env vars only",
            envVars: map[string]string{"PORT": "8080", "NODE_ENV": "prod"},
            expected: map[string]string{"PORT": "8080", "NODE_ENV": "prod"},
        },
        {
            name: "dockerfile path only",
            dockerfilePath: ptrString("services/api/Dockerfile"),
            expected: map[string]string{"RAILWAY_DOCKERFILE_PATH": "services/api/Dockerfile"},
        },
        {
            name: "both env vars and dockerfile path",
            envVars: map[string]string{"PORT": "8080"},
            dockerfilePath: ptrString("services/api/Dockerfile"),
            expected: map[string]string{
                "PORT": "8080",
                "RAILWAY_DOCKERFILE_PATH": "services/api/Dockerfile",
            },
        },
        {
            name: "env var tries to override RAILWAY_DOCKERFILE_PATH",
            envVars: map[string]string{"RAILWAY_DOCKERFILE_PATH": "wrong/path"},
            dockerfilePath: ptrString("correct/path/Dockerfile"),
            expected: map[string]string{
                "RAILWAY_DOCKERFILE_PATH": "correct/path/Dockerfile", // System var wins
            },
        },
    }
    
    // Test implementation...
}
```

**Frontend** (`web/src/components/wizard/steps/StepConfig.test.tsx`):
- Test variable merging logic
- Test override indicators
- Test service selector

### Integration Tests

1. **Full flow with multiple services**:
   - Create environment with 3 discovered services
   - Set global variables: `NODE_ENV=production`, `LOG_LEVEL=info`
   - Set service-specific for "api": `PORT=8080`, `DB_NAME=api_db`
   - Set service-specific for "worker": `PORT=8081`, `QUEUE_NAME=jobs`
   - Verify "api" service gets: NODE_ENV, LOG_LEVEL, PORT=8080, DB_NAME, RAILWAY_DOCKERFILE_PATH
   - Verify "worker" service gets: NODE_ENV, LOG_LEVEL, PORT=8081, QUEUE_NAME, RAILWAY_DOCKERFILE_PATH
   - Verify "web" service gets: NODE_ENV, LOG_LEVEL, RAILWAY_DOCKERFILE_PATH (global only)

2. **Override behavior**:
   - Set global `PORT=3000`
   - Override in service "api" with `PORT=8080`
   - Verify service gets PORT=8080, not 3000
   - Verify other services still get PORT=3000

3. **System variable precedence**:
   - Try to set `RAILWAY_DOCKERFILE_PATH` as service variable
   - Verify it gets overridden by system-generated value
   - Verify warning is shown to user

### E2E Tests

1. **Complete wizard flow with per-service variables**:
   - Select repository with monorepo
   - Discover 2+ services
   - Set global variables
   - Set service-specific variables for one service
   - Complete wizard
   - Verify services created in Railway with correct variables

2. **Variable source indicators**:
   - Set global variable `NODE_ENV=production`
   - Set service-specific `PORT=8080` for one service
   - Verify preview shows:
     - `NODE_ENV` with "global" badge
     - `PORT` with "service" badge
     - `RAILWAY_DOCKERFILE_PATH` with "system" badge

## Files Modified

**Backend**:
- `api/internal/controller/services.go` - Wired up `EnvVars` to `Variables`, implemented merging logic with system vars taking precedence
- `api/internal/controller/services_test.go` - Added comprehensive tests for variable merging including multi-service scenarios

**Frontend**:
- `web/src/store/wizard.ts` - Added `serviceEnvironmentVariables` field to wizard state
- `web/src/components/wizard/steps/StepConfig.tsx` - Added service-specific variable configuration with tabs for each service
- `web/src/components/wizard/CreateEnvironmentDialog.tsx` - Updated provisioning to merge global and service-specific variables
- `web/src/components/wizard/steps/StepReview.tsx` - Updated to show per-service variable summary
- `web/src/components/wizard/ServiceVariableEditor.tsx` (new) - Complete editor for service variables with preview
- `web/src/components/wizard/VariableSourceBadge.tsx` (new) - Badge component showing variable source (global/service/system)

## Dependencies

- Task 12-6 (Completed) - Requires service discovery integration
- Railway Variables Guide (12-1-railway-variables-guide.md) - Reference for implementation

## Open Questions

1. Should we validate Railway-specific variable names (warn about RAILWAY_* prefix)?
2. Should we provide variable templates/suggestions (e.g., PORT, NODE_ENV, etc.)?
3. Should we support importing variables from .env files?
4. Should we support variable interpolation (e.g., `DB_URL=${DB_HOST}:${DB_PORT}`)?
5. How should we handle variables with sensitive values (passwords, API keys)?

## Notes

- The backend `ServiceSpec.EnvVars` field already exists but is currently unused
- Railway merges variables at service level, so our merging happens client-side before sending
- System variables (RAILWAY_*) should always take precedence to avoid configuration errors
- Consider adding a "Copy from service" feature to duplicate variable config
- Future enhancement: Support for shared variable templates across environments

