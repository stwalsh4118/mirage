# [14-6] Create LogViewer React component with virtual scrolling

[Back to task list](./tasks.md)

## Description

Build the main LogViewer React component that displays logs with virtual scrolling for performance, syntax highlighting for structured logs, color-coded severity levels, and expandable long lines. This is the core UI component for the logs viewing feature.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-04 00:00:00 | Created | N/A | Proposed | Task file created | ai-agent |

## Requirements

1. **Component Structure**:
   - Create `LogViewer` component in `web/src/components/logs/`
   - Accept props: logs array, loading state, onLoadMore callback
   - Use existing UI component library (shadcn/ui) for consistent styling

2. **Virtual Scrolling**:
   - Implement virtualization for rendering 10,000+ log lines efficiently
   - Use `react-window` or `@tanstack/react-virtual` library
   - Support infinite scroll to load historical logs
   - Auto-scroll to bottom when new logs arrive (toggle-able)

3. **Log Display Styling**:
   - Monospace font (use existing font-mono from Tailwind)
   - Zebra striping: alternating background colors
   - Color-coded severity levels:
     - ERROR: red background (`bg-red-500/20 text-red-700`)
     - WARN: yellow background (`bg-yellow-500/20 text-yellow-700`)
     - INFO: default/blue tint
     - DEBUG: muted gray
   - Service name badge with consistent colors per service
   - Timestamp in muted color (use `text-muted-foreground`)
   - Line numbers in gutter

4. **Interactive Features**:
   - Expandable long lines (truncate at ~200 chars with "..." and expand button)
   - Copy log line to clipboard (button appears on hover)
   - Highlight search matches with yellow background
   - Jump to top/bottom buttons (floating action buttons)
   - Context menu: right-click to filter by service, highlight errors

5. **Performance Optimization**:
   - Limit in-memory buffer (e.g., last 5000 lines)
   - Debounce scroll events
   - Memoize log line components
   - Use React.memo for optimization

6. **Empty and Loading States**:
   - Show skeleton loader while loading
   - Display "No logs available" empty state with helpful message
   - Show error state with retry button

7. **Accessibility**:
   - Semantic HTML (use `<code>`, `<pre>` where appropriate)
   - Keyboard navigation support
   - ARIA labels for interactive elements

## Implementation Plan

1. **Install Dependencies**:
   ```bash
   pnpm add @tanstack/react-virtual
   ```

2. **Create Component Structure**:
   ```
   web/src/components/logs/
   ├── LogViewer.tsx           # Main container component
   ├── LogLine.tsx             # Individual log line component
   ├── LogSeverityBadge.tsx    # Severity indicator
   ├── ServiceBadge.tsx        # Service name badge
   ├── LogViewerControls.tsx   # Top controls (auto-scroll toggle, etc.)
   └── EmptyLogState.tsx       # Empty state component
   ```

3. **Implement LogViewer Component**:
   ```tsx
   import { useVirtualizer } from '@tanstack/react-virtual'
   import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
   import { Button } from '@/components/ui/button'
   import { LogLine } from './LogLine'

   interface Log {
     timestamp: string
     severity: string
     message: string
     serviceName: string
     rawLine: string
   }

   interface LogViewerProps {
     logs: Log[]
     loading?: boolean
     onLoadMore?: () => void
     searchQuery?: string
     autoScroll?: boolean
     onToggleAutoScroll?: () => void
   }

   export function LogViewer({ logs, loading, onLoadMore, searchQuery, autoScroll }: LogViewerProps) {
     const parentRef = useRef<HTMLDivElement>(null)
     
     const virtualizer = useVirtualizer({
       count: logs.length,
       getScrollElement: () => parentRef.current,
       estimateSize: () => 28, // Approximate height of log line
       overscan: 10,
     })

     // Auto-scroll logic
     useEffect(() => {
       if (autoScroll && parentRef.current) {
         parentRef.current.scrollTop = parentRef.current.scrollHeight
       }
     }, [logs, autoScroll])

     // Infinite scroll for loading more logs
     useEffect(() => {
       if (virtualizer.range && virtualizer.range.startIndex === 0 && onLoadMore) {
         onLoadMore()
       }
     }, [virtualizer.range?.startIndex])

     return (
       <Card className="glass grain">
         <CardHeader>
           <CardTitle className="flex items-center justify-between">
             Logs
             <LogViewerControls autoScroll={autoScroll} onToggleAutoScroll={onToggleAutoScroll} />
           </CardTitle>
         </CardHeader>
         <CardContent>
           <div
             ref={parentRef}
             className="h-[600px] overflow-auto bg-muted/30 rounded-lg border border-border/50 font-mono text-sm"
           >
             <div
               style={{
                 height: `${virtualizer.getTotalSize()}px`,
                 width: '100%',
                 position: 'relative',
               }}
             >
               {virtualizer.getVirtualItems().map((virtualRow) => {
                 const log = logs[virtualRow.index]
                 return (
                   <div
                     key={virtualRow.index}
                     style={{
                       position: 'absolute',
                       top: 0,
                       left: 0,
                       width: '100%',
                       height: `${virtualRow.size}px`,
                       transform: `translateY(${virtualRow.start}px)`,
                     }}
                   >
                     <LogLine
                       log={log}
                       lineNumber={virtualRow.index + 1}
                       searchQuery={searchQuery}
                     />
                   </div>
                 )
               })}
             </div>
           </div>
         </CardContent>
       </Card>
     )
   }
   ```

4. **Implement LogLine Component**:
   ```tsx
   import { memo } from 'react'
   import { LogSeverityBadge } from './LogSeverityBadge'
   import { ServiceBadge } from './ServiceBadge'
   import { Button } from '@/components/ui/button'
   import { Copy } from 'lucide-react'
   import { cn } from '@/lib/utils'

   interface LogLineProps {
     log: Log
     lineNumber: number
     searchQuery?: string
   }

   export const LogLine = memo(function LogLine({ log, lineNumber, searchQuery }: LogLineProps) {
     const [expanded, setExpanded] = useState(false)
     const isLongMessage = log.message.length > 200

     const handleCopy = () => {
       navigator.clipboard.writeText(log.rawLine)
       toast.success('Copied to clipboard')
     }

     const severityColors = {
       ERROR: 'bg-red-500/10 border-l-4 border-l-red-500',
       WARN: 'bg-yellow-500/10 border-l-4 border-l-yellow-500',
       INFO: 'bg-blue-500/5 border-l-4 border-l-blue-500',
       DEBUG: 'bg-muted/50 border-l-4 border-l-muted',
     }

     return (
       <div
         className={cn(
           'flex items-start gap-2 px-2 py-1 hover:bg-accent/10 group',
           severityColors[log.severity] || 'border-l-4 border-l-transparent'
         )}
       >
         <span className="text-muted-foreground text-xs w-12 text-right flex-shrink-0">
           {lineNumber}
         </span>
         <span className="text-muted-foreground text-xs w-20 flex-shrink-0">
           {new Date(log.timestamp).toLocaleTimeString()}
         </span>
         <ServiceBadge serviceName={log.serviceName} />
         <LogSeverityBadge severity={log.severity} />
         <code className="flex-1 whitespace-pre-wrap break-all">
           {highlightSearch(expanded ? log.message : truncateMessage(log.message, 200), searchQuery)}
           {isLongMessage && !expanded && (
             <Button variant="link" size="sm" onClick={() => setExpanded(true)}>
               ...more
             </Button>
           )}
         </code>
         <Button
           variant="ghost"
           size="sm"
           className="opacity-0 group-hover:opacity-100 flex-shrink-0"
           onClick={handleCopy}
         >
           <Copy className="h-3 w-3" />
         </Button>
       </div>
     )
   })

   function highlightSearch(text: string, query?: string) {
     if (!query) return text
     // Implement highlighting logic
   }
   ```

5. **Implement Supporting Components**:
   - LogSeverityBadge: Small badge with severity level
   - ServiceBadge: Colored badge with service name
   - LogViewerControls: Auto-scroll toggle, jump buttons
   - EmptyLogState: Message when no logs available

6. **Styling**:
   - Use existing `glass grain` pattern for consistency
   - Use `border-border/50` for borders
   - Use existing color palette from theme
   - Ensure responsive design

7. **Testing**:
   - Unit tests for log line rendering
   - Test virtualization with large datasets
   - Test search highlighting
   - Test copy to clipboard
   - Test auto-scroll behavior

## Verification

- [ ] LogViewer component created in `web/src/components/logs/`
- [ ] Virtual scrolling works smoothly with 10,000+ lines
- [ ] Severity levels color-coded correctly
- [ ] Service badges displayed with consistent colors
- [ ] Timestamps formatted correctly
- [ ] Line numbers displayed in gutter
- [ ] Long messages can be expanded
- [ ] Copy to clipboard works
- [ ] Search highlighting works
- [ ] Auto-scroll toggle works
- [ ] Jump to top/bottom buttons work
- [ ] Empty state displays correctly
- [ ] Loading skeleton shows while loading
- [ ] Component follows existing styling patterns (glass grain)
- [ ] No performance issues with large log volumes
- [ ] Tests added and passing

## Files Modified

- **New**: `web/src/components/logs/LogViewer.tsx`
- **New**: `web/src/components/logs/LogLine.tsx`
- **New**: `web/src/components/logs/LogSeverityBadge.tsx`
- **New**: `web/src/components/logs/ServiceBadge.tsx`
- **New**: `web/src/components/logs/LogViewerControls.tsx`
- **New**: `web/src/components/logs/EmptyLogState.tsx`
- **Modified**: `package.json` (add @tanstack/react-virtual)

## Test Plan

### Component Tests

```tsx
import { render, screen } from '@testing-library/react'
import { LogViewer } from './LogViewer'

describe('LogViewer', () => {
  const mockLogs = [
    {
      timestamp: '2024-01-01T12:00:00Z',
      severity: 'INFO',
      message: 'Server started',
      serviceName: 'api',
      rawLine: '[INFO] Server started',
    },
    {
      timestamp: '2024-01-01T12:00:01Z',
      severity: 'ERROR',
      message: 'Database connection failed',
      serviceName: 'api',
      rawLine: '[ERROR] Database connection failed',
    },
  ]

  it('renders log lines', () => {
    render(<LogViewer logs={mockLogs} />)
    expect(screen.getByText('Server started')).toBeInTheDocument()
    expect(screen.getByText('Database connection failed')).toBeInTheDocument()
  })

  it('highlights errors with red background', () => {
    render(<LogViewer logs={mockLogs} />)
    const errorLine = screen.getByText('Database connection failed').closest('div')
    expect(errorLine).toHaveClass('bg-red-500/10')
  })

  it('displays empty state when no logs', () => {
    render(<LogViewer logs={[]} />)
    expect(screen.getByText('No logs available')).toBeInTheDocument()
  })

  it('calls onLoadMore when scrolling to top', async () => {
    const onLoadMore = jest.fn()
    render(<LogViewer logs={mockLogs} onLoadMore={onLoadMore} />)
    // Simulate scroll to top
    // Assert onLoadMore called
  })
})
```

### Performance Tests

```tsx
it('handles large log volumes without lag', () => {
  const largeLogs = Array.from({ length: 10000 }, (_, i) => ({
    timestamp: new Date().toISOString(),
    severity: 'INFO',
    message: `Log line ${i}`,
    serviceName: 'api',
    rawLine: `Log line ${i}`,
  }))

  const { container } = render(<LogViewer logs={largeLogs} />)
  
  // Verify only visible logs are rendered (virtual scrolling working)
  const renderedLines = container.querySelectorAll('[data-log-line]')
  expect(renderedLines.length).toBeLessThan(100) // Should only render visible viewport
})
```

### Manual Testing Checklist
- [ ] Load 10,000+ logs and verify smooth scrolling
- [ ] Verify color coding for different severity levels
- [ ] Test expanding long log messages
- [ ] Test copy to clipboard functionality
- [ ] Test search highlighting
- [ ] Test auto-scroll toggle
- [ ] Test jump to top/bottom buttons
- [ ] Verify consistent styling with rest of app
- [ ] Test on mobile viewport

### Success Criteria
- Virtual scrolling performs well with 10,000+ lines
- All interactive features work correctly
- Styling matches existing app patterns
- No memory leaks or performance degradation
- Tests pass

