# [14-7] Implement log filtering and search controls UI

[Back to task list](./tasks.md)

## Description

Create the filter controls component that allows users to filter logs by service, time range, severity level, and search text. This component will be placed above the LogViewer and control what logs are displayed.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2025-10-04 00:00:00 | Created | N/A | Proposed | Task file created | ai-agent |

## Requirements

1. **Filter Controls Component**:
   - Create `LogFilterControls` component in `web/src/components/logs/`
   - Horizontal layout with responsive design
   - Consistent styling with existing app patterns (glass grain)

2. **Service Filter**:
   - Multi-select dropdown for services
   - Show all services in the environment
   - "Select All" / "Deselect All" options
   - Display count of selected services

3. **Time Range Picker**:
   - Quick picks: Last 15 min, 1 hour, 6 hours, 24 hours, 7 days
   - Custom date/time picker option
   - Display selected range clearly
   - Default to "Last 1 hour"

4. **Search Input**:
   - Text input with search icon
   - Debounced input (300-500ms delay)
   - Clear button when text present
   - Regex mode toggle checkbox
   - Placeholder: "Search logs..."

5. **Log Level Filter**:
   - Checkboxes or toggle buttons for: DEBUG, INFO, WARN, ERROR
   - Default: all enabled
   - Visual indicator of active filters

6. **Additional Controls**:
   - Export button with dropdown (JSON, CSV, TXT)
   - Auto-scroll toggle switch
   - Pause/Resume streaming button (when streaming active)
   - Reset all filters button

7. **State Management**:
   - Filters should be stored in URL query parameters for shareability
   - Parse URL params on component mount
   - Update URL when filters change (without page reload)

8. **UX Considerations**:
   - Filter changes should debounce before applying
   - Show loading indicator when filters are being applied
   - Display active filter count badge
   - Responsive: collapse to menu on mobile

## Implementation Plan

1. **Create Component Structure**:
   ```
   web/src/components/logs/
   ├── LogFilterControls.tsx        # Main filter bar
   ├── ServiceMultiSelect.tsx       # Service filter component
   ├── TimeRangePicker.tsx          # Time range selector
   ├── LogLevelFilter.tsx           # Severity level checkboxes
   └── ExportButton.tsx             # Export dropdown
   ```

2. **Define Filter State Type**:
   ```tsx
   interface LogFilters {
     services: string[]           // Selected service IDs
     from: Date | null             // Start time
     to: Date | null               // End time
     search: string                // Search query
     regexMode: boolean            // Enable regex search
     levels: string[]              // Selected log levels
     autoScroll: boolean           // Auto-scroll enabled
     streaming: boolean            // Streaming enabled
   }
   ```

3. **Implement LogFilterControls**:
   ```tsx
   import { Input } from '@/components/ui/input'
   import { Button } from '@/components/ui/button'
   import { Badge } from '@/components/ui/badge'
   import { Search, Play, Pause, RotateCcw } from 'lucide-react'
   import { ServiceMultiSelect } from './ServiceMultiSelect'
   import { TimeRangePicker } from './TimeRangePicker'
   import { LogLevelFilter } from './LogLevelFilter'
   import { ExportButton } from './ExportButton'

   interface LogFilterControlsProps {
     services: Service[]
     filters: LogFilters
     onFiltersChange: (filters: LogFilters) => void
     onExport: (format: 'json' | 'csv' | 'txt') => void
     streaming?: boolean
     onToggleStreaming?: () => void
   }

   export function LogFilterControls({
     services,
     filters,
     onFiltersChange,
     onExport,
     streaming,
     onToggleStreaming,
   }: LogFilterControlsProps) {
     const [searchInput, setSearchInput] = useState(filters.search)
     
     // Debounce search input
     useEffect(() => {
       const timer = setTimeout(() => {
         onFiltersChange({ ...filters, search: searchInput })
       }, 400)
       return () => clearTimeout(timer)
     }, [searchInput])

     // Sync URL params
     useEffect(() => {
       const params = new URLSearchParams(window.location.search)
       // Parse URL params and update filters
     }, [])

     useEffect(() => {
       // Update URL when filters change
       const params = new URLSearchParams()
       if (filters.services.length) params.set('services', filters.services.join(','))
       if (filters.search) params.set('search', filters.search)
       // ... other params
       window.history.replaceState({}, '', `?${params.toString()}`)
     }, [filters])

     const activeFilterCount = [
       filters.services.length > 0 && filters.services.length < services.length,
       filters.search.length > 0,
       filters.from !== null,
       filters.levels.length > 0 && filters.levels.length < 4,
     ].filter(Boolean).length

     return (
       <div className="glass grain rounded-lg border border-border/60 p-4 space-y-4">
         <div className="flex flex-wrap items-center gap-3">
           {/* Service Filter */}
           <ServiceMultiSelect
             services={services}
             selected={filters.services}
             onChange={(selected) => onFiltersChange({ ...filters, services: selected })}
           />

           {/* Time Range Picker */}
           <TimeRangePicker
             from={filters.from}
             to={filters.to}
             onChange={(from, to) => onFiltersChange({ ...filters, from, to })}
           />

           {/* Search Input */}
           <div className="relative flex-1 min-w-[200px]">
             <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
             <Input
               placeholder="Search logs..."
               value={searchInput}
               onChange={(e) => setSearchInput(e.target.value)}
               className="pl-10"
             />
             {searchInput && (
               <Button
                 variant="ghost"
                 size="sm"
                 className="absolute right-2 top-1/2 -translate-y-1/2"
                 onClick={() => setSearchInput('')}
               >
                 ×
               </Button>
             )}
           </div>

           {/* Regex Toggle */}
           <label className="flex items-center gap-2 text-sm">
             <input
               type="checkbox"
               checked={filters.regexMode}
               onChange={(e) => onFiltersChange({ ...filters, regexMode: e.target.checked })}
             />
             Regex
           </label>

           {/* Actions */}
           <div className="flex items-center gap-2">
             {streaming && (
               <Button
                 variant="outline"
                 size="sm"
                 onClick={onToggleStreaming}
               >
                 {filters.streaming ? <Pause className="h-4 w-4 mr-2" /> : <Play className="h-4 w-4 mr-2" />}
                 {filters.streaming ? 'Pause' : 'Resume'}
               </Button>
             )}

             <ExportButton onExport={onExport} />

             {activeFilterCount > 0 && (
               <Button
                 variant="outline"
                 size="sm"
                 onClick={() => onFiltersChange({
                   services: [],
                   from: null,
                   to: null,
                   search: '',
                   regexMode: false,
                   levels: ['DEBUG', 'INFO', 'WARN', 'ERROR'],
                   autoScroll: true,
                   streaming: filters.streaming,
                 })}
               >
                 <RotateCcw className="h-4 w-4 mr-2" />
                 Reset
                 <Badge variant="secondary" className="ml-2">
                   {activeFilterCount}
                 </Badge>
               </Button>
             )}
           </div>
         </div>

         {/* Log Level Filter */}
         <LogLevelFilter
           selected={filters.levels}
           onChange={(levels) => onFiltersChange({ ...filters, levels })}
         />
       </div>
     )
   }
   ```

4. **Implement ServiceMultiSelect**:
   - Use shadcn/ui Select or Command components
   - Display service list with checkboxes
   - Show selected count

5. **Implement TimeRangePicker**:
   - Use shadcn/ui Popover + Calendar components
   - Quick picks as buttons
   - Custom date/time inputs for advanced users

6. **Implement LogLevelFilter**:
   - Row of toggle buttons or checkboxes
   - Color-coded by severity
   - All selected by default

7. **Implement ExportButton**:
   - Dropdown menu with format options
   - Trigger download on selection

8. **Testing**:
   - Test filter state updates
   - Test URL param synchronization
   - Test debouncing
   - Test responsive layout

## Verification

- [ ] LogFilterControls component created
- [ ] Service multi-select works correctly
- [ ] Time range picker works with quick picks and custom ranges
- [ ] Search input debounces correctly
- [ ] Regex toggle works
- [ ] Log level filter works
- [ ] Export button triggers download
- [ ] Pause/Resume streaming button works
- [ ] Reset filters button clears all filters
- [ ] Active filter count badge displays correctly
- [ ] URL params sync with filter state
- [ ] Component follows existing styling patterns
- [ ] Responsive design works on mobile
- [ ] Tests added and passing

## Files Modified

- **New**: `web/src/components/logs/LogFilterControls.tsx`
- **New**: `web/src/components/logs/ServiceMultiSelect.tsx`
- **New**: `web/src/components/logs/TimeRangePicker.tsx`
- **New**: `web/src/components/logs/LogLevelFilter.tsx`
- **New**: `web/src/components/logs/ExportButton.tsx`
- **New**: `web/src/components/logs/types.ts` (shared types)

## Test Plan

### Component Tests

```tsx
import { render, screen, fireEvent, waitFor } from '@testing-library/react'
import { LogFilterControls } from './LogFilterControls'

describe('LogFilterControls', () => {
  const mockServices = [
    { id: '1', name: 'api' },
    { id: '2', name: 'web' },
  ]

  const mockFilters = {
    services: [],
    from: null,
    to: null,
    search: '',
    regexMode: false,
    levels: ['INFO', 'WARN', 'ERROR', 'DEBUG'],
    autoScroll: true,
    streaming: true,
  }

  it('renders all filter controls', () => {
    render(
      <LogFilterControls
        services={mockServices}
        filters={mockFilters}
        onFiltersChange={() => {}}
        onExport={() => {}}
      />
    )

    expect(screen.getByPlaceholderText('Search logs...')).toBeInTheDocument()
    expect(screen.getByText('Regex')).toBeInTheDocument()
  })

  it('debounces search input', async () => {
    const onFiltersChange = jest.fn()
    render(
      <LogFilterControls
        services={mockServices}
        filters={mockFilters}
        onFiltersChange={onFiltersChange}
        onExport={() => {}}
      />
    )

    const input = screen.getByPlaceholderText('Search logs...')
    fireEvent.change(input, { target: { value: 'error' } })

    // Should not call immediately
    expect(onFiltersChange).not.toHaveBeenCalled()

    // Should call after debounce delay
    await waitFor(() => {
      expect(onFiltersChange).toHaveBeenCalledWith(
        expect.objectContaining({ search: 'error' })
      )
    }, { timeout: 500 })
  })

  it('shows active filter count', () => {
    const filtersWithSearch = { ...mockFilters, search: 'error', services: ['1'] }
    render(
      <LogFilterControls
        services={mockServices}
        filters={filtersWithSearch}
        onFiltersChange={() => {}}
        onExport={() => {}}
      />
    )

    expect(screen.getByText('2')).toBeInTheDocument() // Badge showing 2 active filters
  })

  it('resets filters', () => {
    const onFiltersChange = jest.fn()
    const filtersWithSearch = { ...mockFilters, search: 'error' }
    
    render(
      <LogFilterControls
        services={mockServices}
        filters={filtersWithSearch}
        onFiltersChange={onFiltersChange}
        onExport={() => {}}
      />
    )

    fireEvent.click(screen.getByText('Reset'))
    
    expect(onFiltersChange).toHaveBeenCalledWith(
      expect.objectContaining({ search: '' })
    )
  })
})
```

### Manual Testing Checklist
- [ ] Select/deselect services and verify filter updates
- [ ] Choose time range quick picks
- [ ] Enter custom time range
- [ ] Type search query and verify debouncing
- [ ] Toggle regex mode
- [ ] Select/deselect log levels
- [ ] Click export and verify dropdown
- [ ] Toggle pause/resume streaming
- [ ] Reset filters and verify all cleared
- [ ] Verify URL params update
- [ ] Reload page and verify filters restored from URL
- [ ] Test on mobile viewport

### Success Criteria
- All filter controls work correctly
- Debouncing prevents excessive API calls
- URL params enable filter sharing
- Component is responsive
- Tests pass

